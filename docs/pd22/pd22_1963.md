# 版本 0.16.0（2015 年 3 月 22 日）

> 原文：[`pandas.pydata.org/docs/whatsnew/v0.16.0.html`](https://pandas.pydata.org/docs/whatsnew/v0.16.0.html)

这是从 0.15.2 版本的一个重大发布，包括少量 API 变更，几个新特性，增强功能和性能改进以及大量错误修复。我们建议所有用户升级到此版本。

亮点包括：

+   `DataFrame.assign` 方法，请参阅这里

+   `Series.to_coo/from_coo` 方法用于与 `scipy.sparse` 交互，请参阅这里

+   对 `Timedelta` 的向后不兼容更改，使 `.seconds` 属性符合 `datetime.timedelta`，请参阅这里

+   对 `.loc` 切片 API 的更改以符合 `.ix` 的行为，请参阅这里

+   `Categorical` 构造函数中排序的默认更改，请参阅这里

+   对 `.str` 访问器的增强，使字符串操作更加方便，请参阅这里

+   `pandas.tools.rplot`，`pandas.sandbox.qtpandas` 和 `pandas.rpy` 模块已弃用。我们建议用户使用外部包，如 [seaborn](http://stanford.edu/~mwaskom/software/seaborn/)，[pandas-qt](https://github.com/datalyze-solutions/pandas-qt) 和 [rpy2](http://rpy2.bitbucket.org/) 来获得类似或等效的功能，请参阅这里

在更新之前，请查看 API 变更 和 弃用内容。

v0.16.0 中的新内容

+   新特性

    +   DataFrame 分配

    +   与 scipy.sparse 的交互

    +   字符串方法增强

    +   其他增强

+   向后不兼容的 API 变更

    +   时间增量的变更

    +   索引变更

    +   分类变更

    +   其他 API 变更

    +   弃用内容

    +   删除之前版本的弃用/更改内容

+   性能改进

+   错误修复

+   贡献者

## 新特性

### DataFrame 分配

受 [dplyr](https://dplyr.tidyverse.org/articles/dplyr.html#mutating-operations) 的 `mutate` 动词启发，DataFrame 新增了一个 `assign()` 方法。`assign` 的函数签名简单地是 `**kwargs`。键是新字段的列名，值可以是要插入的值（例如，一个 `Series` 或 NumPy 数组），或者是要在 `DataFrame` 上调用的带一个参数的函数。新值被插入，整个 DataFrame（包括所有原始列和新列）被返回。

```py
In [1]: iris = pd.read_csv('data/iris.data')

In [2]: iris.head()
Out[2]: 
 SepalLength  SepalWidth  PetalLength  PetalWidth         Name
0          5.1         3.5          1.4         0.2  Iris-setosa
1          4.9         3.0          1.4         0.2  Iris-setosa
2          4.7         3.2          1.3         0.2  Iris-setosa
3          4.6         3.1          1.5         0.2  Iris-setosa
4          5.0         3.6          1.4         0.2  Iris-setosa

[5 rows x 5 columns]

In [3]: iris.assign(sepal_ratio=iris['SepalWidth'] / iris['SepalLength']).head()
Out[3]: 
 SepalLength  SepalWidth  PetalLength  PetalWidth         Name  sepal_ratio
0          5.1         3.5          1.4         0.2  Iris-setosa     0.686275
1          4.9         3.0          1.4         0.2  Iris-setosa     0.612245
2          4.7         3.2          1.3         0.2  Iris-setosa     0.680851
3          4.6         3.1          1.5         0.2  Iris-setosa     0.673913
4          5.0         3.6          1.4         0.2  Iris-setosa     0.720000

[5 rows x 6 columns] 
```

上面是插入预计算值的一个示例。我们还可以传入一个要评估的函数。

```py
In [4]: iris.assign(sepal_ratio=lambda x: (x['SepalWidth']
 ...:                                   / x['SepalLength'])).head()
 ...: 
Out[4]: 
 SepalLength  SepalWidth  PetalLength  PetalWidth         Name  sepal_ratio
0          5.1         3.5          1.4         0.2  Iris-setosa     0.686275
1          4.9         3.0          1.4         0.2  Iris-setosa     0.612245
2          4.7         3.2          1.3         0.2  Iris-setosa     0.680851
3          4.6         3.1          1.5         0.2  Iris-setosa     0.673913
4          5.0         3.6          1.4         0.2  Iris-setosa     0.720000

[5 rows x 6 columns] 
```

`assign` 方法的强大之处在于它在操作链中的使用。例如，我们可以将 DataFrame 限制为仅包含萼片长度大于 5 的部分，计算比率并绘制图表。

```py
In [5]: iris = pd.read_csv('data/iris.data')

In [6]: (iris.query('SepalLength > 5')
 ...:     .assign(SepalRatio=lambda x: x.SepalWidth / x.SepalLength,
 ...:             PetalRatio=lambda x: x.PetalWidth / x.PetalLength)
 ...:     .plot(kind='scatter', x='SepalRatio', y='PetalRatio'))
 ...: 
Out[6]: <Axes: xlabel='SepalRatio', ylabel='PetalRatio'> 
```

![../_images/whatsnew_assign.png](img/whatsnew_assign.png)

更多信息请参见文档（[GH 9229](https://github.com/pandas-dev/pandas/issues/9229)）  ### 与 scipy.sparse 的交互

添加了 `SparseSeries.to_coo()` 和 `SparseSeries.from_coo()` 方法 ([GH 8048](https://github.com/pandas-dev/pandas/issues/8048)) 以便将其转换为和从 `scipy.sparse.coo_matrix` 实例（参见 此处）。例如，给定具有多索引的 SparseSeries，我们可以通过指定行和列标签作为索引级别将其转换为 `scipy.sparse.coo_matrix`：

```py
s = pd.Series([3.0, np.nan, 1.0, 3.0, np.nan, np.nan])
s.index = pd.MultiIndex.from_tuples([(1, 2, 'a', 0),
                                     (1, 2, 'a', 1),
                                     (1, 1, 'b', 0),
                                     (1, 1, 'b', 1),
                                     (2, 1, 'b', 0),
                                     (2, 1, 'b', 1)],
                                    names=['A', 'B', 'C', 'D'])

s

# SparseSeries
ss = s.to_sparse()
ss

A, rows, columns = ss.to_coo(row_levels=['A', 'B'],
                             column_levels=['C', 'D'],
                             sort_labels=False)

A
A.todense()
rows
columns 
```

from_coo 方法是从 `scipy.sparse.coo_matrix` 创建 `SparseSeries` 的方便方法：

```py
from scipy import sparse
A = sparse.coo_matrix(([3.0, 1.0, 2.0], ([1, 0, 0], [0, 2, 3])),
                      shape=(3, 4))
A
A.todense()

ss = pd.SparseSeries.from_coo(A)
ss 
```  ### 字符串方法增强

+   下列新方法可通过 `.str` 访问器来应用于每个值。这旨在使其与字符串上的标准方法更一致。 ([GH 9282](https://github.com/pandas-dev/pandas/issues/9282), [GH 9352](https://github.com/pandas-dev/pandas/issues/9352), [GH 9386](https://github.com/pandas-dev/pandas/issues/9386), [GH 9387](https://github.com/pandas-dev/pandas/issues/9387), [GH 9439](https://github.com/pandas-dev/pandas/issues/9439))

    |  |  | 方法 |  |  |
    | --- | --- | --- | --- | --- |
    | `isalnum()` | `isalpha()` | `isdigit()` | `isdigit()` | `isspace()` |
    | `islower()` | `isupper()` | `istitle()` | `isnumeric()` | `isdecimal()` |
    | `find()` | `rfind()` | `ljust()` | `rjust()` | `zfill()` |

    ```py
    In [7]: s = pd.Series(['abcd', '3456', 'EFGH'])

    In [8]: s.str.isalpha()
    Out[8]: 
    0     True
    1    False
    2     True
    Length: 3, dtype: bool

    In [9]: s.str.find('ab')
    Out[9]: 
    0    0
    1   -1
    2   -1
    Length: 3, dtype: int64 
    ```

+   `Series.str.pad()` 和 `Series.str.center()` 现在接受 `fillchar` 选项来指定填充字符 ([GH 9352](https://github.com/pandas-dev/pandas/issues/9352))

    ```py
    In [10]: s = pd.Series(['12', '300', '25'])

    In [11]: s.str.pad(5, fillchar='_')
    Out[11]: 
    0    ___12
    1    __300
    2    ___25
    Length: 3, dtype: object 
    ```

+   添加了 `Series.str.slice_replace()`，它以前引发了 `NotImplementedError` ([GH 8888](https://github.com/pandas-dev/pandas/issues/8888))

    ```py
    In [12]: s = pd.Series(['ABCD', 'EFGH', 'IJK'])

    In [13]: s.str.slice_replace(1, 3, 'X')
    Out[13]: 
    0    AXD
    1    EXH
    2     IX
    Length: 3, dtype: object

    # replaced with empty char
    In [14]: s.str.slice_replace(0, 1)
    Out[14]: 
    0    BCD
    1    FGH
    2     JK
    Length: 3, dtype: object 
    ```  ### 其他增强

+   现在 reindex 支持 `method='nearest'`，用于具有单调递增或递减索引的帧或系列（[GH 9258](https://github.com/pandas-dev/pandas/issues/9258)）:

    ```py
    In [15]: df = pd.DataFrame({'x': range(5)})

    In [16]: df.reindex([0.2, 1.8, 3.5], method='nearest')
    Out[16]: 
     x
    0.2  0
    1.8  2
    3.5  4

    [3 rows x 1 columns] 
    ```

    这种方法也可以通过更低级别的 `Index.get_indexer` 和 `Index.get_loc` 方法暴露出来。

+   `read_excel()` 函数的 sheetname 参数现在接受一个列表和 `None`，以分别获取多个或所有工作表。如果指定了多个工作表，则返回一个字典。（[GH 9450](https://github.com/pandas-dev/pandas/issues/9450)）

    ```py
    # Returns the 1st and 4th sheet, as a dictionary of DataFrames.
    pd.read_excel('path_to_file.xls', sheetname=['Sheet1', 3]) 
    ```

+   允许使用迭代器逐步读取 Stata 文件；支持 Stata 文件中的长字符串。请参阅此处文档。（[GH 9493](https://github.com/pandas-dev/pandas/issues/9493)）

+   以 ~ 开头的路径现在将扩展为以用户的主目录开头。（[GH 9066](https://github.com/pandas-dev/pandas/issues/9066)）

+   在 `get_data_yahoo` 中添加了时间间隔选择。（[GH 9071](https://github.com/pandas-dev/pandas/issues/9071)）

+   添加了 `Timestamp.to_datetime64()` 来补充 `Timedelta.to_timedelta64()`。（[GH 9255](https://github.com/pandas-dev/pandas/issues/9255)）

+   `tseries.frequencies.to_offset()` 现在接受 `Timedelta` 作为输入。（[GH 9064](https://github.com/pandas-dev/pandas/issues/9064)）

+   在 `Series` 的自相关方法中添加了滞后参数，默认为滞后 1 自相关。（[GH 9192](https://github.com/pandas-dev/pandas/issues/9192)）

+   `Timedelta` 现在在构造函数中接受 `nanoseconds` 关键字。（[GH 9273](https://github.com/pandas-dev/pandas/issues/9273)）

+   SQL 代码现在安全地转义表名和列名。（[GH 8986](https://github.com/pandas-dev/pandas/issues/8986)）

+   为 `Series.str.<tab>`、`Series.dt.<tab>` 和 `Series.cat.<tab>` 添加了自动完成功能。（[GH 9322](https://github.com/pandas-dev/pandas/issues/9322)）

+   `Index.get_indexer` 现在支持 `method='pad'` 和 `method='backfill'`，即使对于任何目标数组，而不仅仅是单调的目标。这些方法也适用于单调减少以及单调增加的索引。（[GH 9258](https://github.com/pandas-dev/pandas/issues/9258)）

+   `Index.asof` 现在适用于所有索引类型。（[GH 9258](https://github.com/pandas-dev/pandas/issues/9258)）

+   在 `io.read_excel()` 中增加了一个 `verbose` 参数，默认为 False。设置为 True 以在解析时打印工作表名称。（[GH 9450](https://github.com/pandas-dev/pandas/issues/9450)）

+   为 `Timestamp`、`DatetimeIndex`、`Period`、`PeriodIndex` 和 `Series.dt` 添加了 `days_in_month`（兼容别名 `daysinmonth`）属性。（[GH 9572](https://github.com/pandas-dev/pandas/issues/9572)）

+   在 `to_csv` 中添加了 `decimal` 选项，以提供非 '。' 小数分隔符的格式化。（[GH 781](https://github.com/pandas-dev/pandas/issues/781)）

+   为 `Timestamp` 添加了 `normalize` 选项，以将其规范化为午夜。（[GH 8794](https://github.com/pandas-dev/pandas/issues/8794)）

+   添加了使用 HDF5 文件和 `rhdf5` 库导入 `DataFrame` 的示例。有关更多信息，请参阅文档。（[GH 9636](https://github.com/pandas-dev/pandas/issues/9636)）## 不兼容的 API 更改

### timedelta 的变化

在 v0.15.0 中，引入了一个新的标量类型`Timedelta`，它是`datetime.timedelta`的子类。在 v0.15.0.html#whatsnew-0150-timedeltaindex 中提到了一个关于`.seconds`访问器的 API 更改的通知。旨在提供一组用户友好的访问器，以给出该单位的‘自然’值，例如如果你有一个`Timedelta('1 day, 10:11:12')`，那么`.seconds`将返回 12。然而，这与`datetime.timedelta`的定义相矛盾，后者将`.seconds`定义为`10 * 3600 + 11 * 60 + 12 == 36672`。

因此，在 v0.16.0 中，我们恢复了 API，以匹配`datetime.timedelta`的 API。此外，组件值仍可通过`.components`访问器获得。这影响了`.seconds`和`.microseconds`访问器，并删除了`.hours`、`.minutes`和`.milliseconds`访问器。这些更改也影响了`TimedeltaIndex`和 Series 的`.dt`访问器。([GH 9185](https://github.com/pandas-dev/pandas/issues/9185), [GH 9139](https://github.com/pandas-dev/pandas/issues/9139))

旧行为

```py
In [2]: t = pd.Timedelta('1 day, 10:11:12.100123')

In [3]: t.days
Out[3]: 1

In [4]: t.seconds
Out[4]: 12

In [5]: t.microseconds
Out[5]: 123 
```

新行为

```py
In [17]: t = pd.Timedelta('1 day, 10:11:12.100123')

In [18]: t.days
Out[18]: 1

In [19]: t.seconds
Out[19]: 36672

In [20]: t.microseconds
Out[20]: 100123 
```

使用`.components`允许完全组件访问

```py
In [21]: t.components
Out[21]: Components(days=1, hours=10, minutes=11, seconds=12, milliseconds=100, microseconds=123, nanoseconds=0)

In [22]: t.components.seconds
Out[22]: 12 
```  ### 索引变更

使用`.loc`的一小部分边缘案例的行为已更改([GH 8613](https://github.com/pandas-dev/pandas/issues/8613))。此外，我们已改进了引发的错误消息的内容：

+   现在允许在索引中找不到开始和/或停止边界的情况下使用`.loc`进行切片；以前会引发`KeyError`。这使得在这种情况下行为与`.ix`相同。此更改仅适用于切片，而不是在单个标签上进行索引。

    ```py
    In [23]: df = pd.DataFrame(np.random.randn(5, 4),
     ....:                  columns=list('ABCD'),
     ....:                  index=pd.date_range('20130101', periods=5))
     ....: 

    In [24]: df
    Out[24]: 
     A         B         C         D
    2013-01-01  0.469112 -0.282863 -1.509059 -1.135632
    2013-01-02  1.212112 -0.173215  0.119209 -1.044236
    2013-01-03 -0.861849 -2.104569 -0.494929  1.071804
    2013-01-04  0.721555 -0.706771 -1.039575  0.271860
    2013-01-05 -0.424972  0.567020  0.276232 -1.087401

    [5 rows x 4 columns]

    In [25]: s = pd.Series(range(5), [-2, -1, 1, 2, 3])

    In [26]: s
    Out[26]: 
    -2    0
    -1    1
     1    2
     2    3
     3    4
    Length: 5, dtype: int64 
    ```

    旧行为

    ```py
    In [4]: df.loc['2013-01-02':'2013-01-10']
    KeyError: 'stop bound [2013-01-10] is not in the [index]'

    In [6]: s.loc[-10:3]
    KeyError: 'start bound [-10] is not the [index]' 
    ```

    新行为

    ```py
    In [27]: df.loc['2013-01-02':'2013-01-10']
    Out[27]: 
     A         B         C         D
    2013-01-02  1.212112 -0.173215  0.119209 -1.044236
    2013-01-03 -0.861849 -2.104569 -0.494929  1.071804
    2013-01-04  0.721555 -0.706771 -1.039575  0.271860
    2013-01-05 -0.424972  0.567020  0.276232 -1.087401

    [4 rows x 4 columns]

    In [28]: s.loc[-10:3]
    Out[28]: 
    -2    0
    -1    1
     1    2
     2    3
     3    4
    Length: 5, dtype: int64 
    ```

+   对于`.ix`，现在允许在整数索引上使用类似浮点数的值进行切片。以前只有`.loc`才能这样做：

    旧行为

    ```py
    In [8]: s.ix[-1.0:2]
    TypeError: the slice start value [-1.0] is not a proper indexer for this index type (Int64Index) 
    ```

    新行为

    ```py
    In [2]: s.ix[-1.0:2]
    Out[2]:
    -1    1
     1    2
     2    3
    dtype: int64 
    ```

+   当使用`.loc`进行索引时，对于索引类型为`DatetimeIndex`、`PeriodIndex`或`TimedeltaIndex`的情况，如果使用了整数（或浮点数）索引，则会提供一个有用的异常。 

    旧行为

    ```py
    In [4]: df.loc[2:3]
    KeyError: 'start bound [2] is not the [index]' 
    ```

    新行为

    ```py
    In [4]: df.loc[2:3]
    TypeError: Cannot do slice indexing on <class 'pandas.tseries.index.DatetimeIndex'> with <type 'int'> keys 
    ```  ### 分类变更

在先前的版本中，未指定排序（即未传递`ordered`关键字）的`Categoricals`默认为`ordered` Categoricals。从现在开始，`Categorical`构造函数中的`ordered`关键字将默认为`False`。现在必须明确指定排序。

此外，以前你可以通过设置属性来更改分类变量的`ordered`属性，例如`cat.ordered=True`；现在这已被弃用，你应该使用`cat.as_ordered()`或`cat.as_unordered()`。这些默认会返回一个**新的**对象，而不会修改现有对象。([GH 9347](https://github.com/pandas-dev/pandas/issues/9347), [GH 9190](https://github.com/pandas-dev/pandas/issues/9190))

旧行为

```py
In [3]: s = pd.Series([0, 1, 2], dtype='category')

In [4]: s
Out[4]:
0    0
1    1
2    2
dtype: category
Categories (3, int64): [0 < 1 < 2]

In [5]: s.cat.ordered
Out[5]: True

In [6]: s.cat.ordered = False

In [7]: s
Out[7]:
0    0
1    1
2    2
dtype: category
Categories (3, int64): [0, 1, 2] 
```

新行为

```py
In [29]: s = pd.Series([0, 1, 2], dtype='category')

In [30]: s
Out[30]: 
0    0
1    1
2    2
Length: 3, dtype: category
Categories (3, int64): [0, 1, 2]

In [31]: s.cat.ordered
Out[31]: False

In [32]: s = s.cat.as_ordered()

In [33]: s
Out[33]: 
0    0
1    1
2    2
Length: 3, dtype: category
Categories (3, int64): [0 < 1 < 2]

In [34]: s.cat.ordered
Out[34]: True

# you can set in the constructor of the Categorical
In [35]: s = pd.Series(pd.Categorical([0, 1, 2], ordered=True))

In [36]: s
Out[36]: 
0    0
1    1
2    2
Length: 3, dtype: category
Categories (3, int64): [0 < 1 < 2]

In [37]: s.cat.ordered
Out[37]: True 
```

为了更容易创建分类数据系列，我们添加了在调用`.astype()`时传递关键字的功能。这些关键字直接传递给构造函数。

```py
In [54]: s = pd.Series(["a", "b", "c", "a"]).astype('category', ordered=True)

In [55]: s
Out[55]:
0    a
1    b
2    c
3    a
dtype: category
Categories (3, object): [a < b < c]

In [56]: s = (pd.Series(["a", "b", "c", "a"])
   ....:        .astype('category', categories=list('abcdef'), ordered=False))

In [57]: s
Out[57]:
0    a
1    b
2    c
3    a
dtype: category
Categories (6, object): [a, b, c, d, e, f] 
```  ### 其他 API 更改

+   `Index.duplicated`现在返回`np.array(dtype=bool)`而不是包含`bool`值的`Index(dtype=object)`。([GH 8875](https://github.com/pandas-dev/pandas/issues/8875))

+   `DataFrame.to_json`现在为混合数据类型的每列返回准确的类型序列化([GH 9037](https://github.com/pandas-dev/pandas/issues/9037))

    以前，在序列化之前，数据被强制转换为一个公共数据类型，例如整数被序列化为浮点数：

    ```py
    In [2]: pd.DataFrame({'i': [1,2], 'f': [3.0, 4.2]}).to_json()
    Out[2]: '{"f":{"0":3.0,"1":4.2},"i":{"0":1.0,"1":2.0}}' 
    ```

    现在每列都使用其正确的数据类型进行序列化：

    ```py
    In [2]:  pd.DataFrame({'i': [1,2], 'f': [3.0, 4.2]}).to_json()
    Out[2]: '{"f":{"0":3.0,"1":4.2},"i":{"0":1,"1":2}}' 
    ```

+   `DatetimeIndex`、`PeriodIndex`和`TimedeltaIndex.summary`现在输出相同的格式。([GH 9116](https://github.com/pandas-dev/pandas/issues/9116))

+   `TimedeltaIndex.freqstr`现在输出与`DatetimeIndex`相同的字符串格式。([GH 9116](https://github.com/pandas-dev/pandas/issues/9116))

+   条形图和水平条形图不再沿着信息轴添加虚线。以前的样式可以通过 matplotlib 的`axhline`或`axvline`方法实现([GH 9088](https://github.com/pandas-dev/pandas/issues/9088))。

+   如果`Series`访问器`.dt`、`.cat`和`.str`不包含适当类型的数据，则现在会引发`AttributeError`而不是`TypeError`([GH 9617](https://github.com/pandas-dev/pandas/issues/9617))。这更贴近 Python 内置的异常层次结构，并确保像`hasattr(s, 'cat')`这样的测试在 Python 2 和 3 上保持一致。

+   `Series`现在支持整数类型的按位操作([GH 9016](https://github.com/pandas-dev/pandas/issues/9016))。以前，即使输入的数据类型是整数，输出的数据类型也会被强制转换为`bool`。

    以前的行为

    ```py
    In [2]: pd.Series([0, 1, 2, 3], list('abcd')) | pd.Series([4, 4, 4, 4], list('abcd'))
    Out[2]:
    a    True
    b    True
    c    True
    d    True
    dtype: bool 
    ```

    新行为。如果输入的数据类型是整数，则输出的数据类型也是整数，输出值是按位操作的结果。

    ```py
    In [2]: pd.Series([0, 1, 2, 3], list('abcd')) | pd.Series([4, 4, 4, 4], list('abcd'))
    Out[2]:
    a    4
    b    5
    c    6
    d    7
    dtype: int64 
    ```

+   在涉及`Series`或`DataFrame`的除法中，`0/0`和`0//0`现在会给出`np.nan`而不是`np.inf`。([GH 9144](https://github.com/pandas-dev/pandas/issues/9144), [GH 8445](https://github.com/pandas-dev/pandas/issues/8445))

    以前的行为

    ```py
    In [2]: p = pd.Series([0, 1])

    In [3]: p / 0
    Out[3]:
    0    inf
    1    inf
    dtype: float64

    In [4]: p // 0
    Out[4]:
    0    inf
    1    inf
    dtype: float64 
    ```

    新行为

    ```py
    In [38]: p = pd.Series([0, 1])

    In [39]: p / 0
    Out[39]: 
    0    NaN
    1    inf
    Length: 2, dtype: float64

    In [40]: p // 0
    Out[40]: 
    0    NaN
    1    inf
    Length: 2, dtype: float64 
    ```

+   对于分类数据，`Series.values_counts`和`Series.describe`现在将`NaN`条目放在最后。([GH 9443](https://github.com/pandas-dev/pandas/issues/9443))

+   对于分类数据，`Series.describe`现在将未使用的类别的计数和频率显示为 0，而不是`NaN`。([GH 9443](https://github.com/pandas-dev/pandas/issues/9443))

+   由于一个错误修复，使用`DatetimeIndex.asof`查找部分字符串标签现在包括与字符串匹配的值，即使它���在部分字符串标签的开始之后([GH 9258](https://github.com/pandas-dev/pandas/issues/9258))。

    旧行为：

    ```py
    In [4]: pd.to_datetime(['2000-01-31', '2000-02-28']).asof('2000-02')
    Out[4]: Timestamp('2000-01-31 00:00:00') 
    ```

    修正的行为：

    ```py
    In [41]: pd.to_datetime(['2000-01-31', '2000-02-28']).asof('2000-02')
    Out[41]: Timestamp('2000-02-28 00:00:00') 
    ```

    要复制旧行为，只需为标签添加更多精度(例如，使用`2000-02-01`而不是`2000-02`)。  ### 弃用

+   `rplot` trellis 绘图接口已被弃用，并将在将来的版本中移除。我们建议使用外部包如[seaborn](http://stanford.edu/~mwaskom/software/seaborn/)来获得类似但更精细的功能（[GH 3445](https://github.com/pandas-dev/pandas/issues/3445)）。文档中包含一些示例，说明如何将现有代码从`rplot`转换为 seaborn [here](https://pandas.pydata.org/pandas-docs/version/0.18.1/visualization.html#trellis-plotting-interface)。

+   `pandas.sandbox.qtpandas`接口已被弃用，并将在将来的版本中移除。我们建议用户使用外部包[pandas-qt](https://github.com/datalyze-solutions/pandas-qt)（[GH 9615](https://github.com/pandas-dev/pandas/issues/9615))

+   `pandas.rpy`接口已被弃用，并将在将来的版本中移除。类似功能可以通过[rpy2](http://rpy2.bitbucket.org/)项目访问（[GH 9602](https://github.com/pandas-dev/pandas/issues/9602)）

+   将`DatetimeIndex/PeriodIndex`添加到另一个`DatetimeIndex/PeriodIndex`被弃用为集合操作。这将在将来的版本中更改为`TypeError`。应该使用`.union()`进行并集操作（[GH 9094](https://github.com/pandas-dev/pandas/issues/9094)）

+   从另一个`DatetimeIndex/PeriodIndex`中减去`DatetimeIndex/PeriodIndex`被弃用为集合操作。这将在将来的版本中更改为实际的数值减法，产生一个`TimeDeltaIndex`。应该使用`.difference()`进行差分集合操作（[GH 9094](https://github.com/pandas-dev/pandas/issues/9094)）### 移除之前版本的弃用/更改

+   `DataFrame.pivot_table`和`crosstab`的`rows`和`cols`关键字参数已被移除，改为使用`index`和`columns`（[GH 6581](https://github.com/pandas-dev/pandas/issues/6581)）

+   `DataFrame.to_excel`和`DataFrame.to_csv`的`cols`关键字参数已被移除，改为使用`columns`（[GH 6581](https://github.com/pandas-dev/pandas/issues/6581)）

+   移除了`convert_dummies`，改用`get_dummies`（[GH 6581](https://github.com/pandas-dev/pandas/issues/6581)）

+   移除了`value_range`，改用`describe`（[GH 6581](https://github.com/pandas-dev/pandas/issues/6581)）## 性能改进

+   修复了使用数组或类似列表进行`.loc`索引的性能回归（[GH 9126](https://github.com/pandas-dev/pandas/issues/9126)）

+   `DataFrame.to_json`混合 dtype 框架的性能提升 30 倍（[GH 9037](https://github.com/pandas-dev/pandas/issues/9037)）

+   通过使用标签而不是值，提高了`MultiIndex.duplicated`的性能（[GH 9125](https://github.com/pandas-dev/pandas/issues/9125)）

+   通过调用`unique`而不是`value_counts`来提高`nunique`的速度（[GH 9129](https://github.com/pandas-dev/pandas/issues/9129)，[GH 7771](https://github.com/pandas-dev/pandas/issues/7771)）

+   通过适当利用同质/异质 dtypes，`DataFrame.count`和`DataFrame.dropna`的性能提高了最多 10 倍（[GH 9136](https://github.com/pandas-dev/pandas/issues/9136)）

+   在使用`MultiIndex`和`level`关键字参数时，`DataFrame.count`的性能提高了最多 20 倍（[GH 9163](https://github.com/pandas-dev/pandas/issues/9163)）

+   当键空间超过`int64`边界时，在`merge`中的性能和内存使用改进（[GH 9151](https://github.com/pandas-dev/pandas/issues/9151)）

+   多键`groupby`中的性能改进（[GH 9429](https://github.com/pandas-dev/pandas/issues/9429)）

+   `MultiIndex.sortlevel`中的性能改进（[GH 9445](https://github.com/pandas-dev/pandas/issues/9445)）

+   在`DataFrame.duplicated`中的性能和内存使用改进（[GH 9398](https://github.com/pandas-dev/pandas/issues/9398)）

+   Cython 化了`Period`（[GH 9440](https://github.com/pandas-dev/pandas/issues/9440)）

+   在`to_hdf`中减少了内存使用量（[GH 9648](https://github.com/pandas-dev/pandas/issues/9648)）## Bug 修复

+   更改了`.to_html`以删除表体中的前导/尾随空格（[GH 4987](https://github.com/pandas-dev/pandas/issues/4987)）

+   在 Python 3 上使用`read_csv`在 s3 上存在问题（[GH 9452](https://github.com/pandas-dev/pandas/issues/9452)）

+   修复了`DatetimeIndex`中的兼容性问题，影响了`numpy.int_`默认为`numpy.int32`的架构（[GH 8943](https://github.com/pandas-dev/pandas/issues/8943)）

+   在具有对象类似特性的 Panel 索引中存在错误（[GH 9140](https://github.com/pandas-dev/pandas/issues/9140)）

+   返回的`Series.dt.components`索引中的错误已重置为默认索引（[GH 9247](https://github.com/pandas-dev/pandas/issues/9247)）

+   使用列表输入时，在`Categorical.__getitem__/__setitem__`中出现错误，从索引器强制转换中获得不正确的结果（[GH 9469](https://github.com/pandas-dev/pandas/issues/9469)）

+   在具有 DatetimeIndex 的部分设置中存在错误（[GH 9478](https://github.com/pandas-dev/pandas/issues/9478)）

+   在应用导致值在数字足够大时发生更改的聚合器时，对整数和 datetime64 列进行 groupby 时存在错误（[GH 9311](https://github.com/pandas-dev/pandas/issues/9311)，[GH 6620](https://github.com/pandas-dev/pandas/issues/6620)）

+   在将`Timestamp`对象列（带有时区信息的 datetime 列）映射到适当的 sqlalchemy 类型时，修复了`to_sql`中的错误（[GH 9085](https://github.com/pandas-dev/pandas/issues/9085)）。

+   修复了`to_sql`中`dtype`参数不接受实例化的 SQLAlchemy 类型的错误（[GH 9083](https://github.com/pandas-dev/pandas/issues/9083)）。

+   在使用`np.datetime64`进行`.loc`部分设置时存在错误（[GH 9516](https://github.com/pandas-dev/pandas/issues/9516)）

+   在看起来是`Series`和`.xs`切片上推断的不正确的 dtypes（[GH 9477](https://github.com/pandas-dev/pandas/issues/9477)）

+   现在`Categorical.unique()`中的项目（如果`s`的 dtype 为`category`，则为`s.unique()`）现在按照最初找到它们的顺序出现，而不是按排序顺序（[GH 9331](https://github.com/pandas-dev/pandas/issues/9331)）。这现在与 pandas 中其他 dtype 的行为一致。

+   修复了在大端平台上产生`StataReader`中不正确结果的错误（[GH 8688](https://github.com/pandas-dev/pandas/issues/8688)）。

+   修复了`MultiIndex.has_duplicates`中当有许多级别时导致索引器溢出的错误（[GH 9075](https://github.com/pandas-dev/pandas/issues/9075)，[GH 5873](https://github.com/pandas-dev/pandas/issues/5873)）。

+   修复了`pivot`和`unstack`中`nan`值会破坏索引对齐的错误（[GH 4862](https://github.com/pandas-dev/pandas/issues/4862)，[GH 7401](https://github.com/pandas-dev/pandas/issues/7401)，[GH 7403](https://github.com/pandas-dev/pandas/issues/7403)，[GH 7405](https://github.com/pandas-dev/pandas/issues/7405)，[GH 7466](https://github.com/pandas-dev/pandas/issues/7466)，[GH 9497](https://github.com/pandas-dev/pandas/issues/9497)）。

+   修复了在具有`sort=True`或空值的 MultiIndex 上进行左连接时的错误（[GH 9210](https://github.com/pandas-dev/pandas/issues/9210)）。

+   修复了在插入新键时`MultiIndex`会失败的错误（[GH 9250](https://github.com/pandas-dev/pandas/issues/9250)）。

+   修复了`groupby`中键空间超过`int64`边界时的错误（[GH 9096](https://github.com/pandas-dev/pandas/issues/9096)）。

+   修复了在`TimedeltaIndex`或`DatetimeIndex`和空值上使用`unstack`的错误（[GH 9491](https://github.com/pandas-dev/pandas/issues/9491)）。

+   修复了`rank`中使用容差比较浮点数会导致不一致行为的错误（[GH 8365](https://github.com/pandas-dev/pandas/issues/8365)）。

+   修复了从 URL 加载数据时`read_stata`和`StataReader`中的字符编码错误（[GH 9231](https://github.com/pandas-dev/pandas/issues/9231)）。

+   添加`offsets.Nano`到其他偏移时引发`TypeError`的错误已修复（[GH 9284](https://github.com/pandas-dev/pandas/issues/9284)）。

+   修复了`DatetimeIndex`迭代中的错误，相关的（[GH 8890](https://github.com/pandas-dev/pandas/issues/8890)），在（[GH 9100](https://github.com/pandas-dev/pandas/issues/9100)）中修复。

+   修复了`resample`在夏令时转换周围的错误。这需要修复偏移类，以便它们在夏令时转换时表现正确（[GH 5172](https://github.com/pandas-dev/pandas/issues/5172)，[GH 8744](https://github.com/pandas-dev/pandas/issues/8744)，[GH 8653](https://github.com/pandas-dev/pandas/issues/8653)，[GH 9173](https://github.com/pandas-dev/pandas/issues/9173)，[GH 9468](https://github.com/pandas-dev/pandas/issues/9468)）。

+   修复了二进制运算符方法（例如`.mul()`）与整数级别对齐的错误（[GH 9463](https://github.com/pandas-dev/pandas/issues/9463)）。

+   修复了 boxplot、scatter 和 hexbin plot 可能显示不必要警告的错误（[GH 8877](https://github.com/pandas-dev/pandas/issues/8877)）。

+   在具有`layout`关键字的 subplot 中存在的错误可能会显示不必要的警告（[GH 9464](https://github.com/pandas-dev/pandas/issues/9464)）

+   在使用需要传递参数（例如轴）的分组器函数时出现的错误，当使用包装函数（例如`fillna`）时，（[GH 9221](https://github.com/pandas-dev/pandas/issues/9221)）

+   `DataFrame`现在在构造函数中正确支持同时`copy`和`dtype`参数（[GH 9099](https://github.com/pandas-dev/pandas/issues/9099)）

+   当使用 c 引擎读取带有 CR 换行的文件时，在`read_csv`中使用 skiprows 时出现的错误（[GH 9079](https://github.com/pandas-dev/pandas/issues/9079)）

+   `isnull`现在在`PeriodIndex`中检测到`NaT`（[GH 9129](https://github.com/pandas-dev/pandas/issues/9129)）

+   在多列 groupby 中存在的`nth()`错误（[GH 8979](https://github.com/pandas-dev/pandas/issues/8979)）

+   在`DataFrame.where`和`Series.where`中存在的错误，错误地将数值转换为字符串（[GH 9280](https://github.com/pandas-dev/pandas/issues/9280)）

+   在`DataFrame.where`和`Series.where`中存在的错误，当传递字符串列表时引发`ValueError`（[GH 9280](https://github.com/pandas-dev/pandas/issues/9280)）

+   现在，在非字符串值上使用`Series.str`方法将引发`TypeError`而不是产生错误的结果（[GH 9184](https://github.com/pandas-dev/pandas/issues/9184)）

+   当索引具有重复项且不是单调递增时，在`DatetimeIndex.__contains__`中出现的错误（[GH 9512](https://github.com/pandas-dev/pandas/issues/9512)）

+   修复了`Series.kurt()`在所有值相等时出现的除零错误（[GH 9197](https://github.com/pandas-dev/pandas/issues/9197)）

+   修复了`xlsxwriter`引擎中的问题，在没有应用其他格式时，将默认的“General”格式添加到单元格中。这会阻止应用其他行或列格式。 （[GH 9167](https://github.com/pandas-dev/pandas/issues/9167)）

+   在`read_csv`中指定`index_col=False`时存在的问题，当也指定了`usecols`时（[GH 9082](https://github.com/pandas-dev/pandas/issues/9082)）

+   在`wide_to_long`中存在的错误会修改输入的存根名称列表（[GH 9204](https://github.com/pandas-dev/pandas/issues/9204)）

+   在`to_sql`中存在的问题，不以双精度存储 float64 值。 （[GH 9009](https://github.com/pandas-dev/pandas/issues/9009)）

+   `SparseSeries`和`SparsePanel`现在接受零参数构造函数（与它们的非稀疏对应物相同）（[GH 9272](https://github.com/pandas-dev/pandas/issues/9272)）。

+   合并`Categorical`和`object` dtype 时出现的回归错误（[GH 9426](https://github.com/pandas-dev/pandas/issues/9426)）

+   在使用特定格式不正确的输入文件时，`read_csv`中存在缓冲区溢出的错误（[GH 9205](https://github.com/pandas-dev/pandas/issues/9205)）

+   在带有缺失对的 groupby MultiIndex 中存在的错误（[GH 9049](https://github.com/pandas-dev/pandas/issues/9049)，[GH 9344](https://github.com/pandas-dev/pandas/issues/9344)）

+   修复了`Series.groupby`中的一个 bug，即在`MultiIndex`级别进行分组会忽略`sort`参数（[GH 9444](https://github.com/pandas-dev/pandas/issues/9444)）

+   修复了一个 bug，在 Categorical 列的情况下，`DataFrame.Groupby`中的`sort=False`被忽略。 （[GH 8868](https://github.com/pandas-dev/pandas/issues/8868)）

+   修复了一个 bug，即在 Python 3 上从 Amazon S3 读取 CSV 文件会引发 TypeError（[GH 9452](https://github.com/pandas-dev/pandas/issues/9452)）

+   在 Google BigQuery 读取器中的一个 bug，在查询结果中可能存在‘jobComplete’键，但其值为 False（[GH 8728](https://github.com/pandas-dev/pandas/issues/8728)）

+   修复了`Series.values_counts`中的一个 bug，即对于`dropna=True`的分类类型`Series`排除了`NaN`（[GH 9443](https://github.com/pandas-dev/pandas/issues/9443)）

+   修复了`DataFrame.std/var/sem`中缺少的`numeric_only`选项（[GH 9201](https://github.com/pandas-dev/pandas/issues/9201)）

+   支持使用标量数据构造`Panel`或`Panel4D`（[GH 8285](https://github.com/pandas-dev/pandas/issues/8285)）

+   `Series` 文本表示与 `max_rows`/`max_columns` 脱节（[GH 7508](https://github.com/pandas-dev/pandas/issues/7508)）。

+   `Series` 数字格式不一致，当被截断时（[GH 8532](https://github.com/pandas-dev/pandas/issues/8532)）。

    以前的行为

    ```py
    In [2]: pd.options.display.max_rows = 10
    In [3]: s = pd.Series([1,1,1,1,1,1,1,1,1,1,0.9999,1,1]*10)
    In [4]: s
    Out[4]:
    0    1
    1    1
    2    1
    ...
    127    0.9999
    128    1.0000
    129    1.0000
    Length: 130, dtype: float64 
    ```

    新行为

    ```py
    0      1.0000
    1      1.0000
    2      1.0000
    3      1.0000
    4      1.0000
    ...
    125    1.0000
    126    1.0000
    127    0.9999
    128    1.0000
    129    1.0000
    dtype: float64 
    ```

+   在某些情况下，当在框架中设置新项目时，会生成虚假的`SettingWithCopy`警告（[GH 8730](https://github.com/pandas-dev/pandas/issues/8730)）

    以前会报出`SettingWithCopy`警告。

    ```py
    In [42]: df1 = pd.DataFrame({'x': pd.Series(['a', 'b', 'c']),
     ....:                    'y': pd.Series(['d', 'e', 'f'])})
     ....: 

    In [43]: df2 = df1[['x']]

    In [44]: df2['y'] = ['g', 'h', 'i'] 
    ```  ## 贡献者

这个版本有总共 60 个人贡献了补丁。带有“+”符号的人是首次贡献补丁。

+   Aaron Toth +

+   Alan Du +

+   Alessandro Amici +

+   Artemy Kolchinsky

+   Ashwini Chaudhary +

+   Ben Schiller

+   Bill Letson

+   Brandon Bradley +

+   Chau Hoang +

+   Chris Reynolds

+   Chris Whelan +

+   Christer van der Meeren +

+   David Cottrell +

+   David Stephens

+   Ehsan Azarnasab +

+   Garrett-R +

+   Guillaume Gay

+   Jake Torcasso +

+   Jason Sexauer

+   Jeff Reback

+   John McNamara

+   Joris Van den Bossche

+   Joschka zur Jacobsmühlen +

+   Juarez Bochi +

+   Junya Hayashi +

+   K.-Michael Aye

+   Kerby Shedden +

+   Kevin Sheppard

+   Kieran O’Mahony

+   Kodi Arfer +

+   Matti Airas +

+   Min RK +

+   Mortada Mehyar

+   Robert +

+   Scott E Lasley

+   Scott Lasley +

+   Sergio Pascual +

+   Skipper Seabold

+   Stephan Hoyer

+   Thomas Grainger

+   Tom Augspurger

+   TomAugspurger

+   Vladimir Filimonov +

+   Vyomkesh Tripathi +

+   Will Holmgren

+   Yulong Yang +

+   behzad nouri

+   bertrandhaut +

+   bjonen

+   cel4 +

+   clham

+   hsperr +

+   ischwabacher

+   jnmclarty

+   josham +

+   jreback

+   omtinez +

+   roch +

+   sinhrks

+   unutbu  ## 新特性

### DataFrame 分配

受[dplyr](https://dplyr.tidyverse.org/articles/dplyr.html#mutating-operations) `mutate`动词的启发，DataFrame 具有新的`assign()`方法。`assign`的函数签名只是`**kwargs`。键是新字段的列名，值可以是要插入的值（例如，一个`Series`或 NumPy 数组），或者是要在`DataFrame`上调用的一个参数的函数。新值被插入，整个 DataFrame（包括所有原始和新列）被返回。

```py
In [1]: iris = pd.read_csv('data/iris.data')

In [2]: iris.head()
Out[2]: 
 SepalLength  SepalWidth  PetalLength  PetalWidth         Name
0          5.1         3.5          1.4         0.2  Iris-setosa
1          4.9         3.0          1.4         0.2  Iris-setosa
2          4.7         3.2          1.3         0.2  Iris-setosa
3          4.6         3.1          1.5         0.2  Iris-setosa
4          5.0         3.6          1.4         0.2  Iris-setosa

[5 rows x 5 columns]

In [3]: iris.assign(sepal_ratio=iris['SepalWidth'] / iris['SepalLength']).head()
Out[3]: 
 SepalLength  SepalWidth  PetalLength  PetalWidth         Name  sepal_ratio
0          5.1         3.5          1.4         0.2  Iris-setosa     0.686275
1          4.9         3.0          1.4         0.2  Iris-setosa     0.612245
2          4.7         3.2          1.3         0.2  Iris-setosa     0.680851
3          4.6         3.1          1.5         0.2  Iris-setosa     0.673913
4          5.0         3.6          1.4         0.2  Iris-setosa     0.720000

[5 rows x 6 columns] 
```

上面是插入预先计算值的示例。我们也可以传入一个要评估的函数。

```py
In [4]: iris.assign(sepal_ratio=lambda x: (x['SepalWidth']
 ...:                                   / x['SepalLength'])).head()
 ...: 
Out[4]: 
 SepalLength  SepalWidth  PetalLength  PetalWidth         Name  sepal_ratio
0          5.1         3.5          1.4         0.2  Iris-setosa     0.686275
1          4.9         3.0          1.4         0.2  Iris-setosa     0.612245
2          4.7         3.2          1.3         0.2  Iris-setosa     0.680851
3          4.6         3.1          1.5         0.2  Iris-setosa     0.673913
4          5.0         3.6          1.4         0.2  Iris-setosa     0.720000

[5 rows x 6 columns] 
```

当`assign`在操作链中使用时，其威力就显现出来了。例如，我们可以将 DataFrame 限制为仅包含萼片长度大于 5 的数据，计算比率，并绘制图表。

```py
In [5]: iris = pd.read_csv('data/iris.data')

In [6]: (iris.query('SepalLength > 5')
 ...:     .assign(SepalRatio=lambda x: x.SepalWidth / x.SepalLength,
 ...:             PetalRatio=lambda x: x.PetalWidth / x.PetalLength)
 ...:     .plot(kind='scatter', x='SepalRatio', y='PetalRatio'))
 ...: 
Out[6]: <Axes: xlabel='SepalRatio', ylabel='PetalRatio'> 
```

![../_images/whatsnew_assign.png](img/whatsnew_assign.png)

查看文档以获取更多信息。([GH 9229](https://github.com/pandas-dev/pandas/issues/9229))  ### 与 scipy.sparse 的交互

添加了`SparseSeries.to_coo()`和`SparseSeries.from_coo()`方法（[GH 8048](https://github.com/pandas-dev/pandas/issues/8048)），用于在`scipy.sparse.coo_matrix`实例之间进行转换（参见这里）。例如，给定一个具有 MultiIndex 的 SparseSeries，我们可以通过指定行和列标签作为索引级别将其转换为`scipy.sparse.coo_matrix`：

```py
s = pd.Series([3.0, np.nan, 1.0, 3.0, np.nan, np.nan])
s.index = pd.MultiIndex.from_tuples([(1, 2, 'a', 0),
                                     (1, 2, 'a', 1),
                                     (1, 1, 'b', 0),
                                     (1, 1, 'b', 1),
                                     (2, 1, 'b', 0),
                                     (2, 1, 'b', 1)],
                                    names=['A', 'B', 'C', 'D'])

s

# SparseSeries
ss = s.to_sparse()
ss

A, rows, columns = ss.to_coo(row_levels=['A', 'B'],
                             column_levels=['C', 'D'],
                             sort_labels=False)

A
A.todense()
rows
columns 
```

`from_coo`方法是一个方便的方法，用于从`scipy.sparse.coo_matrix`创建`SparseSeries`：

```py
from scipy import sparse
A = sparse.coo_matrix(([3.0, 1.0, 2.0], ([1, 0, 0], [0, 2, 3])),
                      shape=(3, 4))
A
A.todense()

ss = pd.SparseSeries.from_coo(A)
ss 
```  ### 字符串方法增强

+   以下新方法可通过`.str`访问器访问，以将该函数应用于每个值。这旨在使其与字符串上的标准方法更一致。([GH 9282](https://github.com/pandas-dev/pandas/issues/9282), [GH 9352](https://github.com/pandas-dev/pandas/issues/9352), [GH 9386](https://github.com/pandas-dev/pandas/issues/9386), [GH 9387](https://github.com/pandas-dev/pandas/issues/9387), [GH 9439](https://github.com/pandas-dev/pandas/issues/9439))

    |  |  | 方法 |  |  |
    | --- | --- | --- | --- | --- |
    | `isalnum()` | `isalpha()` | `isdigit()` | `isdigit()` | `isspace()` |
    | `islower()` | `isupper()` | `istitle()` | `isnumeric()` | `isdecimal()` |
    | `find()` | `rfind()` | `ljust()` | `rjust()` | `zfill()` |

    ```py
    In [7]: s = pd.Series(['abcd', '3456', 'EFGH'])

    In [8]: s.str.isalpha()
    Out[8]: 
    0     True
    1    False
    2     True
    Length: 3, dtype: bool

    In [9]: s.str.find('ab')
    Out[9]: 
    0    0
    1   -1
    2   -1
    Length: 3, dtype: int64 
    ```

+   `Series.str.pad()`和`Series.str.center()`现在接受`fillchar`选项来指定填充字符（[GH 9352](https://github.com/pandas-dev/pandas/issues/9352)）

    ```py
    In [10]: s = pd.Series(['12', '300', '25'])

    In [11]: s.str.pad(5, fillchar='_')
    Out[11]: 
    0    ___12
    1    __300
    2    ___25
    Length: 3, dtype: object 
    ```

+   添加了 `Series.str.slice_replace()`，之前会引发 `NotImplementedError` ([GH 8888](https://github.com/pandas-dev/pandas/issues/8888))

    ```py
    In [12]: s = pd.Series(['ABCD', 'EFGH', 'IJK'])

    In [13]: s.str.slice_replace(1, 3, 'X')
    Out[13]: 
    0    AXD
    1    EXH
    2     IX
    Length: 3, dtype: object

    # replaced with empty char
    In [14]: s.str.slice_replace(0, 1)
    Out[14]: 
    0    BCD
    1    FGH
    2     JK
    Length: 3, dtype: object 
    ```  ### 其他增强功能

+   Reindex 现在支持 `method='nearest'`，用于具有单调递增或递减索引的框架或系列 ([GH 9258](https://github.com/pandas-dev/pandas/issues/9258)):

    ```py
    In [15]: df = pd.DataFrame({'x': range(5)})

    In [16]: df.reindex([0.2, 1.8, 3.5], method='nearest')
    Out[16]: 
     x
    0.2  0
    1.8  2
    3.5  4

    [3 rows x 1 columns] 
    ```

    这个方法也被更低级别的 `Index.get_indexer` 和 `Index.get_loc` 方法暴露出来。

+   `read_excel()` 函数的 sheetname 参数现在接受一个列表和 `None`，分别获取多个或所有工作表。如果指定了多个工作表，则返回一个字典。 ([GH 9450](https://github.com/pandas-dev/pandas/issues/9450))

    ```py
    # Returns the 1st and 4th sheet, as a dictionary of DataFrames.
    pd.read_excel('path_to_file.xls', sheetname=['Sheet1', 3]) 
    ```

+   允许使用迭代器逐步读取 Stata 文件；支持 Stata 文件中的长字符串。查看文档这里（[GH 9493](https://github.com/pandas-dev/pandas/issues/9493):）。

+   以 ~ 开头的路径现在会扩展为以用户的主目录开头（[GH 9066](https://github.com/pandas-dev/pandas/issues/9066))

+   在 `get_data_yahoo` 中添加了时间间隔选择功能（[GH 9071](https://github.com/pandas-dev/pandas/issues/9071))

+   添加了 `Timestamp.to_datetime64()` 来补充 `Timedelta.to_timedelta64()` ([GH 9255](https://github.com/pandas-dev/pandas/issues/9255))

+   `tseries.frequencies.to_offset()` 现在接受 `Timedelta` 作为输入（[GH 9064](https://github.com/pandas-dev/pandas/issues/9064))

+   在 `Series` 的自相关方法中添加了滞后参数，默认为滞后-1 自相关 ([GH 9192](https://github.com/pandas-dev/pandas/issues/9192))

+   `Timedelta` 现在在构造函数中接受 `nanoseconds` 关键字（[GH 9273](https://github.com/pandas-dev/pandas/issues/9273))

+   SQL 代码现在安全地转义表名和列名（[GH 8986](https://github.com/pandas-dev/pandas/issues/8986))

+   为 `Series.str.<tab>`，`Series.dt.<tab>` 和 `Series.cat.<tab>` 添加了自动补全功能（[GH 9322](https://github.com/pandas-dev/pandas/issues/9322))

+   `Index.get_indexer` 现在支持 `method='pad'` 和 `method='backfill'`，即使对于任何目标数组，而不仅仅是单调的目标。这些方法也适用于单调递减以及单调递增的索引 ([GH 9258](https://github.com/pandas-dev/pandas/issues/9258)).

+   `Index.asof` 现在适用于所有索引类型 ([GH 9258](https://github.com/pandas-dev/pandas/issues/9258)).

+   在 `io.read_excel()` 中增加了一个 `verbose` 参数，默认为 False。设置为 True 以在解析时打印工作表名称。 ([GH 9450](https://github.com/pandas-dev/pandas/issues/9450))

+   在`Timestamp`，`DatetimeIndex`，`Period`，`PeriodIndex`和`Series.dt`中添加了`days_in_month`（兼容别名`daysinmonth`）属性（[GH 9572](https://github.com/pandas-dev/pandas/issues/9572))

+   在 `to_csv` 中添加了 `decimal` 选项，为非“.”小数分隔符提供格式设置。([GH 781](https://github.com/pandas-dev/pandas/issues/781))

+   为 `Timestamp` 添加了 `normalize` 选项，以将时间标准化为午夜。([GH 8794](https://github.com/pandas-dev/pandas/issues/8794))

+   添加了使用 HDF5 文件和 `rhdf5` 库导入 `DataFrame` 的示例。更多详细信息请参阅文档（[GH 9636](https://github.com/pandas-dev/pandas/issues/9636)）。### DataFrame assign

受 [dplyr](https://dplyr.tidyverse.org/articles/dplyr.html#mutating-operations) `mutate` 动词的启发，DataFrame 有一个新的 `assign()` 方法。`assign` 的函数签名简单为 `**kwargs`。键是新字段的列名，值要么是要插入的值（例如，一个 `Series` 或 NumPy 数组），要么是要在 `DataFrame` 上调用的一个参数的函数。新值被插入，并返回整个 DataFrame（包括所有原始和新列）。

```py
In [1]: iris = pd.read_csv('data/iris.data')

In [2]: iris.head()
Out[2]: 
 SepalLength  SepalWidth  PetalLength  PetalWidth         Name
0          5.1         3.5          1.4         0.2  Iris-setosa
1          4.9         3.0          1.4         0.2  Iris-setosa
2          4.7         3.2          1.3         0.2  Iris-setosa
3          4.6         3.1          1.5         0.2  Iris-setosa
4          5.0         3.6          1.4         0.2  Iris-setosa

[5 rows x 5 columns]

In [3]: iris.assign(sepal_ratio=iris['SepalWidth'] / iris['SepalLength']).head()
Out[3]: 
 SepalLength  SepalWidth  PetalLength  PetalWidth         Name  sepal_ratio
0          5.1         3.5          1.4         0.2  Iris-setosa     0.686275
1          4.9         3.0          1.4         0.2  Iris-setosa     0.612245
2          4.7         3.2          1.3         0.2  Iris-setosa     0.680851
3          4.6         3.1          1.5         0.2  Iris-setosa     0.673913
4          5.0         3.6          1.4         0.2  Iris-setosa     0.720000

[5 rows x 6 columns] 
```

上面是一个插入预计算值的示例。我们也可以传入一个要评估的函数。

```py
In [4]: iris.assign(sepal_ratio=lambda x: (x['SepalWidth']
 ...:                                   / x['SepalLength'])).head()
 ...: 
Out[4]: 
 SepalLength  SepalWidth  PetalLength  PetalWidth         Name  sepal_ratio
0          5.1         3.5          1.4         0.2  Iris-setosa     0.686275
1          4.9         3.0          1.4         0.2  Iris-setosa     0.612245
2          4.7         3.2          1.3         0.2  Iris-setosa     0.680851
3          4.6         3.1          1.5         0.2  Iris-setosa     0.673913
4          5.0         3.6          1.4         0.2  Iris-setosa     0.720000

[5 rows x 6 columns] 
```

`assign` 的强大之处在于在操作链中使用时。例如，我们可以将 DataFrame 限制为仅包含 Sepal Length 大于 5 的数据，计算比率，并绘制图表。

```py
In [5]: iris = pd.read_csv('data/iris.data')

In [6]: (iris.query('SepalLength > 5')
 ...:     .assign(SepalRatio=lambda x: x.SepalWidth / x.SepalLength,
 ...:             PetalRatio=lambda x: x.PetalWidth / x.PetalLength)
 ...:     .plot(kind='scatter', x='SepalRatio', y='PetalRatio'))
 ...: 
Out[6]: <Axes: xlabel='SepalRatio', ylabel='PetalRatio'> 
```

![../_images/whatsnew_assign.png](img/whatsnew_assign.png)

更多详细信息请参阅文档。（[GH 9229](https://github.com/pandas-dev/pandas/issues/9229)）

### 与 scipy.sparse 的交互

添加了 `SparseSeries.to_coo()` 和 `SparseSeries.from_coo()` 方法，用于将数据转换为和从 `scipy.sparse.coo_matrix` 实例（参见这里）。例如，给定一个带有 MultiIndex 的 SparseSeries，我们可以通过指定行和列标签作为索引级别来将其转换为 `scipy.sparse.coo_matrix`：

```py
s = pd.Series([3.0, np.nan, 1.0, 3.0, np.nan, np.nan])
s.index = pd.MultiIndex.from_tuples([(1, 2, 'a', 0),
                                     (1, 2, 'a', 1),
                                     (1, 1, 'b', 0),
                                     (1, 1, 'b', 1),
                                     (2, 1, 'b', 0),
                                     (2, 1, 'b', 1)],
                                    names=['A', 'B', 'C', 'D'])

s

# SparseSeries
ss = s.to_sparse()
ss

A, rows, columns = ss.to_coo(row_levels=['A', 'B'],
                             column_levels=['C', 'D'],
                             sort_labels=False)

A
A.todense()
rows
columns 
```

`from_coo` 方法是一个方便的方法，用于从 `scipy.sparse.coo_matrix` 创建一个 `SparseSeries`：

```py
from scipy import sparse
A = sparse.coo_matrix(([3.0, 1.0, 2.0], ([1, 0, 0], [0, 2, 3])),
                      shape=(3, 4))
A
A.todense()

ss = pd.SparseSeries.from_coo(A)
ss 
```

### 字符串方法增强

+   通过 `.str` 访问器可以访问以下新方法，以将函数应用于每个值。这旨在使其与字符串上的标准方法更一致。([GH 9282](https://github.com/pandas-dev/pandas/issues/9282), [GH 9352](https://github.com/pandas-dev/pandas/issues/9352), [GH 9386](https://github.com/pandas-dev/pandas/issues/9386), [GH 9387](https://github.com/pandas-dev/pandas/issues/9387), [GH 9439](https://github.com/pandas-dev/pandas/issues/9439))

    |  |  | 方法 |  |  |
    | --- | --- | --- | --- | --- |
    | `isalnum()` | `isalpha()` | `isdigit()` | `isdigit()` | `isspace()` |
    | `islower()` | `isupper()` | `istitle()` | `isnumeric()` | `isdecimal()` |
    | `find()` | `rfind()` | `ljust()` | `rjust()` | `zfill()` |

    ```py
    In [7]: s = pd.Series(['abcd', '3456', 'EFGH'])

    In [8]: s.str.isalpha()
    Out[8]: 
    0     True
    1    False
    2     True
    Length: 3, dtype: bool

    In [9]: s.str.find('ab')
    Out[9]: 
    0    0
    1   -1
    2   -1
    Length: 3, dtype: int64 
    ```

+   `Series.str.pad()` 和 `Series.str.center()` 现在接受 `fillchar` 选项来指定填充字符 ([GH 9352](https://github.com/pandas-dev/pandas/issues/9352))

    ```py
    In [10]: s = pd.Series(['12', '300', '25'])

    In [11]: s.str.pad(5, fillchar='_')
    Out[11]: 
    0    ___12
    1    __300
    2    ___25
    Length: 3, dtype: object 
    ```

+   添加了 `Series.str.slice_replace()`，之前会引发 `NotImplementedError` ([GH 8888](https://github.com/pandas-dev/pandas/issues/8888))

    ```py
    In [12]: s = pd.Series(['ABCD', 'EFGH', 'IJK'])

    In [13]: s.str.slice_replace(1, 3, 'X')
    Out[13]: 
    0    AXD
    1    EXH
    2     IX
    Length: 3, dtype: object

    # replaced with empty char
    In [14]: s.str.slice_replace(0, 1)
    Out[14]: 
    0    BCD
    1    FGH
    2     JK
    Length: 3, dtype: object 
    ```

### 其他增强

+   现在 `reindex` 支持 `method='nearest'`，用于具有单调递增或递减索引的数据帧或系列 ([GH 9258](https://github.com/pandas-dev/pandas/issues/9258)):

    ```py
    In [15]: df = pd.DataFrame({'x': range(5)})

    In [16]: df.reindex([0.2, 1.8, 3.5], method='nearest')
    Out[16]: 
     x
    0.2  0
    1.8  2
    3.5  4

    [3 rows x 1 columns] 
    ```

    这个方法也被更低级别的 `Index.get_indexer` 和 `Index.get_loc` 方法所暴露。

+   `read_excel()` 函数的 sheetname 参数现在接受列表和 `None`，分别用于获取多个或所有工作表。如果指定了多个工作表，将返回一个字典。([GH 9450](https://github.com/pandas-dev/pandas/issues/9450))

    ```py
    # Returns the 1st and 4th sheet, as a dictionary of DataFrames.
    pd.read_excel('path_to_file.xls', sheetname=['Sheet1', 3]) 
    ```

+   允许使用迭代器逐步读取 Stata 文件；支持 Stata 文件中的长字符串。请查看文档 这里 ([GH 9493](https://github.com/pandas-dev/pandas/issues/9493):).

+   以 ~ 开头的路径现在将扩展为以用户的主目录开头 ([GH 9066](https://github.com/pandas-dev/pandas/issues/9066))

+   在 `get_data_yahoo` 中添加了时间间隔选择 ([GH 9071](https://github.com/pandas-dev/pandas/issues/9071))

+   添加了 `Timestamp.to_datetime64()` 来补充 `Timedelta.to_timedelta64()` ([GH 9255](https://github.com/pandas-dev/pandas/issues/9255))

+   `tseries.frequencies.to_offset()` 现在接受 `Timedelta` 作为输入 ([GH 9064](https://github.com/pandas-dev/pandas/issues/9064))

+   `Series` 的自相关方法现在添加了滞后参数，默认为滞后-1 自相关 ([GH 9192](https://github.com/pandas-dev/pandas/issues/9192))

+   `Timedelta` 现在将在构造函数中接受 `nanoseconds` 关键字 ([GH 9273](https://github.com/pandas-dev/pandas/issues/9273))

+   SQL 代码现在安全地转义表名和列名 ([GH 8986](https://github.com/pandas-dev/pandas/issues/8986))

+   为 `Series.str.<tab>`, `Series.dt.<tab>` 和 `Series.cat.<tab>` 添加了自动补全功能 ([GH 9322](https://github.com/pandas-dev/pandas/issues/9322))

+   `Index.get_indexer` 现在支持 `method='pad'` 和 `method='backfill'`，即使对于任何目标数组，而不仅仅是单调目标。这些方法也适用于单调递减以及单调递增的索引 ([GH 9258](https://github.com/pandas-dev/pandas/issues/9258)).

+   `Index.asof` 现在适用于所有索引类型 ([GH 9258](https://github.com/pandas-dev/pandas/issues/9258)).

+   在 `io.read_excel()` 中增加了一个 `verbose` 参数，默认为 False。设置为 True 以在解析时打印工作表名称。 ([GH 9450](https://github.com/pandas-dev/pandas/issues/9450))

+   向 `Timestamp`、`DatetimeIndex`、`Period`、`PeriodIndex` 和 `Series.dt` 添加了 `days_in_month`（兼容别名 `daysinmonth`）属性 ([GH 9572](https://github.com/pandas-dev/pandas/issues/9572))

+   在 `to_csv` 中添加了 `decimal` 选项，以提供非“.”小数分隔符的格式 ([GH 781](https://github.com/pandas-dev/pandas/issues/781))

+   为 `Timestamp` 添加了 `normalize` 选项以标准化到午夜 ([GH 8794](https://github.com/pandas-dev/pandas/issues/8794))

+   添加了使用 HDF5 文件和 `rhdf5` 库将 `DataFrame` 导入到 R 的示例。有关更多信息，请参见文档 ([GH 9636](https://github.com/pandas-dev/pandas/issues/9636))。

## 不兼容的后向 API 更改

### timedelta 的更改

在 v0.15.0 中引入了一个新的标量类型 `Timedelta`，它是 `datetime.timedelta` 的子类。提到了一个关于 `.seconds` 访问器的 API 更改的通知。意图是提供一组用户友好的访问器，以给出该单位的“自然”值，例如，如果你有一个 `Timedelta('1 day, 10:11:12')`，那么 `.seconds` 将返回 12。然而，这与 `datetime.timedelta` 的定义相矛盾，它将 `.seconds` 定义为 `10 * 3600 + 11 * 60 + 12 == 36672`。

因此在 v0.16.0 中，我们恢复了 API 以匹配 `datetime.timedelta` 的行为。此外，组件值仍然可以通过 `.components` 访问器获取。这影响了 `.seconds` 和 `.microseconds` 访问器，并删除了 `.hours`、`.minutes`、`.milliseconds` 访问器。这些更改也影响了 `TimedeltaIndex` 和 Series 的 `.dt` 访问器。 ([GH 9185](https://github.com/pandas-dev/pandas/issues/9185), [GH 9139](https://github.com/pandas-dev/pandas/issues/9139))

之前的行为

```py
In [2]: t = pd.Timedelta('1 day, 10:11:12.100123')

In [3]: t.days
Out[3]: 1

In [4]: t.seconds
Out[4]: 12

In [5]: t.microseconds
Out[5]: 123 
```

新行为

```py
In [17]: t = pd.Timedelta('1 day, 10:11:12.100123')

In [18]: t.days
Out[18]: 1

In [19]: t.seconds
Out[19]: 36672

In [20]: t.microseconds
Out[20]: 100123 
```

使用 `.components` 允许完全访问组件

```py
In [21]: t.components
Out[21]: Components(days=1, hours=10, minutes=11, seconds=12, milliseconds=100, microseconds=123, nanoseconds=0)

In [22]: t.components.seconds
Out[22]: 12 
```  ### 索引变更

`.loc` 使用的一小部分边缘情况的行为已更改 ([GH 8613](https://github.com/pandas-dev/pandas/issues/8613))。此外，我们改进了引发的错误消息的内容：

+   允许使用 `.loc` 进行切片，其中起始和/或停止边界未在索引中找到；这之前会引发 `KeyError`。这使得在这种情况下的行为与 `.ix` 相同。此更改仅用于切片，而不是在单个标签上进行索引时。

    ```py
    In [23]: df = pd.DataFrame(np.random.randn(5, 4),
     ....:                  columns=list('ABCD'),
     ....:                  index=pd.date_range('20130101', periods=5))
     ....: 

    In [24]: df
    Out[24]: 
     A         B         C         D
    2013-01-01  0.469112 -0.282863 -1.509059 -1.135632
    2013-01-02  1.212112 -0.173215  0.119209 -1.044236
    2013-01-03 -0.861849 -2.104569 -0.494929  1.071804
    2013-01-04  0.721555 -0.706771 -1.039575  0.271860
    2013-01-05 -0.424972  0.567020  0.276232 -1.087401

    [5 rows x 4 columns]

    In [25]: s = pd.Series(range(5), [-2, -1, 1, 2, 3])

    In [26]: s
    Out[26]: 
    -2    0
    -1    1
     1    2
     2    3
     3    4
    Length: 5, dtype: int64 
    ```

    之前的行为

    ```py
    In [4]: df.loc['2013-01-02':'2013-01-10']
    KeyError: 'stop bound [2013-01-10] is not in the [index]'

    In [6]: s.loc[-10:3]
    KeyError: 'start bound [-10] is not the [index]' 
    ```

    新行为

    ```py
    In [27]: df.loc['2013-01-02':'2013-01-10']
    Out[27]: 
     A         B         C         D
    2013-01-02  1.212112 -0.173215  0.119209 -1.044236
    2013-01-03 -0.861849 -2.104569 -0.494929  1.071804
    2013-01-04  0.721555 -0.706771 -1.039575  0.271860
    2013-01-05 -0.424972  0.567020  0.276232 -1.087401

    [4 rows x 4 columns]

    In [28]: s.loc[-10:3]
    Out[28]: 
    -2    0
    -1    1
     1    2
     2    3
     3    4
    Length: 5, dtype: int64 
    ```

+   允许在整数索引上使用浮点值进行 `.ix` 的切片。之前只有在 `.loc` 中启用此功能：

    之前的行为

    ```py
    In [8]: s.ix[-1.0:2]
    TypeError: the slice start value [-1.0] is not a proper indexer for this index type (Int64Index) 
    ```

    新行为

    ```py
    In [2]: s.ix[-1.0:2]
    Out[2]:
    -1    1
     1    2
     2    3
    dtype: int64 
    ```

+   当使用 `.loc` 时，为索引类型无效的类型提供有用的异常。例如，尝试在类型为 `DatetimeIndex` 或 `PeriodIndex` 或 `TimedeltaIndex` 的索引上使用 `.loc`，并且使用整数（或浮点数）。

    之前的行为

    ```py
    In [4]: df.loc[2:3]
    KeyError: 'start bound [2] is not the [index]' 
    ```

    新行为

    ```py
    In [4]: df.loc[2:3]
    TypeError: Cannot do slice indexing on <class 'pandas.tseries.index.DatetimeIndex'> with <type 'int'> keys 
    ```  ### 分类更改

在先前的版本中，未指定排序（即未传递`ordered`关键字）的`Categoricals`默认为有序`Categoricals`。从现在开始，`Categorical`构造函数中的`ordered`关键字将默认为`False`。现在必须明确指定排序。

此外，以前您*可以*通过设置属性来更改分类的`ordered`属性，例如`cat.ordered=True`；现在已弃用，您应该使用`cat.as_ordered()`或`cat.as_unordered()`。这些默认会返回一个**新**对象，而不是修改现有对象（[GH 9347](https://github.com/pandas-dev/pandas/issues/9347)，[GH 9190](https://github.com/pandas-dev/pandas/issues/9190)）。

先前的行为

```py
In [3]: s = pd.Series([0, 1, 2], dtype='category')

In [4]: s
Out[4]:
0    0
1    1
2    2
dtype: category
Categories (3, int64): [0 < 1 < 2]

In [5]: s.cat.ordered
Out[5]: True

In [6]: s.cat.ordered = False

In [7]: s
Out[7]:
0    0
1    1
2    2
dtype: category
Categories (3, int64): [0, 1, 2] 
```

新行为

```py
In [29]: s = pd.Series([0, 1, 2], dtype='category')

In [30]: s
Out[30]: 
0    0
1    1
2    2
Length: 3, dtype: category
Categories (3, int64): [0, 1, 2]

In [31]: s.cat.ordered
Out[31]: False

In [32]: s = s.cat.as_ordered()

In [33]: s
Out[33]: 
0    0
1    1
2    2
Length: 3, dtype: category
Categories (3, int64): [0 < 1 < 2]

In [34]: s.cat.ordered
Out[34]: True

# you can set in the constructor of the Categorical
In [35]: s = pd.Series(pd.Categorical([0, 1, 2], ordered=True))

In [36]: s
Out[36]: 
0    0
1    1
2    2
Length: 3, dtype: category
Categories (3, int64): [0 < 1 < 2]

In [37]: s.cat.ordered
Out[37]: True 
```

为了更方便地创建分类数据系列，我们添加了在调用`.astype()`时传递关键字的功能。这些关键字直接传递给构造函数。

```py
In [54]: s = pd.Series(["a", "b", "c", "a"]).astype('category', ordered=True)

In [55]: s
Out[55]:
0    a
1    b
2    c
3    a
dtype: category
Categories (3, object): [a < b < c]

In [56]: s = (pd.Series(["a", "b", "c", "a"])
   ....:        .astype('category', categories=list('abcdef'), ordered=False))

In [57]: s
Out[57]:
0    a
1    b
2    c
3    a
dtype: category
Categories (6, object): [a, b, c, d, e, f] 
```  ### 其他 API 更改

+   `Index.duplicated`现在返回`np.array(dtype=bool)`而不是包含`bool`值的`Index(dtype=object)`（[GH 8875](https://github.com/pandas-dev/pandas/issues/8875)）。

+   `DataFrame.to_json`现在为混合数据类型��数据框的每列返回准确的类型序列化（[GH 9037](https://github.com/pandas-dev/pandas/issues/9037)）。

    以前在序列化之前会将数据强制转换为公共数据类型，例如导致整数被序列化为浮点数：

    ```py
    In [2]: pd.DataFrame({'i': [1,2], 'f': [3.0, 4.2]}).to_json()
    Out[2]: '{"f":{"0":3.0,"1":4.2},"i":{"0":1.0,"1":2.0}}' 
    ```

    现在每列都使用其正确的数据类型进行序列化：

    ```py
    In [2]:  pd.DataFrame({'i': [1,2], 'f': [3.0, 4.2]}).to_json()
    Out[2]: '{"f":{"0":3.0,"1":4.2},"i":{"0":1,"1":2}}' 
    ```

+   `DatetimeIndex`、`PeriodIndex`和`TimedeltaIndex.summary`现在输出相同的格式（[GH 9116](https://github.com/pandas-dev/pandas/issues/9116)）。

+   `TimedeltaIndex.freqstr`现在输出与`DatetimeIndex`相同的字符串格式。

+   条形图和水平条形图不再沿着信息轴添加虚线。以前的样式可以通过 matplotlib 的`axhline`或`axvline`方法实现（[GH 9088](https://github.com/pandas-dev/pandas/issues/9088)）。

+   `Series` 访问器`.dt`、`.cat`和`.str`现在如果系列不包含适当类型的数据，会引发`AttributeError`而不是`TypeError`（[GH 9617](https://github.com/pandas-dev/pandas/issues/9617)）。这更贴近 Python 内置的异常层次结构，并确保像`hasattr(s, 'cat')`这样的测试在 Python 2 和 3 上保持一致。

+   `Series` 现在支持整数类型的位运算（[GH 9016](https://github.com/pandas-dev/pandas/issues/9016)）。之前，即使输入的数据类型是整数，输出的数据类型也会被强制转换为`bool`。

    先前的行为

    ```py
    In [2]: pd.Series([0, 1, 2, 3], list('abcd')) | pd.Series([4, 4, 4, 4], list('abcd'))
    Out[2]:
    a    True
    b    True
    c    True
    d    True
    dtype: bool 
    ```

    新行为。如果输入的数据类型是整数，则输出的数据类型也是整数，输出值是位运算的结果。

    ```py
    In [2]: pd.Series([0, 1, 2, 3], list('abcd')) | pd.Series([4, 4, 4, 4], list('abcd'))
    Out[2]:
    a    4
    b    5
    c    6
    d    7
    dtype: int64 
    ```

+   在涉及`Series`或`DataFrame`的除法运算中，`0/0`和`0//0`现在会返回`np.nan`而不是`np.inf`（[GH 9144](https://github.com/pandas-dev/pandas/issues/9144)，[GH 8445](https://github.com/pandas-dev/pandas/issues/8445)）。

    先前的行为

    ```py
    In [2]: p = pd.Series([0, 1])

    In [3]: p / 0
    Out[3]:
    0    inf
    1    inf
    dtype: float64

    In [4]: p // 0
    Out[4]:
    0    inf
    1    inf
    dtype: float64 
    ```

    新行为

    ```py
    In [38]: p = pd.Series([0, 1])

    In [39]: p / 0
    Out[39]: 
    0    NaN
    1    inf
    Length: 2, dtype: float64

    In [40]: p // 0
    Out[40]: 
    0    NaN
    1    inf
    Length: 2, dtype: float64 
    ```

+   对于分类数据，`Series.values_counts`和`Series.describe`现在将把`NaN`条目放在最后。([GH 9443](https://github.com/pandas-dev/pandas/issues/9443))

+   对于分类数据，`Series.describe`现在将给出未使用类别的计数和频率为 0，而不是`NaN`。([GH 9443](https://github.com/pandas-dev/pandas/issues/9443))

+   由于错误修复，使用`DatetimeIndex.asof`查找部分字符串标签现在包括与字符串匹配的值，即使它们在部分字符串标签的开始之后。([GH 9258](https://github.com/pandas-dev/pandas/issues/9258))

    旧行为:

    ```py
    In [4]: pd.to_datetime(['2000-01-31', '2000-02-28']).asof('2000-02')
    Out[4]: Timestamp('2000-01-31 00:00:00') 
    ```

    修正的行为：

    ```py
    In [41]: pd.to_datetime(['2000-01-31', '2000-02-28']).asof('2000-02')
    Out[41]: Timestamp('2000-02-28 00:00:00') 
    ```

    要复制旧行为，只需将标签更精确（例如，使用`2000-02-01`而不是`2000-02`)。  ### 弃用

+   `rplot` trellis 绘图界面已被弃用，并将在将来的版本中删除。我们建议使用外部包如[seaborn](http://stanford.edu/~mwaskom/software/seaborn/)来获得类似但更精细的功能。([GH 3445](https://github.com/pandas-dev/pandas/issues/3445)) 文档中包含一些示例，说明如何将现有代码从`rplot`转换为 seaborn [here](https://pandas.pydata.org/pandas-docs/version/0.18.1/visualization.html#trellis-plotting-interface)。

+   `pandas.sandbox.qtpandas`接口已被弃用，并将在将来的版本中删除。我们建议用户使用外部包[pandas-qt](https://github.com/datalyze-solutions/pandas-qt)。([GH 9615](https://github.com/pandas-dev/pandas/issues/9615))

+   `pandas.rpy`接口已被弃用，并将在将来的版本中删除。类似功能可以通过[rpy2](http://rpy2.bitbucket.org/)项目访问。([GH 9602](https://github.com/pandas-dev/pandas/issues/9602))

+   将`DatetimeIndex/PeriodIndex`添加到另一个`DatetimeIndex/PeriodIndex`正在被弃用为一个集合操作。这将在将来的版本中更改为`TypeError`。应该使用`.union()`进行并集操作。([GH 9094](https://github.com/pandas-dev/pandas/issues/9094))

+   从另一个`DatetimeIndex/PeriodIndex`减去`DatetimeIndex/PeriodIndex`正在被弃用为一个集合操作。这将在将来的版本中更改为实际的数值减法，产生一个`TimeDeltaIndex`。应该使用`.difference()`进行差集操作。([GH 9094](https://github.com/pandas-dev/pandas/issues/9094))  ### 删除之前版本的弃用/更改

+   `DataFrame.pivot_table`和`crosstab`的`rows`和`cols`关键字参数已被删除，改为使用`index`和`columns`。([GH 6581](https://github.com/pandas-dev/pandas/issues/6581))

+   `DataFrame.to_excel`和`DataFrame.to_csv`的`cols`关键字参数已被删除，改为使用`columns`。([GH 6581](https://github.com/pandas-dev/pandas/issues/6581))

+   删除`convert_dummies`，改用`get_dummies`。([GH 6581](https://github.com/pandas-dev/pandas/issues/6581))

+   移除了`value_range`，改用`describe`（[GH 6581](https://github.com/pandas-dev/pandas/issues/6581)） ### 时间增量的变化

在 v0.15.0 中引入了一个新的标量类型`Timedelta`，它是`datetime.timedelta`的子类。提到的这里是关于`.seconds`访问器的 API 更改的通知。其目的是提供一组用户友好的访问器，以给出该单位的“自然”值，例如如果你有一个`Timedelta('1 day, 10:11:12')`，那么`.seconds`将返回 12。然而，这与`datetime.timedelta`的定义相矛盾，它将`.seconds`定义为`10 * 3600 + 11 * 60 + 12 == 36672`。

因此，在 v0.16.0 中，我们恢复了 API 以匹配`datetime.timedelta`。此外，组件值仍可通过`.components`访问器获得。这影响了`.seconds`和`.microseconds`访问器，并删除了`.hours`、`.minutes`、`.milliseconds`访问器。这些更改也影响了`TimedeltaIndex`和 Series `.dt` 访问器。([GH 9185](https://github.com/pandas-dev/pandas/issues/9185), [GH 9139](https://github.com/pandas-dev/pandas/issues/9139))

先前的行为

```py
In [2]: t = pd.Timedelta('1 day, 10:11:12.100123')

In [3]: t.days
Out[3]: 1

In [4]: t.seconds
Out[4]: 12

In [5]: t.microseconds
Out[5]: 123 
```

新行为

```py
In [17]: t = pd.Timedelta('1 day, 10:11:12.100123')

In [18]: t.days
Out[18]: 1

In [19]: t.seconds
Out[19]: 36672

In [20]: t.microseconds
Out[20]: 100123 
```

使用`.components`允许完全组件访问

```py
In [21]: t.components
Out[21]: Components(days=1, hours=10, minutes=11, seconds=12, milliseconds=100, microseconds=123, nanoseconds=0)

In [22]: t.components.seconds
Out[22]: 12 
```

### 索引变化

一小部分使用`.loc`的边缘情况的行为已更改([GH 8613](https://github.com/pandas-dev/pandas/issues/8613))。此外，我们已改进了引发的错误消息的内容：

+   允许在索引中找不到开始和/或停止边界时使用`.loc`进行切片；以前会引发`KeyError`。这使得在这种情况下的行为与`.ix`相同。此更改仅适用于切片，而不适用于使用单个标签进行索引。

    ```py
    In [23]: df = pd.DataFrame(np.random.randn(5, 4),
     ....:                  columns=list('ABCD'),
     ....:                  index=pd.date_range('20130101', periods=5))
     ....: 

    In [24]: df
    Out[24]: 
     A         B         C         D
    2013-01-01  0.469112 -0.282863 -1.509059 -1.135632
    2013-01-02  1.212112 -0.173215  0.119209 -1.044236
    2013-01-03 -0.861849 -2.104569 -0.494929  1.071804
    2013-01-04  0.721555 -0.706771 -1.039575  0.271860
    2013-01-05 -0.424972  0.567020  0.276232 -1.087401

    [5 rows x 4 columns]

    In [25]: s = pd.Series(range(5), [-2, -1, 1, 2, 3])

    In [26]: s
    Out[26]: 
    -2    0
    -1    1
     1    2
     2    3
     3    4
    Length: 5, dtype: int64 
    ```

    先前的行为

    ```py
    In [4]: df.loc['2013-01-02':'2013-01-10']
    KeyError: 'stop bound [2013-01-10] is not in the [index]'

    In [6]: s.loc[-10:3]
    KeyError: 'start bound [-10] is not the [index]' 
    ```

    新行为

    ```py
    In [27]: df.loc['2013-01-02':'2013-01-10']
    Out[27]: 
     A         B         C         D
    2013-01-02  1.212112 -0.173215  0.119209 -1.044236
    2013-01-03 -0.861849 -2.104569 -0.494929  1.071804
    2013-01-04  0.721555 -0.706771 -1.039575  0.271860
    2013-01-05 -0.424972  0.567020  0.276232 -1.087401

    [4 rows x 4 columns]

    In [28]: s.loc[-10:3]
    Out[28]: 
    -2    0
    -1    1
     1    2
     2    3
     3    4
    Length: 5, dtype: int64 
    ```

+   允许在整数索引上使用类似浮点的值对`.ix`进行切片。以前只能对`.loc`启用此功能：

    先前的行为

    ```py
    In [8]: s.ix[-1.0:2]
    TypeError: the slice start value [-1.0] is not a proper indexer for this index type (Int64Index) 
    ```

    新行为

    ```py
    In [2]: s.ix[-1.0:2]
    Out[2]:
    -1    1
     1    2
     2    3
    dtype: int64 
    ```

+   在使用`.loc`时，如果对具有无效类型的索引进行索引，将提供有用的异常。例如，在类型为`DatetimeIndex`或`PeriodIndex`或`TimedeltaIndex`的索引上使用整数（或浮点数）进行`.loc`。 

    先前的行为

    ```py
    In [4]: df.loc[2:3]
    KeyError: 'start bound [2] is not the [index]' 
    ```

    新行为

    ```py
    In [4]: df.loc[2:3]
    TypeError: Cannot do slice indexing on <class 'pandas.tseries.index.DatetimeIndex'> with <type 'int'> keys 
    ```

### 分类变化

在以前的版本中，未指定排序的`Categoricals`（即未传递`ordered`关键字）默认为有序的`Categoricals`。从现在开始，`Categorical`构造函数中的`ordered`关键字将默认为`False`。排序现在必须是显式的。

此外，以前你*可以*通过设置属性来更改分类的`ordered`属性，例如`cat.ordered=True`；现在已经弃用，你应该使用`cat.as_ordered()`或`cat.as_unordered()`。这些默认会返回一个**新的**对象，而不是修改现有的对象。([GH 9347](https://github.com/pandas-dev/pandas/issues/9347), [GH 9190](https://github.com/pandas-dev/pandas/issues/9190))

先前的行为

```py
In [3]: s = pd.Series([0, 1, 2], dtype='category')

In [4]: s
Out[4]:
0    0
1    1
2    2
dtype: category
Categories (3, int64): [0 < 1 < 2]

In [5]: s.cat.ordered
Out[5]: True

In [6]: s.cat.ordered = False

In [7]: s
Out[7]:
0    0
1    1
2    2
dtype: category
Categories (3, int64): [0, 1, 2] 
```

新行为

```py
In [29]: s = pd.Series([0, 1, 2], dtype='category')

In [30]: s
Out[30]: 
0    0
1    1
2    2
Length: 3, dtype: category
Categories (3, int64): [0, 1, 2]

In [31]: s.cat.ordered
Out[31]: False

In [32]: s = s.cat.as_ordered()

In [33]: s
Out[33]: 
0    0
1    1
2    2
Length: 3, dtype: category
Categories (3, int64): [0 < 1 < 2]

In [34]: s.cat.ordered
Out[34]: True

# you can set in the constructor of the Categorical
In [35]: s = pd.Series(pd.Categorical([0, 1, 2], ordered=True))

In [36]: s
Out[36]: 
0    0
1    1
2    2
Length: 3, dtype: category
Categories (3, int64): [0 < 1 < 2]

In [37]: s.cat.ordered
Out[37]: True 
```

为了更轻松地创建分类数据系列，我们添加了在调用 `.astype()` 时传递关键字的功能。这些关键字直接传递给构造函数。

```py
In [54]: s = pd.Series(["a", "b", "c", "a"]).astype('category', ordered=True)

In [55]: s
Out[55]:
0    a
1    b
2    c
3    a
dtype: category
Categories (3, object): [a < b < c]

In [56]: s = (pd.Series(["a", "b", "c", "a"])
   ....:        .astype('category', categories=list('abcdef'), ordered=False))

In [57]: s
Out[57]:
0    a
1    b
2    c
3    a
dtype: category
Categories (6, object): [a, b, c, d, e, f] 
```

### 其他 API 变更

+   `Index.duplicated` 现在返回 `np.array(dtype=bool)` 而不是包含 `bool` 值的 `Index(dtype=object)`。 ([GH 8875](https://github.com/pandas-dev/pandas/issues/8875))

+   `DataFrame.to_json` 现在为混合 dtype 的帧的每列返回准确的类型序列化 ([GH 9037](https://github.com/pandas-dev/pandas/issues/9037))。

    先前的数据在序列化之前被强制转换为公共 dtype，例如整数被序列化为浮点数：

    ```py
    In [2]: pd.DataFrame({'i': [1,2], 'f': [3.0, 4.2]}).to_json()
    Out[2]: '{"f":{"0":3.0,"1":4.2},"i":{"0":1.0,"1":2.0}}' 
    ```

    现在每列都使用其正确的 dtype 进行序列化：

    ```py
    In [2]:  pd.DataFrame({'i': [1,2], 'f': [3.0, 4.2]}).to_json()
    Out[2]: '{"f":{"0":3.0,"1":4.2},"i":{"0":1,"1":2}}' 
    ```

+   `DatetimeIndex`、`PeriodIndex` 和 `TimedeltaIndex.summary` 现在输出相同的格式。 ([GH 9116](https://github.com/pandas-dev/pandas/issues/9116))

+   `TimedeltaIndex.freqstr` 现在输出与 `DatetimeIndex` 相同的字符串格式。 ([GH 9116](https://github.com/pandas-dev/pandas/issues/9116))

+   条形图和水平条形图不再沿信息轴添加虚线。可以使用 matplotlib 的 `axhline` 或 `axvline` 方法实现先前的样式 ([GH 9088](https://github.com/pandas-dev/pandas/issues/9088))。

+   如果系列不包含适当类型的数据，`Series` 访问器 `.dt`、`.cat` 和 `.str` 现在会引发 `AttributeError` 而不是 `TypeError` ([GH 9617](https://github.com/pandas-dev/pandas/issues/9617))。这更接近于 Python 的内置异常层次结构，并确保诸如 `hasattr(s, 'cat')` 的测试在 Python 2 和 3 上保持一致。

+   `Series` 现在支持整数类型的位操作 ([GH 9016](https://github.com/pandas-dev/pandas/issues/9016))。即使输入的 dtype 是整数，先前的行为也会强制输出的 dtype 转换为 `bool`。

    先前的行为

    ```py
    In [2]: pd.Series([0, 1, 2, 3], list('abcd')) | pd.Series([4, 4, 4, 4], list('abcd'))
    Out[2]:
    a    True
    b    True
    c    True
    d    True
    dtype: bool 
    ```

    新行为。如果输入的 dtype 是整数，则输出的 dtype 也是整数，输出值是位操作的结果。

    ```py
    In [2]: pd.Series([0, 1, 2, 3], list('abcd')) | pd.Series([4, 4, 4, 4], list('abcd'))
    Out[2]:
    a    4
    b    5
    c    6
    d    7
    dtype: int64 
    ```

+   在涉及 `Series` 或 `DataFrame` 的除法中，`0/0` 和 `0//0` 现在会返回 `np.nan` 而不是 `np.inf`。 ([GH 9144](https://github.com/pandas-dev/pandas/issues/9144), [GH 8445](https://github.com/pandas-dev/pandas/issues/8445))。

    先前的行为

    ```py
    In [2]: p = pd.Series([0, 1])

    In [3]: p / 0
    Out[3]:
    0    inf
    1    inf
    dtype: float64

    In [4]: p // 0
    Out[4]:
    0    inf
    1    inf
    dtype: float64 
    ```

    新行为

    ```py
    In [38]: p = pd.Series([0, 1])

    In [39]: p / 0
    Out[39]: 
    0    NaN
    1    inf
    Length: 2, dtype: float64

    In [40]: p // 0
    Out[40]: 
    0    NaN
    1    inf
    Length: 2, dtype: float64 
    ```

+   对于分类数据，`Series.values_counts` 和 `Series.describe` 现在将 `NaN` 条目放在末尾。 ([GH 9443](https://github.com/pandas-dev/pandas/issues/9443))

+   对于分类数据，`Series.describe` 现在将为未使用的类别提供计数和频率为 0，而不是 `NaN` ([GH 9443](https://github.com/pandas-dev/pandas/issues/9443))。

+   由于 bug 修复，使用 `DatetimeIndex.asof` 查找部分字符串标签现在包括与字符串匹配的值，即使它们在部分字符串标签的起始位置之后 ([GH 9258](https://github.com/pandas-dev/pandas/issues/9258))。

    旧行为：

    ```py
    In [4]: pd.to_datetime(['2000-01-31', '2000-02-28']).asof('2000-02')
    Out[4]: Timestamp('2000-01-31 00:00:00') 
    ```

    修复行为：

    ```py
    In [41]: pd.to_datetime(['2000-01-31', '2000-02-28']).asof('2000-02')
    Out[41]: Timestamp('2000-02-28 00:00:00') 
    ```

    要重现旧行为，只需在标签上增加更多精度（例如，使用 `2000-02-01` 而不是 `2000-02`）。

### 废弃内容

+   `rplot` trellis 绘图接口已被弃用，并将在未来版本中移除。我们建议使用外部包如 [seaborn](http://stanford.edu/~mwaskom/software/seaborn/) 来获得类似但更精细的功能 ([GH 3445](https://github.com/pandas-dev/pandas/issues/3445))。文档中包含一些示例，说明如何将现有代码从 `rplot` 转换为 seaborn [这里](https://pandas.pydata.org/pandas-docs/version/0.18.1/visualization.html#trellis-plotting-interface)。

+   `pandas.sandbox.qtpandas` 接口已被弃用，并将在未来版本中移除。我们建议用户使用外部包 [pandas-qt](https://github.com/datalyze-solutions/pandas-qt)。 ([GH 9615](https://github.com/pandas-dev/pandas/issues/9615))

+   `pandas.rpy` 接口已被弃用，并将在未来版本中移除。类似功能可以通过 [rpy2](http://rpy2.bitbucket.org/) 项目访问（[GH 9602](https://github.com/pandas-dev/pandas/issues/9602)）

+   将 `DatetimeIndex/PeriodIndex` 添加到另一个 `DatetimeIndex/PeriodIndex` 中正在被弃用作为一个集合操作。这将在未来版本中更改为 `TypeError`。应该使用 `.union()` 进行并集操作。 ([GH 9094](https://github.com/pandas-dev/pandas/issues/9094))

+   从另一个 `DatetimeIndex/PeriodIndex` 中减去 `DatetimeIndex/PeriodIndex` 正在被弃用作为一个集合操作。这将在未来版本中更改为实际的数值减法，产生一个 `TimeDeltaIndex`。应该使用 `.difference()` 进行差集操作。 ([GH 9094](https://github.com/pandas-dev/pandas/issues/9094))

### 移除之前版本的弃用/更改

+   `DataFrame.pivot_table` 和 `crosstab` 的 `rows` 和 `cols` 关键字参数已被移除，改为使用 `index` 和 `columns` ([GH 6581](https://github.com/pandas-dev/pandas/issues/6581))

+   `DataFrame.to_excel` 和 `DataFrame.to_csv` 的 `cols` 关键字参数已被移除，改为使用 `columns` ([GH 6581](https://github.com/pandas-dev/pandas/issues/6581))

+   移除 `convert_dummies`，改为使用 `get_dummies` ([GH 6581](https://github.com/pandas-dev/pandas/issues/6581))

+   移除 `value_range`，改为使用 `describe` ([GH 6581](https://github.com/pandas-dev/pandas/issues/6581))

## 性能改进

+   修复了使用数组或类似列表进行 `.loc` 索引的性能回归 ([GH 9126](https://github.com/pandas-dev/pandas/issues/9126):)。

+   `DataFrame.to_json` 混合数据类型框架的性能提升 30 倍。 ([GH 9037](https://github.com/pandas-dev/pandas/issues/9037))

+   通过使用标签而不是值来处理 `MultiIndex.duplicated`，提高了性能 ([GH 9125](https://github.com/pandas-dev/pandas/issues/9125))

+   通过调用 `unique` 而不是 `value_counts` 来提高 `nunique` 的速度 ([GH 9129](https://github.com/pandas-dev/pandas/issues/9129), [GH 7771](https://github.com/pandas-dev/pandas/issues/7771))

+   通过适当利用同质/异质数据类型，`DataFrame.count` 和 `DataFrame.dropna` 的性能提升高达 10 倍（[GH 9136](https://github.com/pandas-dev/pandas/issues/9136)）

+   通过使用`MultiIndex`和`level`关键字参数，在`DataFrame.count`中的性能提升高达 20 倍（[GH 9163](https://github.com/pandas-dev/pandas/issues/9163)）

+   在`merge`中当键空间超过`int64`边界时提高了性能和内存使用效率（[GH 9151](https://github.com/pandas-dev/pandas/issues/9151)）

+   在多键`groupby`中提高了性能（[GH 9429](https://github.com/pandas-dev/pandas/issues/9429)）

+   在`MultiIndex.sortlevel`中提高了性能（[GH 9445](https://github.com/pandas-dev/pandas/issues/9445)）

+   在`DataFrame.duplicated`中提高了性能和内存使用效率（[GH 9398](https://github.com/pandas-dev/pandas/issues/9398)）

+   优化了`Period`的 Cython 化（[GH 9440](https://github.com/pandas-dev/pandas/issues/9440)）

+   在`to_hdf`上减少了内存使用（[GH 9648](https://github.com/pandas-dev/pandas/issues/9648)）

## Bug 修复

+   更改了`.to_html`以删除表体中的前导/尾随空格（[GH 4987](https://github.com/pandas-dev/pandas/issues/4987)）

+   修复了在 Python 3 上使用`read_csv`读取 s3 时出现的问题（[GH 9452](https://github.com/pandas-dev/pandas/issues/9452)）

+   修复了影响`numpy.int_`默认为`numpy.int32`的架构中`DatetimeIndex`的兼容性问题（[GH 8943](https://github.com/pandas-dev/pandas/issues/8943)）

+   使用类似对象的 Panel 索引的错误（[GH 9140](https://github.com/pandas-dev/pandas/issues/9140)）

+   返回的`Series.dt.components`索引重置为默认索引的错误（[GH 9247](https://github.com/pandas-dev/pandas/issues/9247)）

+   修复了`Categorical.__getitem__/__setitem__`中使用类似列表的输入导致索引器强制转换得到不正确结果的错误（[GH 9469](https://github.com/pandas-dev/pandas/issues/9469)）

+   部分设置中使用 DatetimeIndex 的错误（[GH 9478](https://github.com/pandas-dev/pandas/issues/9478)）

+   在应用聚合器时，整数和 datetime64 列的 groupby 出现错误，当数字足够大时导致值发生变化（[GH 9311](https://github.com/pandas-dev/pandas/issues/9311), [GH 6620](https://github.com/pandas-dev/pandas/issues/6620)）

+   修复了`to_sql`中将`Timestamp`对象列（带有时区信息的日期时间列）映射到适当的 SQLAlchemy 类型的错误（[GH 9085](https://github.com/pandas-dev/pandas/issues/9085)）

+   修复了`to_sql`中`dtype`参数不接受实例化的 SQLAlchemy 类型的错误（[GH 9083](https://github.com/pandas-dev/pandas/issues/9083)）

+   使用`np.datetime64`进行`.loc`部分设置的错误（[GH 9516](https://github.com/pandas-dev/pandas/issues/9516)）

+   在看起来类似日期时间的`Series`和`.xs`切片上推断的不正确的数据类型（[GH 9477](https://github.com/pandas-dev/pandas/issues/9477)）

+   `Categorical.unique()` 中的项目（如果`s`的类型为`category`，则为`s.unique()`）现在按照最初发现它们的顺序显示，而不是按排序顺序显示（[GH 9331](https://github.com/pandas-dev/pandas/issues/9331)）。这现在与 pandas 中其他类型的行为一致。

+   修复了在大端平台上产生`StataReader` 中不正确结果的错误（[GH 8688](https://github.com/pandas-dev/pandas/issues/8688)）

+   当具有许多级别时，`MultiIndex.has_duplicates` 中的错误会导致索引器溢出（[GH 9075](https://github.com/pandas-dev/pandas/issues/9075)，[GH 5873](https://github.com/pandas-dev/pandas/issues/5873)）

+   在`pivot` 和`unstack` 中，`nan` 值会破坏索引对齐（[GH 4862](https://github.com/pandas-dev/pandas/issues/4862)，[GH 7401](https://github.com/pandas-dev/pandas/issues/7401)，[GH 7403](https://github.com/pandas-dev/pandas/issues/7403)，[GH 7405](https://github.com/pandas-dev/pandas/issues/7405)，[GH 7466](https://github.com/pandas-dev/pandas/issues/7466)，[GH 9497](https://github.com/pandas-dev/pandas/issues/9497)）

+   在具有`sort=True`或空值的 MultiIndex 上进行左连接中存在错误（[GH 9210](https://github.com/pandas-dev/pandas/issues/9210)）

+   在`MultiIndex` 中插入新键时会失败的错误（[GH 9250](https://github.com/pandas-dev/pandas/issues/9250)）

+   当键空间超过`int64`边界时，`groupby` 中存在错误（[GH 9096](https://github.com/pandas-dev/pandas/issues/9096)）

+   在具有`TimedeltaIndex`或`DatetimeIndex`和空值的`unstack` 中存在错误（[GH 9491](https://github.com/pandas-dev/pandas/issues/9491)）

+   在`rank` 中，使用容差比较浮点数会导致不一致的行为（[GH 8365](https://github.com/pandas-dev/pandas/issues/8365)）

+   修复了从 URL 加载数据时，在`read_stata` 和`StataReader` 中的字符编码错误（[GH 9231](https://github.com/pandas-dev/pandas/issues/9231)）

+   将`offsets.Nano` 添加到其他偏移量会引发`TypeError` 的错误已修复（[GH 9284](https://github.com/pandas-dev/pandas/issues/9284))

+   `DatetimeIndex` 迭代中存在错误，与（[GH 8890](https://github.com/pandas-dev/pandas/issues/8890)）相关，已在（[GH 9100](https://github.com/pandas-dev/pandas/issues/9100)）中修复

+   在 DST 转换周围的`resample` 中存在错误。这需要修复偏移类，以便它们在 DST 转换时表现正确（[GH 5172](https://github.com/pandas-dev/pandas/issues/5172)，[GH 8744](https://github.com/pandas-dev/pandas/issues/8744)，[GH 8653](https://github.com/pandas-dev/pandas/issues/8653)，[GH 9173](https://github.com/pandas-dev/pandas/issues/9173)，[GH 9468](https://github.com/pandas-dev/pandas/issues/9468)）

+   二进制运算符方法（例如`.mul()`）与整数级别对齐时存在错误（[GH 9463](https://github.com/pandas-dev/pandas/issues/9463)）

+   盒形图、散点图和六边形图中的错误可能会显示不必要的警告（[GH 8877](https://github.com/pandas-dev/pandas/issues/8877)）

+   subplot 中使用`layout` kw 可能会显示不必要的警告的错误（[GH 9464](https://github.com/pandas-dev/pandas/issues/9464)）

+   修复了使用需要传递参数的分组函数时出现的错误（例如轴），当使用包装函数（例如`fillna`）时，（[GH 9221](https://github.com/pandas-dev/pandas/issues/9221)）

+   `DataFrame`现在在构造函数中正确支持同时使用`copy`和`dtype`参数（[GH 9099](https://github.com/pandas-dev/pandas/issues/9099)）

+   在使用 c 引擎时，`read_csv`在具有 CR 行结束的文件上使用 skiprows 时的错误。 ([GH 9079](https://github.com/pandas-dev/pandas/issues/9079))

+   `isnull`现在可以检测`PeriodIndex`中的`NaT`（[GH 9129](https://github.com/pandas-dev/pandas/issues/9129)）

+   在具有多列 groupby 的 groupby `.nth()`中的错误（[GH 8979](https://github.com/pandas-dev/pandas/issues/8979)）

+   `DataFrame.where`和`Series.where`错误地将数值转换为字符串（[GH 9280](https://github.com/pandas-dev/pandas/issues/9280)）

+   当传递字符串列表时，`DataFrame.where`和`Series.where`会引发`ValueError`的错误。 ([GH 9280](https://github.com/pandas-dev/pandas/issues/9280))

+   在非字符串值上访问`Series.str`方法现在会引发`TypeError`而不是产生不正确的结果（[GH 9184](https://github.com/pandas-dev/pandas/issues/9184)）

+   当索引具有重复项且不是单调递增时，`DatetimeIndex.__contains__`中的错误（[GH 9512](https://github.com/pandas-dev/pandas/issues/9512)）

+   修复了`Series.kurt()`在所有值相等时出现的除零错误（[GH 9197](https://github.com/pandas-dev/pandas/issues/9197)）

+   修复了`xlsxwriter`引擎中的问题，当未应用其他格式时，它会向单元格添加默认的“General”格式。 这会阻止应用其他行或列格式。 ([GH 9167](https://github.com/pandas-dev/pandas/issues/9167))

+   修复了在`read_csv`中`index_col=False`时，同时指定`usecols`时的问题。 ([GH 9082](https://github.com/pandas-dev/pandas/issues/9082))

+   `wide_to_long`会修改输入存根名称列表的错误（[GH 9204](https://github.com/pandas-dev/pandas/issues/9204)）

+   修复了`to_sql`中未使用双精度存储 float64 值的错误。 ([GH 9009](https://github.com/pandas-dev/pandas/issues/9009))

+   `SparseSeries`和`SparsePanel`现在接受零参数构造函数（与它们的非稀疏对应物相同）（[GH 9272](https://github.com/pandas-dev/pandas/issues/9272)）

+   合并`Categorical`和`object`数据类型时的回归错误（[GH 9426](https://github.com/pandas-dev/pandas/issues/9426)）

+   在某些格式不正确的输入文件中，`read_csv`中的缓冲区溢出错误。 ([GH 9205](https://github.com/pandas-dev/pandas/issues/9205))

+   在具有缺失对的 groupby MultiIndex 中的错误（[GH 9049](https://github.com/pandas-dev/pandas/issues/9049)，[GH 9344](https://github.com/pandas-dev/pandas/issues/9344)）

+   修复了`Series.groupby`中的 bug，当在`MultiIndex`级别上进行分组时，会忽略排序参数 ([GH 9444](https://github.com/pandas-dev/pandas/issues/9444))

+   修复了`DataFrame.Groupby`中的 bug，在分类列的情况下，`sort=False`被忽略。 ([GH 8868](https://github.com/pandas-dev/pandas/issues/8868))

+   修复了在 python 3 上从 Amazon S3 读取 CSV 文件时引发 TypeError 的 bug ([GH 9452](https://github.com/pandas-dev/pandas/issues/9452))

+   Google BigQuery 读取器中的一个 bug，查询结果中可能存在‘jobComplete’键，但值为 False ([GH 8728](https://github.com/pandas-dev/pandas/issues/8728))

+   `Series.values_counts`中的 bug，对于`dropna=True`的分类类型`Series`排除`NaN` ([GH 9443](https://github.com/pandas-dev/pandas/issues/9443))

+   修复了`DataFrame.std/var/sem`中缺失的`numeric_only`选项 ([GH 9201](https://github.com/pandas-dev/pandas/issues/9201))

+   支持使用标量数据构建`Panel`或`Panel4D` ([GH 8285](https://github.com/pandas-dev/pandas/issues/8285))

+   `Series`文本表示与`max_rows`/`max_columns`脱节 ([GH 7508](https://github.com/pandas-dev/pandas/issues/7508)).

+   当截断时，`Series`数字格式不一致 ([GH 8532](https://github.com/pandas-dev/pandas/issues/8532)).

    以前的行��

    ```py
    In [2]: pd.options.display.max_rows = 10
    In [3]: s = pd.Series([1,1,1,1,1,1,1,1,1,1,0.9999,1,1]*10)
    In [4]: s
    Out[4]:
    0    1
    1    1
    2    1
    ...
    127    0.9999
    128    1.0000
    129    1.0000
    Length: 130, dtype: float64 
    ```

    新行为

    ```py
    0      1.0000
    1      1.0000
    2      1.0000
    3      1.0000
    4      1.0000
    ...
    125    1.0000
    126    1.0000
    127    0.9999
    128    1.0000
    129    1.0000
    dtype: float64 
    ```

+   在某些情况下，在框架中设置新项时会生成一个虚假的`SettingWithCopy`警告 ([GH 8730](https://github.com/pandas-dev/pandas/issues/8730))

    以前会报告`SettingWithCopy`警告。

    ```py
    In [42]: df1 = pd.DataFrame({'x': pd.Series(['a', 'b', 'c']),
     ....:                    'y': pd.Series(['d', 'e', 'f'])})
     ....: 

    In [43]: df2 = df1[['x']]

    In [44]: df2['y'] = ['g', 'h', 'i'] 
    ```

## 贡献者

总共有 60 人为这个版本贡献了补丁。名字后面带有“+”的人第一次贡献了补丁。

+   Aaron Toth +

+   Alan Du +

+   Alessandro Amici +

+   Artemy Kolchinsky

+   Ashwini Chaudhary +

+   Ben Schiller

+   Bill Letson

+   Brandon Bradley + 

+   Chau Hoang +

+   Chris Reynolds

+   Chris Whelan +

+   Christer van der Meeren +

+   David Cottrell +

+   David Stephens

+   Ehsan Azarnasab +

+   Garrett-R +

+   Guillaume Gay

+   Jake Torcasso +

+   Jason Sexauer

+   Jeff Reback

+   John McNamara

+   Joris Van den Bossche

+   Joschka zur Jacobsmühlen +

+   Juarez Bochi +

+   Junya Hayashi +

+   K.-Michael Aye

+   Kerby Shedden +

+   Kevin Sheppard

+   Kieran O’Mahony

+   Kodi Arfer +

+   Matti Airas +

+   Min RK +

+   Mortada Mehyar

+   Robert +

+   Scott E Lasley

+   Scott Lasley +

+   Sergio Pascual +

+   Skipper Seabold

+   Stephan Hoyer

+   Thomas Grainger

+   Tom Augspurger

+   TomAugspurger

+   Vladimir Filimonov +

+   Vyomkesh Tripathi +

+   Will Holmgren

+   Yulong Yang +

+   behzad nouri

+   bertrandhaut +

+   bjonen

+   cel4 +

+   clham

+   hsperr +

+   ischwabacher

+   jnmclarty

+   josham +

+   jreback

+   omtinez +

+   roch +

+   sinhrks

+   unutbu
