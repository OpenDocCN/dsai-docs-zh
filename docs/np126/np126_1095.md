# 发布一个版本

> 原文：[`numpy.org/doc/1.26/dev/releasing.html`](https://numpy.org/doc/1.26/dev/releasing.html)

以下指南详细介绍了如何准备 NumPy 的发布。

## 如何准备发布

这些说明提供了构建 NumPy 二进制发布版本所需的概述。

### 当前的构建和发布信息

有关以下位置可以找到有用的信息：

+   **源代码**

    +   [INSTALL.rst](https://github.com/numpy/numpy/blob/main/INSTALL.rst)

    +   [pavement.py](https://github.com/numpy/numpy/blob/main/pavement.py)

+   **NumPy 文档**

    +   [`github.com/numpy/numpy/blob/main/doc/HOWTO_RELEASE.rst`](https://github.com/numpy/numpy/blob/main/doc/HOWTO_RELEASE.rst)

    +   [`github.com/numpy/numpy/blob/main/doc/RELEASE_WALKTHROUGH.rst`](https://github.com/numpy/numpy/blob/main/doc/RELEASE_WALKTHROUGH.rst)

    +   [`github.com/numpy/numpy/blob/main/doc/BRANCH_WALKTHROUGH.rst`](https://github.com/numpy/numpy/blob/main/doc/BRANCH_WALKTHROUGH.rst)

+   **发行脚本**

    +   [`github.com/numpy/numpy-vendor`](https://github.com/numpy/numpy-vendor)

### 支持的平台和版本

[NEP 29](https://numpy.org/neps/nep-0029-deprecation_policy.html#nep29)概述了支持的 Python 版本；2020 年上半年，支持 Python >= 3.6\. 我们每次合并代码到主分支时都会对所有这些版本进行测试。部分版本可能提供了二进制安装包（详见下文）。

+   **OS X**

    支持的 OS X 版本 >= 10.9 ，有关 Python 版本的支持情况请参见 [NEP 29](https://numpy.org/neps/nep-0029-deprecation_policy.html#nep29)。我们为与 Python.org Python、系统提供的 Python、homebrew 和 macports 兼容的 OS X 上构建了二进制 wheel 文件 —— 参见此 [OSX wheel 构建摘要](https://github.com/MacPython/wiki/wiki/Spinning-wheels) 以获取详细信息。

+   **Windows**

    我们在 Windows 上构建 32 位和 64 位的 wheel 文件。支持 Windows 7, 8 和 10 。我们使用 [mingw-w64 工具链](https://mingwpy.github.io)、[cibuildwheels](https://cibuildwheel.readthedocs.io/en/stable/) 和 GitHub actions 来构建 NumPy。

+   **Linux**

    我们为 NumPy 构建和发布了 [manylinux2014](https://www.python.org/dev/peps/pep-0513) 的 wheel 文件。许多 Linux 发行版包括了他们自己构建的二进制 NumPy 版本。

+   **BSD / Solaris**

    没有提供二进制文件，但已经有关于 Solaris 和 BSD 的成功构建报告。

### 工具链

我们在云基础设施上构建所有的 wheel 文件 —— 因此这份编译器列表仅供本地构建的信息和调试参考。详见[numpy wheels](https://github.com/MacPython/numpy-wheels)存储库中的 `.travis.yml` 脚本，其中含有已过时的创建构建脚本的来源，使用 multibuild 工具。

#### 编译器

在每个平台上，使用与 Python 本身构建时相同的 gcc 版本。目前如下：

+   OS X 构建目前在 travis 上使用 *clang*。当针对 Python.org 安装包构建时，似乎可以安全地从 travis-ci 的 OS X 10.9 虚拟机上构建适用于 OSX >= 10.6 的二进制 wheel；

+   Windows 构建使用 [mingw-w64 工具链](https://mingwpy.github.io)；

+   Manylinux2014 wheels 使用 Manylinux docker 镜像提供的 gcc。

您将需要 Cython 来构建二进制文件。Cython 将 NumPy 分发中的 `.pyx` 文件编译为 `.c` 文件。

#### OpenBLAS

所有的 wheels 链接到通过 [openblas-libs](https://github.com/MacPython/openblas-libs) 仓库提供的 [OpenBLAS](https://github.com/xianyi/OpenBLAS) 版本。共享对象（或 DLL）与 wheel 一起发布，重命名以防止与文件系统中可能存在的其他 OpenBLAS 共享对象的名称冲突。

#### 构建源代码存档和 wheels

NumPy wheels 和 sdist 现在使用 cibuildwheel 和 github actions 构建。

#### 构建文档

我们不再构建 pdf 文件，只有 html 文档。需要上传到文档服务器的 `numpy-html.zip` 可以使用 `spin docs dist` 构建。

要将必要的文档构建依赖项安装到开发环境中，请运行 `pip install -r doc_requirements.txt`。

#### 上传到 PyPI

上传所需的唯一应用程序是

+   twine （pip）。

您还需要一个 PyPI 令牌，最好将其保存在一个钥匙链上。请参阅 twine 的 [keyring](https://twine.readthedocs.io/en/stable/#keyring-support) 文档以了解如何做到这一点。

#### 生成作者和 PR 列表

您将需要个人访问令牌 [`help.github.com/articles/creating-a-personal-access-token-for-the-command-line/`](https://help.github.com/articles/creating-a-personal-access-token-for-the-command-line/)，以便脚本可以访问 github NumPy 仓库。

+   gitpython（pip）

+   pygithub（pip）

### 发布的内容

+   **Wheels** 我们目前支持 Windows、OSX 和 Linux 上的 Python 3.8-3.10。

    +   Windows：32 位和 64 位的 wheels 使用 Github actions 构建；

    +   OSX：使用 Github actions 构建的 x64_86 和 arm64 OSX wheels；

    +   Linux：使用 Github actions 构建的 x64_86 和 aarch64 Manylinux2014 wheels。

+   **其他** 发布说明和变更日志

+   **源代码分发** 我们以 .tar.gz 格式构建源代码发布版。

### 发布流程

#### 确定发布计划

一个典型的发布计划是一个 beta 版本、两个发布候选版本和一个最终版本。最好先在邮件列表上讨论时间，以便人们及时提交他们的代码、合并文档 wiki 编辑等。确定日期后，在主分支上创建一个新的 maintenance/x.y.z 分支，并为下一个版本添加新的空白发布说明，并更新 Trac 里程碑。

#### 确保当前分支正确构建一个软件包

当 PR 标题以 `REL` 开头时，CI 构建 wheels。在发布之前，您最后的 PR 应该标记为这样，并且所有测试都应该通过。您也可以执行以下操作：

```py
git clean -fxdq
python setup.py bdist_wheel
python setup.py sdist 
```

有关构建过程的详细信息，最好阅读下面的逐步说明。

注意

以下步骤将针对 beta 版、发布候选版和最终发布版进行重复。

#### 检查弃用项

在制作发布分支之前，应检查所有应该删除的弃用代码是否实际删除，所有新的弃用说明都应在文档字符串或弃用警告中说明代码将在哪个版本被移除。

#### 检查 C API 版本号

C API 版本需要在三个地方跟踪

+   numpy/core/setup_common.py

+   numpy/core/code_generators/cversions.txt

+   numpy/core/include/numpy/numpyconfig.h

这个过程有三个步骤。

1.  如果 API 发生了变化，请在 setup_common.py 中增加 C_API_VERSION。仅当针对当前 API 编译的任何代码与上一个已发布的 NumPy 版本向后兼容时，API 才未改变。对 C 结构的任何更改或对公共接口的添加将使新 API 不向后兼容。

1.  如果步骤 1 中的 C_API_VERSION 已更改，或者 API 的哈希值已更改，需要更新 cversions.txt 文件。要检查哈希值，请运行脚本 numpy/core/cversions.py，并注意打印的 API 哈希值。如果该哈希值与 numpy/core/code_generators/cversions.txt 中的最后一个哈希值不匹配，那么哈希值已更改。使用相应的 C_API_VERSION 和哈希值，在 cversions.txt 中添加新条目。如果 API 版本没有更改，但哈希值不同，则需要注释掉该 API 版本的先前条目。例如，在 NumPy 1.9 中添加了注释，这改变了哈希值，但 API 与 1.8 中的相同。哈希值用作 API 变更的检查，但并非是最终确定其是否变更的依据。

    如果步骤 1 和 2 执行正确，编译发布不应该出现“在构建开始时检测到 API 不匹配”的警告。

1.  numpy/core/include/numpy/numpyconfig.h 将需要一个新的 NPY_X_Y_API_VERSION 宏，其中 X 和 Y 是版本的主要和次要版本号。只有当包含文件中的一些函数或宏被弃用时，才需要增加给该宏的值，从上一版本增加即可。

numpy/core/setup_common.py 中的 C ABI 版本号仅适用于主要版本的更新。

#### 检查发布说明

使用[towncrier](https://pypi.org/project/towncrier/)构建发布说明并提交更改。这将从`doc/release/upcoming_changes`中删除所有片段，并添加`doc/release/<version>-note.rst`。

> towncrier build –version “<version>” git commit -m”Create release note”

检查发布说明是否最新。

使用 Highlight 部分更新发布说明。提及以下一些内容：

+   主要新功能

+   弃用和删除的功能

+   支持的 Python 版本

+   对于 SciPy，支持的 NumPy 版本

+   不久的将来展望

## 逐步指引

这是对在 Linux 上进行的 NumPy 1.21.0 发布的演练，修改为使用 GitHub Actions 和 cibuildwheels 构建，并上传到[NumPy 的 anaconda.org 暂存库](https://anaconda.org/multibuild-wheels-staging/numpy)。命令可以复制到命令行中，但一定要将 1.21.0 替换为正确的版本。应与通用发布指南一起阅读。

### 设施准备

在开始发布之前，请使用 `*_requirements.txt` 文件确保您拥有所需的软件。大多数软件都可以使用 pip 安装，但某些软件将需要 apt-get、dnf 或您的系统用于软件的任何其他方式。您还需要一个 GitHub 个人访问令牌（PAT）来推送文档。有几种方法可以简化流程：

+   Git 可以设置使用密钥环来存储您的 GitHub 个人访问令牌。在线搜索详细信息。

+   您可以使用 `keyring` 应用程序存储 twine 的 PyPI 密码。查看在线 twine 文档以获取详细信息。

### 发布准备

#### 添加/删除 Python 版本

当添加或删除 Python 版本时，需要编辑三个文件：

+   .github/workflows/wheels.yml # 用于 github cibuildwheel

+   .travis.yml # 用于 cibuildwheel aarch64 构建

+   setup.py # 用于分类器和最低版本检查。

在主分支上进行这些更改，并在必要时进行回溯。在提交摘要中使用 *BLD:* 前缀（构建标签）将导致运行轮子构建，以便对更改进行测试。我们目前在第一个 Python rc 之后的多个 Linux 平台和 cibuildwheel 支持的 Python 版本中发布轮子。对于 Python 3.11，我们能够在 rc1 公告发布后的一周内发布。

#### 回溯拉取请求

标记为此发布的更改必须回溯到维护/1.21.x 分支。

#### 更新发布文档

在发布之前通常需要更新或创建四个文档：

+   变更日志

+   发布说明

+   `.mailmap` 文件

+   文件 `doc/source/release.rst`

这些更改应作为针对维护分支的普通 PR 进行。发布后，除了 `doc/source/release.rst` 外，所有文件都需要向主分支进行向前移植。

##### 生成变更日志

变更日志是使用变更日志工具生成的：

```py
$ python tools/changelog.py $GITHUB v1.20.0..maintenance/1.21.x > doc/changelog/1.21.0-changelog.rst 
```

其中 `GITHUB` 包含您的 GitHub 访问令牌。文本需要检查非标准贡献者名称，并删除 dependabot 条目。还要删除可能存在于 PR 标题中的任何链接，因为它们在 markdown 中不易转换，用等宽文本替换它们。非标准的贡献者名称应通过更新 `.mailmap` 文件来修复，这是一项艰巨的工作。最好在达到此点之前进行几次试运行，并使用 GitHub 问题对恶意用户发出提醒，以获取所需信息。

##### 完成发布说明

如果这是系列中的第一个发布，则将生成发布说明，查看`doc/release/upcoming_changes/README.rst`中的发布说明以查看如何操作。生成发布说明还会删除`doc/release/upcoming_changes/`中的所有新闻片段文件。

生成的发布说明总是需要一些修复，引言需要编写，重要的更改应该被指出。对于补丁发布，可能还会追加更改日志文本，但对于初始版本不会，因为它太长。查看以前的发布说明以了解如何操作。请注意，如果存在顶部的`:orphan:`标记，需要更改为`.. currentmodule:: numpy`，并且需要更新`doc/source/release.rst`索引文件。

##### 检查`pavement.py`文件

检查`pavement.py`文件指向正确的发布说明。应该在上次发布后进行更新，但如果没有，请现在进行修复：

```py
$ gvim pavement.py 
```

### 发布演示

请注意，在下面的代码段中，`upstream`指 GitHub 上的根存储库，`origin`指其在您个人 GitHub 存储库中的派生。如果您没有派生存储库，而是在本地克隆了它，则可能需要进行调整。您还可以编辑`.git/config`并添加`upstream`（如果尚未存在）。

#### 1\. 准备发布提交

检查用于发布的分支，确保它是最新的，并清理存储库：

```py
$ git checkout maintenance/1.21.x
$ git pull upstream maintenance/1.21.x
$ git submodule update
$ git clean -xdfq 
```

理智检查：

```py
$ python3 -m spin test -m full 
```

标记发布并推送标签。这需要对 numpy 存储库有写权限：

```py
$ git tag -a -s v1.21.0 -m"NumPy 1.21.0 release"
$ git push upstream v1.21.0 
```

如果需要由于错误删除标签：

```py
$ git tag -d v1.21.0
$ git push --delete upstream v1.21.0 
```

#### 2\. 构建轮子

##### 通过 cibuildwheel 生成轮子（首选）

在此过程开始时标记构建将通过 cibuildwheel 触发轮子生成，并将轮子和 sdist 上传到暂存存储库。在 GitHub 操作中运行（对于所有基于 x86 和 macOS arm64 的轮子）大约需要 1 小时 15 分钟。在 travis 上运行（对于 aarch64）需要更少的时间。您可以在[暂存存储库](https://anaconda.org/multibuild-wheels-staging/numpy/files)上查看已上传的文件，但请注意它与您所看到的运行作业并不完全同步。

如果希望手动触发轮子生成，可以这样做：

+   在 GitHub 操作-> [Wheel builder](https://github.com/numpy/numpy/actions/workflows/wheels.yml)上有“运行工作流”按钮，点击它并选择要构建的标签

+   在[travis](https://app.travis-ci.com/github/numpy/numpy)上有一个“更多选项”按钮，点击它并选择要构建的分支。看起来没有构建标签的选项。

如果轮子生成失败是由于不相关的原因，你可以单独重新运行：

+   在 GitHub 操作中选择[Wheel builder](https://github.com/numpy/numpy/actions/workflows/wheels.yml)，点击包含您想要重新运行的构建的提交。左侧有轮子生成的列表，选择您想要重新运行的那个，然后在生成的页面上点击逆时针箭头按钮。

+   在[travis](https://app.travis-ci.com/github/numpy/numpy)上选择失败的构建，这将带您到该构建的 travis 作业。点击重新启动作业按钮。

请注意，如果您需要重新运行作业，则需要删除 anaconda [staging repository](https://anaconda.org/multibuild-wheels-staging/numpy/files)中已上传的文件（如果有的话）。旧文件将不会被覆盖。

#### 3\. 下载轮子

当所有轮子都已成功构建和分阶段时，使用`tools/download-wheels.py`脚本从 Anaconda 分阶段目录下载它们：

```py
$ cd ../numpy
$ mkdir -p release/installers
$ python3 tools/download-wheels.py 1.21.0 
```

#### 4\. 生成 README 文件

这需要在所有安装程序被下载后完成，但在更新路面文件以进行持续开发之前完成：

```py
$ paver write_release 
```

#### 5\. 将维护分支重置为开发状态（跳过预发布）

创建下一个版本的发布说明并编辑它们以设置版本。这些说明将是一个框架，内容很少：

```py
$ cp doc/source/release/template.rst doc/source/release/1.21.1-notes.rst
$ gvim doc/source/release/1.21.1-notes.rst
$ git add doc/source/release/1.21.1-notes.rst 
```

将新的发布说明添加到文档发布列表中，并在`pavement.py`中更新`RELEASE_NOTES`变量：

```py
$ gvim doc/source/release.rst pavement.py 
```

提交结果：

```py
$ git commit -a -m"REL: prepare 1.21.x for further development"
$ git push upstream HEAD 
```

#### 6\. 上传到 PyPI

使用`twine`上传到 PyPI。最近的`twine`版本是在最近的 PyPI 更改后需要的，这里使用的版本是`3.4.1`：

```py
$ cd ../numpy
$ twine upload release/installers/*.whl
$ twine upload release/installers/numpy-1.21.0.tar.gz  # Upload last. 
```

如果其中一个命令在中间中断，您可能需要选择性地上传剩余的文件，因为 PyPI 不允许相同的文件上传两次。应该最后上传源文件，以避免在此过程中 pip 用户访问文件时可能出现的同步问题，这会导致 pip 从源代码构建而不是下载二进制 wheel。PyPI 只允许单个源分发，这里我们选择了 zip 归档。

#### 7\. 将文件上传到 github

转到[`github.com/numpy/numpy/releases`](https://github.com/numpy/numpy/releases)，那里应该有一个`v1.21.0 tag`，点击它并点击该标签的编辑按钮。有两种添加文件的方法，使用可编辑的文本窗口和作为二进制上传。首先编辑`release/README.md`，该文件是使用 pandoc 从 rst 版本翻译的。需要修复的内容：如果包括，来自 changelog 的 PR 行被包裹并需要解包，链接应更改为等宽文本。然后将内容复制到剪贴板并粘贴到文本窗口中。可能需要多次尝试才能看起来正确。然后

+   将`release/installers/numpy-1.21.0.tar.gz`上传为二进制文件。

+   将`release/README.rst`上传为二进制文件。

+   将`doc/changelog/1.21.0-changelog.rst`上传为二进制文件。

+   如果这是预发布，请勾选预发布按钮。

+   在底部点击`{发布，更新}发布`按钮。

#### 8\. 将文档上传到 numpy.org（跳过预发布）

注意

您将需要一个 GitHub 个人访问令牌来推送更新。

这一步仅适用于最终版本，对于预发布和大多数补丁发布，可以跳过。`make merge-doc`将`numpy/doc`仓库克隆到`doc/build/merge`并用新文档更新它：

```py
$ git clean -xdfq
$ git co v1.21.0
$ pushd doc
$ make docenv && source docenv/bin/activate
$ make merge-doc
$ pushd build/merge 
```

如果发布系列是一个新的，你需要在`doc/build/merge/index.html`首页的“在这里插入”注释后添加一个新部分：

```py
$ gvim index.html +/'insert here' 
```

此外，更新版本切换器 json 文件以添加新版本，并更新标记为*(stable)*的版本：

```py
$ gvim _static/versions.json 
```

否则，只需要更新`zip`链接的标签名称。因为我们不再生成`pdf`文件，如果有的话，去掉`pdf`文件的那行：

```py
$ gvim index.html +/'tag v1.21' 
```

你可以在浏览器中“测试运行”新的文档，以确保链接有效：

```py
$ firefox index.html  # or google-chrome, etc. 
```

更新稳定链接并更新：

```py
$ ln -sfn 1.21 stable
$ ls -l  # check the link 
```

一切似乎令人满意后，更新、提交并上传更改：

```py
$ python3 update.py
$ git commit -a -m"Add documentation for v1.21.0"
$ git push
$ deactivate
$ popd
$ popd 
```

#### 9\. 在 numpy.org 上宣布发布（预发布除外）

假设你已经 forked [`github.com/numpy/numpy.org`](https://github.com/numpy/numpy.org)：

```py
$ cd ../numpy.org
$ git checkout main
$ git pull upstream main
$ git checkout -b announce-numpy-1.21.0
$ gvim content/en/news.md 
```

+   对于所有的发布，转到页面底部添加一行链接。查看以前的链接作为示例。

+   对于循环中的`*.0`发布，在顶部添加一个新部分，简要描述新功能，并将新闻链接指向它。

提交并推送：

```py
$ git commit -a -m"announce the NumPy 1.21.0 release"
$ git push origin HEAD 
```

转到你的 Github fork 并创建一个 pull request。

#### 10\. 在邮件列表上宣布

应该在 numpy-discussion、scipy-devel、scipy-user 和 python-announce-list 邮件列表上宣布发布。查看以前的公告以获取基本模板。贡献者和 PR 名单与上面生成的发布说明相同。如果交叉发布，请确保 python-announce-list 是密件抄送，以便回复不会发送到该列表。

#### 11\. 发布后任务（预发布除外）

检出主分支并将文档更改前向加入：

```py
$ git checkout -b post-1.21.0-release-update
$ git checkout maintenance/1.21.x doc/source/release/1.21.0-notes.rst
$ git checkout maintenance/1.21.x doc/changelog/1.21.0-changelog.rst
$ git checkout maintenance/1.21.x .mailmap  # only if updated for release.
$ gvim doc/source/release.rst  # Add link to new notes
$ git status  # check status before commit
$ git commit -a -m"MAINT: Update main after 1.21.0 release."
$ git push origin HEAD 
```

前往 GitHub 提交 PR。

#### 12\. 更新 oldest-supported-numpy

如果这个版本是第一个支持新的 Python 版本，或者第一个为新平台或 PyPy 版本提供轮子的版本，应该更新[`github.com/scipy/oldest-supported-numpy`](https://github.com/scipy/oldest-supported-numpy)中的版本固定。要么提交一个带有`setup.cfg`更改的 PR，要么提交一个带有所需更改信息的问题。

## 分支演练

本指南包含了在 Linux 上分支 NumPy 1.21.x 的操作步骤。命令可以复制到命令行，但请务必根据实际版本替换 1.21 和 1.22。在制作分支之前，尽可能使`.mailmap`尽可能新是个好习惯，可能需要几周的时间。

这应该与通用发布指南一起阅读。

### 分支

#### 创建分支

这只需要在开始一个新的维护分支时才需要。由于 NumPy 现在依赖标签来确定版本，在主分支中开始新的开发周期需要一个有注释的标签。操作如下：

```py
$ git checkout main
$ git pull upstream main
$ git commit --allow-empty -m'REL: Begin NumPy 1.22.0 development'
$ git push upstream HEAD 
```

如果推送失败，因为新的 PR 已经合并，执行如下操作：

```py
$ git pull --rebase upstream 
```

并且重复推送。一旦推送成功，请打标签：

```py
$ git tag -a -s v1.22.0.dev0 -m'Begin NumPy 1.22.0 development'
$ git push upstream v1.22.0.dev0 
```

然后创建新的分支并推送：

```py
$ git branch maintenance/1.21.x HEAD^
$ git push upstream maintenance/1.21.x 
```

#### 准备主分支进行进一步开发

创建 PR 分支以准备主分支进行进一步开发：

```py
$ git checkout -b 'prepare-main-for-1.22.0-development' v1.22.0.dev0 
```

删除发布说明碎片：

```py
$ git rm doc/release/upcoming_changes/[0-9]*.*.rst 
```

创建新的发行说明骨架并添加到索引中：

```py
$ cp doc/source/release/template.rst doc/source/release/1.22.0-notes.rst
$ gvim doc/source/release/1.22.0-notes.rst  # put the correct version
$ git add doc/source/release/1.22.0-notes.rst
$ gvim doc/source/release.rst  # add new notes to notes index
$ git add doc/source/release.rst 
```

更新`pavement.py`并更新`RELEASE_NOTES`变量以指向新的说明：

```py
$ gvim pavement.py
$ git add pavement.py 
```

更新`cversions.txt`以添加当前发行版。在这个早期阶段，不需要担心新的哈希值，只需在之前的做法后面添加注释即可：

```py
$ gvim numpy/core/code_generators/cversions.txt
$ git add numpy/core/code_generators/cversions.txt 
```

检查你的工作，提交并推送：

```py
$ git status  # check work
$ git commit -m'REL: Prepare main for NumPy 1.22.0 development'
$ git push origin HEAD 
```

现在创建一个拉取请求。## 如何准备一个发行版

这些说明概述了构建 NumPy 二进制版本所需的必要步骤。

### 当前的构建和发��信息

有关有用的信息，请参见以下位置：

+   **源代码树**

    +   [INSTALL.rst](https://github.com/numpy/numpy/blob/main/INSTALL.rst)

    +   [pavement.py](https://github.com/numpy/numpy/blob/main/pavement.py)

+   **NumPy 文档**

    +   [`github.com/numpy/numpy/blob/main/doc/HOWTO_RELEASE.rst`](https://github.com/numpy/numpy/blob/main/doc/HOWTO_RELEASE.rst)

    +   [`github.com/numpy/numpy/blob/main/doc/RELEASE_WALKTHROUGH.rst`](https://github.com/numpy/numpy/blob/main/doc/RELEASE_WALKTHROUGH.rst)

    +   [`github.com/numpy/numpy/blob/main/doc/BRANCH_WALKTHROUGH.rst`](https://github.com/numpy/numpy/blob/main/doc/BRANCH_WALKTHROUGH.rst)

+   **发行脚本**

    +   [`github.com/numpy/numpy-vendor`](https://github.com/numpy/numpy-vendor)

### 支持的平台和版本

[NEP 29](https://numpy.org/neps/nep-0029-deprecation_policy.html#nep29)概述了支持的 Python 版本；在 2020 年上半年，这将是 Python >= 3.6\. 我们每次将代码合并到主代码库时，都会对所有这些版本的 NumPy 进行测试。二进制安装程序可能仅适用于其中一部分版本（请见下文）。

+   **OS X**

    支持的 OS X 版本为 10.9 及以上，有关 Python 版本支持，请参见[NEP 29](https://numpy.org/neps/nep-0029-deprecation_policy.html#nep29)（在 NumPy Enhancement Proposals 中）。我们构建了与 Python.org Python、系统 Python、homebrew 和 macports 兼容的 OSX 二进制 wheel 文件-有关详细信息，请参见此[OSX wheel 构建摘要](https://github.com/MacPython/wiki/wiki/Spinning-wheels)。

+   **Windows**

    我们在 Windows 上构建了 32 位和 64 位的 wheel 文件。支持 Windows 7、8 和 10。我们使用[mingw-w64 工具链](https://mingwpy.github.io)，[cibuildwheels](https://cibuildwheel.readthedocs.io/en/stable/)和 GitHub actions 来构建 NumPy。

+   **Linux**

    对于 NumPy，我们构建并发布了[manylinux2014](https://www.python.org/dev/peps/pep-0513)的 wheel 文件。许多 Linux 发行版中已经包含了自己的 NumPy 二进制版本。

+   **BSD / Solaris**

    不提供二进制文件，但已经有反馈表示在 Solaris 和 BSD 上成功构建。

### 工具链

我们在云计算环境中构建所有的 wheel 文件，所以这个编译器列表仅供信息和本地构建调试使用。使用 multibuild 可以在[numpy wheels](https://github.com/MacPython/numpy-wheels) 存储库的`.travis.yml`脚本中找到过时的构建脚本。

#### 编译器

在各个平台上，使用的 gcc 版本与 Python 本身使用的版本相同。目前情况如下：

+   目前 travis 上的 OS X 构建使用*clang*。当针对 Python.org 安装程序构建时，似乎可以安全地从 travis-ci OSX 10.9 虚拟机构建 OSX >= 10.6 的二进制 wheels；

+   Windows 构建使用[mingw-w64 工具链](https://mingwpy.github.io)；

+   Manylinux2014 wheels 使用 Manylinux docker 镜像上提供的 gcc。

你需要 Cython 来构建二进制文件。Cython 将 NumPy 分发中的`.pyx`文件编译成`.c`文件。

#### OpenBLAS

所有的 wheels 链接到通过[openblas-libs](https://github.com/MacPython/openblas-libs)仓库提供的[OpenBLAS](https://github.com/xianyi/OpenBLAS)的一个版本。共享对象（或 DLL）与 wheels 一起发布，重命名以防止与文件系统中可能存在的其他 OpenBLAS 共享对象发生重名冲突。

#### 构建源代码存档和 wheels

NumPy 的 wheels 和 sdist 现在使用 cibuildwheel 与 github actions 构建。

#### 生成文档

我们不再构建 pdf 文件，只有 html 文档。上传到文档服务器所需的`numpy-html.zip`可以使用`spin docs dist`构建。

要在您的开发环境中安装必要的文档构建依赖项，请运行`pip install -r doc_requirements.txt`。

#### 上传到 PyPI

上传所需的唯一应用程序是

+   twine(pip)。

你还需要一个 PyPI 令牌，最好放在钥匙链上。请参阅 twine [keyring](https://twine.readthedocs.io/en/stable/#keyring-support)文档，了解如何操作。

#### 生成作者/PR 列表

你需要一个[`help.github.com/articles/creating-a-personal-access-token-for-the-command-line/`](https://help.github.com/articles/creating-a-personal-access-token-for-the-command-line/)，以便脚本可以访问 github 的 NumPy 仓库。

+   gitpython(pip)

+   pygithub(pip)

### 发布了什么

+   **Wheels** 我们目前支持 Windows、OSX 和 Linux 上的 Python 3.8-3.10。

    +   Windows：32 位和 64 位 wheels 使用 Github actions 构建；

    +   OSX：x64_86 和 arm64 OSX wheels 使用 Github actions 构建；

    +   Linux：x64_86 和 aarch64 Manylinux2014 wheels 使用 Github actions 构建。

+   **其他** 发布说明和更新日志

+   **源代码发布** 我们以.tar.gz 格式构建源发布。

### 发布流程

#### 确定发布计划

典型的发布计划是一个 beta 版、两个候选版本和一个最终版。最好先在邮件列表上讨论时间，以便人们能及时提交他们的提交，合并文档 wiki 编辑等。在确定日期后，创建一个新的 maintenance/x.y.z 分支，在主分支中添加新的空发布说明版本，并更新 Trac Milestones。

#### 确保当前分支正确构建一个包

当 PR 标题以`REL`开头时，CI 会构建 wheels。在发布之前，你的最后一个 PR 应该这样标记，并且所有的测试都应该通过。你也可以：

```py
git clean -fxdq
python setup.py bdist_wheel
python setup.py sdist 
```

关于构建过程的详细信息，最好阅读下面的逐步指南。

注意

以下步骤会重复进行 beta 版本，候选发布版本和最终发布版本。

#### 检查废弃

在制作发布分支之前，应检查所有应移除的已废弃代码是否实际上已移除，并且所有新的弃用会在文档字符串或弃用警告中说明代码将在哪个版本中移除。

#### 检查 C API 版本号

C API 版本需要在三个地方跟踪

+   numpy/core/setup_common.py

+   numpy/core/code_generators/cversions.txt

+   numpy/core/include/numpy/numpyconfig.h

该过程有三个步骤。

1.  如果 API 已更改，请在 setup_common.py 中递增 C_API_VERSION。只有在与上一个发布的 NumPy 版本具有向后兼容性的任何代码编译后，API 才不会更改。对 C 结构的任何更改或添加到公共接口将使新 API 不具备向后兼容性。

1.  如果第一步中的 C_API_VERSION 已更改，或者 API 的哈希已更改，则需要更新 cversions.txt 文件。要检查哈希，请运行脚本 numpy/core/cversions.py 并注意打印的 API 哈希。如果该哈希与 numpy/core/code_generators/cversions.txt 中的最后一个哈希不匹配，则该哈希已更改。使用适当的 C_API_VERSION 和哈希，向 cversions.txt 添加一个新条目。如果 API 版本未更改，但哈希不同，则需要注释掉该 API 版本的先前条目。例如，在 NumPy 1.9 中添加了注释，这改变了哈希，但 API 与 1.8 中的相同。哈希用作 API 更改的检查，但不是确定性的。

    如果步骤 1 和 2 正确执行，编译发布不会出现“在构建开始时检测到 API 不匹配”的警告。

1.  numpy/core/include/numpy/numpyconfig.h 将需要一个新的 NPY_X_Y_API_VERSION 宏，其中 X 和 Y 是发布的主要和次要版本号。只有在包含文件中的一些函数或宏已被废弃时，才需要将该宏的赋值与上一个版本的赋值增加。

numpy/core/setup_common.py 中的 C ABI 版本号仅应在主要发布中更新。

#### 检查发布说明

使用 [towncrier](https://pypi.org/project/towncrier/) 构建发布说明并提交更改。这将删除所有来自`doc/release/upcoming_changes` 的片段，并添加`doc/release/<version>-note.rst`。

> towncrier 建立 –version “<version>” git commit -m”创建发布说明”

检查发布说明是否最新。

在发布说明中更新一个“亮点”部分。提及以下一些内容：

+   主要新功能

+   已废弃和移除的功能

+   支持的 Python 版本

+   对于 SciPy，支持的 NumPy 版本

+   近期的展望

### 当前构建和发布信息

有用信息可在以下位置找到：

+   **源代码树**

    +   [安装说明](https://github.com/numpy/numpy/blob/main/INSTALL.rst)

    +   [pavement.py](https://github.com/numpy/numpy/blob/main/pavement.py)

+   **NumPy 文档**

    +   [`github.com/numpy/numpy/blob/main/doc/HOWTO_RELEASE.rst`](https://github.com/numpy/numpy/blob/main/doc/HOWTO_RELEASE.rst)

    +   [`github.com/numpy/numpy/blob/main/doc/RELEASE_WALKTHROUGH.rst`](https://github.com/numpy/numpy/blob/main/doc/RELEASE_WALKTHROUGH.rst)

    +   [`github.com/numpy/numpy/blob/main/doc/BRANCH_WALKTHROUGH.rst`](https://github.com/numpy/numpy/blob/main/doc/BRANCH_WALKTHROUGH.rst)

+   **发布脚本**

    +   [`github.com/numpy/numpy-vendor`](https://github.com/numpy/numpy-vendor)

### 支持的平台和版本

[NEP 29](https://numpy.org/neps/nep-0029-deprecation_policy.html#nep29 "(在 NumPy Enhancement Proposals 中)") 概述了支持的 Python 版本；2020 年上半年，这将是 Python >= 3.6。我们每次将代码合并到主分支时，都会针对所有这些版本进行 NumPy 测试。可能会为这些版本的子集提供二进制安装程序（请参阅下文）。

+   **OS X**

    支持的 OS X 版本 >= 10.9，有关 Python 版本支持，请参阅 [NEP 29](https://numpy.org/neps/nep-0029-deprecation_policy.html#nep29 "(在 NumPy Enhancement Proposals 中)")。我们为与 Python.org Python、系统 Python、homebrew 和 macports 兼容的 OSX 构建二进制 wheels - 有关详情，请参阅这个 [OSX wheel 构建摘要](https://github.com/MacPython/wiki/wiki/Spinning-wheels)。

+   **Windows**

    我们在 Windows 上构建 32 位和 64 位 wheels。支持 Windows 7、8 和 10。我们使用 [mingw-w64 工具链](https://mingwpy.github.io)、[cibuildwheels](https://cibuildwheel.readthedocs.io/en/stable/) 和 GitHub actions 构建 NumPy。

+   **Linux**

    我们为 NumPy 构建并发布 [manylinux2014](https://www.python.org/dev/peps/pep-0513) wheels。许多 Linux 发行版包含其自己的 NumPy 二进制版本。

+   **BSD / Solaris**

    不提供二进制文件，但已报告在 Solaris 和 BSD 上成功构建。

### 工具链

我们在云基础设施上构建所有的 wheels - 因此，这个编译器列表仅供信息和本地调试构建使用。查看 [numpy wheels](https://github.com/MacPython/numpy-wheels) 仓库中的 `.travis.yml` 脚本，获取使用 multibuild 的构建配方的已过时源。

#### 编译器

目前，Python 在每个平台上构建时都使用与其相同的 gcc 版本。

+   目前，在 travis 上，OS X 构建使用 *clang*。从 travis-ci 的 OS X 10.9 虚拟机构建针对 Python.org 安装器的 Python >= 10.6 的二进制 wheels 似乎是安全的；

+   Windows 构建使用 [mingw-w64 工具链](https://mingwpy.github.io)；

+   Manylinux2014 wheels 使用 Manylinux docker 镜像中提供的 gcc。

你需要 Cython 来构建二进制文件。Cython 将 NumPy 分发中的 `.pyx` 文件编译为 `.c` 文件。

#### OpenBLAS

所有的组件链接到通过 [openblas-libs](https://github.com/MacPython/openblas-libs) 仓库提供的 [OpenBLAS](https://github.com/xianyi/OpenBLAS) 版本。共享对象（或 DLL）随组件一起提供，并已重命名，以防止与可能存在于文件系统中的其他 OpenBLAS 共享对象发生名称冲突。

#### 构建源存档和组件

NumPy 组件和源存档现在使用 github actions 进行 cibuildwheel 构建。

#### 构建文档

我们不再构建 pdf 文件，只有 html 文档。需要上传到文档服务器的 `numpy-html.zip` 可以使用 `spin docs dist` 构建。

要将所需的文档构建依赖项安装到开发环境中，请运行 `pip install -r doc_requirements.txt`。

#### 上传到 PyPI

上传所需的唯一应用程序是

+   twine (pip).

您还需要一个 PyPI 令牌，最好保存在钥匙链上。请参阅 twine [keyring](https://twine.readthedocs.io/en/stable/#keyring-support) 文档了解如何做到这一点。

#### 生成作者/PR 列表

您需要个人访问令牌 [`help.github.com/articles/creating-a-personal-access-token-for-the-command-line/`](https://help.github.com/articles/creating-a-personal-access-token-for-the-command-line/)，以便脚本可以访问 github NumPy 存储库。

+   gitpython (pip)

+   pygithub (pip)

#### 编译器

在每个平台上都使用与 Python 本身构建时相同的 gcc 版本。目前这意味着：

+   目前在 travis 上构建的 OS X 使用 *clang*。似乎可以安全地从 travis-ci OSX 10.9 VMs 构建对 Python.org 安装程序中的 Python 的 OSX >= 10.6 的二进制组件；

+   Windows 构建使用 [mingw-w64 工具链](https://mingwpy.github.io);

+   Manylinux2014 组件使用 Manylinux docker 映像中提供的 gcc。

您将需要 Cython 来构建二进制组件。Cython 将 NumPy 发行版中的 `.pyx` 文件编译为 `.c` 文件。

#### OpenBLAS

所有的组件链接到通过 [openblas-libs](https://github.com/MacPython/openblas-libs) 仓库提供的 [OpenBLAS](https://github.com/xianyi/OpenBLAS) 版本。共享对象（或 DLL）随组件一起提供，并已重命名，以防止与可能存在于文件系统中的其他 OpenBLAS 共享对象发生名称冲突。

#### 构建源存档和组件

NumPy 组件和源存档现在使用 github actions 进行 cibuildwheel 构建。

#### 构建文档

我们不再构建 pdf 文件，只有 html 文档。需要上传到文档服务器的 `numpy-html.zip` 可以使用 `spin docs dist` 构建。

要将所需的文档构建依赖项安装到开发环境中，请运行 `pip install -r doc_requirements.txt`。

#### 上传到 PyPI

上传所需的唯一应用程序是

+   twine (pip).

您还需要一个 PyPI 令牌，最好保存在钥匙链上。请参阅 twine [keyring](https://twine.readthedocs.io/en/stable/#keyring-support) 文档了解如何做到这一点。

#### 生成作者/PR 列表

你将需要一个个人访问令牌以便脚本可以访问 github NumPy 仓库[`help.github.com/articles/creating-a-personal-access-token-for-the-command-line/`](https://help.github.com/articles/creating-a-personal-access-token-for-the-command-line/)。

+   gitpython (pip)

+   pygithub (pip)

### 发行内容

+   **轮子** 我们当前支持 Python 3.8-3.10 在 Windows、OSX 和 Linux 上。

    +   Windows：使用 Github actions 构建的 32 位和 64 位轮子；

    +   OSX：使用 Github actions 构建的 x64_86 和 arm64 OSX 轮子；

    +   Linux：x64_86 和 aarch64 使用 Github actions 构建的 Manylinux2014 轮子。

+   **其他** 发行说明和更改日志

+   **源分发** 我们以 .tar.gz 格式构建源发布。

### 发行过程

#### 对发布时间表达成一致意见

一个典型的发布时间表是一个 beta 版，两个候选发布版本和一个最终发布版。最好首先在邮件列表上讨论时间表，以便人们能够及时提交他们的代码，合并文档 wiki 编辑等。设定日期后，创建一个新的维护/x.y.z 分支，在主分支中为下一个版本添加新的空发布说明并更新 Trac 里程碑。

#### 确保当前分支正确构建软件包

当 PR 标题以 `REL` 开头时，CI 会构建轮子。在发布前，你的最后一个 PR 应该标记为如此，并且所有测试都应该通过。你也可以做如下操作：

```py
git clean -fxdq
python setup.py bdist_wheel
python setup.py sdist 
```

有关构建过程的详细信息最好阅读下面的逐步说明。

注意

下列步骤将为 beta 版、候选发布版本和最终发布版本重复进行。

#### 检查弃用

在 创建发布分支 之前，应该检查所有应该删除的弃用代码是否实际上已经删除，并且所有新的弃用都应该在文档字符串或弃用警告中说明代码将在哪个版本中被移除。

#### 检查 C API 版本号

C API 版本需要在三个地方跟踪

+   numpy/core/setup_common.py

+   numpy/core/code_generators/cversions.txt

+   numpy/core/include/numpy/numpyconfig.h

整个过程分为三个步骤。

1.  如果 API 已更改，请在 setup_common.py 中递增 C_API_VERSION。只有当前 API 编译的任何代码都与上一个发布的 NumPy 版本向后兼容时，API 才不会更改。任何对 C 结构的更改或对公共接口的增加都会使新的 API 不向后兼容。

1.  如果第一步中的 C_API_VERSION 已更改，或者 API 的哈希已更改，则需要更新 cversions.txt 文件。要检查哈希值，请运行 numpy/core/cversions.py 脚本，并注意打印的 API 哈希。如果该哈希与 numpy/core/code_generators/cversions.txt 中的最后一个哈希不匹配，则哈希已更改。使用适当的 C_API_VERSION 和哈希，将新条目添加到 cversions.txt。如果 API 版本没有更改，但哈希值不同，则需要注释掉以前针对该 API 版本的条目。例如，在 NumPy 1.9 中添加了注解，这更改了哈希值，但 API 与 1.8 中相同。哈希用作 API 更改的检查，但不是最终确定。

    如果步骤 1 和 2 执行正确，编译发布版时不会出现“API 不匹配检测”的警告。

1.  numpy/core/include/numpy/numpyconfig.h 将需要一个新的 NPY_X_Y_API_VERSION 宏，其中 X 和 Y 是发布的主要和次要版本号。如果包含文件中的某些功能或宏已被弃用，则只需将分配给该宏的值从前一个版本递增即可。

numpy/core/setup_common.py 中的 C ABI 版本号应仅在主要发布版中进行更新。

#### 检查发布说明

使用 [towncrier](https://pypi.org/project/towncrier/) 构建发布说明并提交更改。这将从 `doc/release/upcoming_changes` 中移除所有片段，并添加 `doc/release/<version>-note.rst`。

> towncrier build –version “<version>” git commit -m”创建发布说明”

检查发布说明是否最新。

使用突出部分更新发布说明。提及以下一些内容：

+   主要新功能

+   弃用和删除的功能

+   支持的 Python 版本

+   对于 SciPy，支持的 NumPy 版本

+   近期展望

#### 同意发布时间表

典型的发布时间表是一个 beta 版，两个候选发布版和一个最终发布版。最好首先在邮件列表中讨论时间安排，以便人们及时提交其提交，合并文档维基编辑等。确定日期后，创建新的 maintenance/x.y.z 分支，在主要分支中添加新的空的下一个版本的发布说明，并更新 Trac 里程碑。

#### 确保当前分支正确构建软件包

当 PR 标题以 `REL` 开头时，CI 将构建 wheels。在发布之前，您的最后一个 PR 应标记为此，所有测试应通过。您也可以执行以下操作：

```py
git clean -fxdq
python setup.py bdist_wheel
python setup.py sdist 
```

对于构建过程本身的详细信息，最好阅读下面的逐步说明。

注意

以下步骤将重复适用于 beta 版、候选发布版和终版发布版。

#### 检查废弃内容

在创建发布分支之前，应检查所有应该移除的废弃代码是否确实已移除，并且所有新的废弃代码都说在文档字符串或废弃警告中代码将在哪个版本中移除。

#### 检查 C API 版本号

C API 版本需要在三个地方进行跟踪

+   numpy/core/setup_common.py

+   numpy/core/code_generators/cversions.txt

+   numpy/core/include/numpy/numpyconfig.h

这个过程分为三个步骤。

1.  如果 API 已更改，请在 setup_common.py 中增加 C_API_VERSION。只有当前 API 编译的任何代码与上一个发布的 NumPy 版本向后兼容时，API 才不会更改。对 C 结构的任何更改或公共接口的任何添加将使新 API 不向后兼容。

1.  如果第一步中的 C_API_VERSION 已更改，或者 API 的哈希值已更改，则需要更新 cversions.txt 文件。要检查哈希值，请运行脚本 numpy/core/cversions.py，并注意打印的 API 哈希值。如果该哈希值与 numpy/core/code_generators/cversions.txt 中的最后一个哈希值不匹配，则表示哈希值已更改。使用适当的 C_API_VERSION 和哈希值，向 cversions.txt 添加新条目。如果 API 版本没有更改，但哈希值不同，则需要注释掉该 API 版本的先前条目。例如，在 NumPy 1.9 中添加了注释，这更改了哈希值，但 API 与 1.8 中的相同。哈希值用作 API 更改的检查，但并不是决定性的。

    如果步骤 1 和步骤 2 正确完成，编译发布不应该出现警告“在构建开始时检测到 API 不匹配”。

1.  numpy/core/include/numpy/numpyconfig.h 将需要一个新的 NPY_X_Y_API_VERSION 宏，其中 X 和 Y 是发布的主要和次要版本号。只需增加此宏的值，如果包含文件中的一些函数或宏已被弃用。

numpy/core/setup_common.py 中的 C ABI 版本号应仅在主要版本发布时更新。

#### 检查发布说明

使用[towncrier](https://pypi.org/project/towncrier/)创建发布说明并提交更改。这将从`doc/release/upcoming_changes`中删除所有片段并添加`doc/release/<version>-note.rst`。

> towncrier build –version "<version>" git commit -m”创建发布说明”

检查发布说明是否最新。

使用突出部分更新发布说明。提到以下一些内容：

+   主要新功能

+   弃用和移除的功能

+   支持的 Python 版本

+   对于 SciPy，支持的 NumPy 版本

+   展望不久的未来

## 逐步指导

这是在 Linux 上对 NumPy 1.21.0 版本的一次漫游，为了使用 GitHub Actions 和 cibuildwheels 进行构建，并上传到[NumPy 的 anaconda.org 暂存库](https://anaconda.org/multibuild-wheels-staging/numpy)。这些命令可以复制到命令行中，但一定要确保用正确的版本替换 1.21.0。这应该与一般发布指南一起阅读。

### 设施准备

在开始制作发布之前，使用`*_requirements.txt`文件确保您拥有所需的软件。大多数软件都可以使用 pip 安装，但有些将需要 apt-get、dnf 或您系统使用的其他软件。您还需要一个 GitHub 个人访问令牌（PAT）来推送文档。有几种方法可以简化流程：

+   Git 可以设置使用密钥环来存储您的 GitHub 个人访问令牌。在网上搜索详细信息。

+   您可以使用`keyring`应用程序来存储 twine 的 PyPI 密码。有关详细信息，请参阅在线 twine 文档。

### 发布准备

#### 添加/删除 Python 版本

添加或删除 Python 版本时，需要编辑三个文件：

+   .github/workflows/wheels.yml # 用于 GitHub cibuildwheel

+   .travis.yml # 用于 cibuildwheel aarch64 构建

+   setup.py # 用于分类器和最低版本检查。

对于必要情况，这些更改应在普通的主分支 PR 中进行备份。使用*BLD:*前缀（构建标签）的提交摘要将导致 wheel 构建运行，因此更改将被测试。我们目前在 Python rc 发布后一旦 manylinux 和 cibuildwheel 支持它，就会对新的 Python 版本发布 wheels。对于 Python 3.11，我们能够在 rc1 公告发布一周后发布。

#### 回溯拉取请求

已标记为此发布的更改必须被回溯到 maintenance/1.21.x 分支。

#### 更新发布文档

在进行发布之前通常需要更新或创建四个文档：

+   更新记录

+   发布说明

+   `.mailmap`文件

+   `doc/source/release.rst`文件

这些更改应作为针对维护分支的普通 PR 进行。发布后，除了`doc/source/release.rst`之外的所有文件都需要被前向移植到主分支。

##### 生成更改日志

更改日志是使用更改日志工具生成的：

```py
$ python tools/changelog.py $GITHUB v1.20.0..maintenance/1.21.x > doc/changelog/1.21.0-changelog.rst 
```

其中`GITHUB`包含您的 GitHub 访问令牌。文本将需要检查非标准的贡献者名称，并删除 dependabot 条目。最好删除可能存在于 PR 标题中的任何链接，因为它们在 markdown 中无法很好地转化，用等宽文本替换它们。非标准的贡献者名称应通过更新`.mailmap`文件进行修正，这是一项大量的工作。最好在达到这一点之前进行几次试运行，并使用 GitHub 问题 ping 那些恶意行为者以获得所需的信息。

##### 完成发布说明

如果这是一个系列中的第一个发布，将生成发布说明，请参阅`doc/release/upcoming_changes/README.rst`中的发布说明以了解如何操作。生成发布说明也会删除`doc/release/upcoming_changes/`中的所有新闻片段文件。

生成的发布说明始终需要一些修复，需要编写简介，并应该突出显示重大更改。对于补丁发布，changelog 文本可能也会被附加，但对于初始发布则不会，因为它太长了。查看以前的发布说明以了解如何操作。请注意，如果有顶部的 `:orphan:` 标记，则需要将其更改为 `.. currentmodule:: numpy`，并需要更新 `doc/source/release.rst` 索引文件。

##### 检查 `pavement.py` 文件

检查 pavement.py 文件是否指向了正确的发布说明。它应该在上次发布之后已经更新，但如果没有，请立即修复：

```py
$ gvim pavement.py 
```

### 发布的步骤

请注意，在下面的代码片段中，`upstream` 指的是 GitHub 上的根存储库，`origin` 指的是您个人 GitHub 存储库中的分支。如果您没有从存储库中派生出一个分支，而只是在本地克隆了它，您可能需要进行一些修改。您还可以编辑 `.git/config` 并添加 `upstream`，如果它还没有出现的话。

#### 1\. 准备发布提交

检出发布的分支，确保它是最新的，并清理仓库：

```py
$ git checkout maintenance/1.21.x
$ git pull upstream maintenance/1.21.x
$ git submodule update
$ git clean -xdfq 
```

审查

```py
$ python3 -m spin test -m full 
```

给发布打上标签并推送标签。这需要对 numpy 仓库有写权限：

```py
$ git tag -a -s v1.21.0 -m"NumPy 1.21.0 release"
$ git push upstream v1.21.0 
```

如果您由于错误而需要删除标签：

```py
$ git tag -d v1.21.0
$ git push --delete upstream v1.21.0 
```

#### 2\. 构建 wheels

##### 通过 cibuildwheel 构建 wheels（首选方法）

在此过程开始时标记构建将会触发会通过 cibuildwheel 构建 wheel 并将 wheels 和一个 sdist 上传到暂存库。在 github actions 上的 CI 运行（对于所有基于 x86 的和 macOS arm64 的 wheels）大约需要 1 1/4 小时。在 travis 上（对于 aarch64）的 CI 运行需要较少的时间。您可以在[暂存库](https://anaconda.org/multibuild-wheels-staging/numpy/files)中检查已上传的文件，但请注意它与您所看到的运行任务的实时同步程度不是很高。

如果您希望手动触发一个 wheel 构建，可以这样做：

+   在 github actions -> [Wheel builder](https://github.com/numpy/numpy/actions/workflows/wheels.yml) 上有一个“Run workflow”的按钮，点击它并选择要构建的标签

+   在 [travis](https://app.travis-ci.com/github/numpy/numpy) 上有一个“More Options”的按钮，点击它并选择一个要构建的分支。似乎没有构建标签的选项。

如果一个 wheel 构建由于不相关原因失败，您可以单独重新运行它：

+   在 github actions 中选择[Wheel builder](https://github.com/numpy/numpy/actions/workflows/wheels.yml)点击包含要重新运行的构建的提交。在左边有一个 wheel 构建的列表，选择您要重新运行的构建，并在生成的页面上点击逆时针方向的箭头按钮。

+   在 [travis](https://app.travis-ci.com/github/numpy/numpy) 上选择失败的构建，这将带您进入该构建的 travis 作业。点击重新开始作业按钮。

请注意，如果您需要重新运行作业，则需要删除上传的文件（如果有的话），在 anaconda [staging repository](https://anaconda.org/multibuild-wheels-staging/numpy/files) 中，旧文件不会被覆盖。

#### 3\. 下载轮子

当所有轮子成功构建并暂存后，使用 `tools/download-wheels.py` 脚本从 Anaconda 暂存目录下载它们：

```py
$ cd ../numpy
$ mkdir -p release/installers
$ python3 tools/download-wheels.py 1.21.0 
```

#### 4\. 生成 README 文件

这需要在所有安装程序都被下载后进行，但是在 pavement 文件更新为持续开发之前：

```py
$ paver write_release 
```

#### 5\. 将维护分支重置为开发状态（对于预发布版本跳过）

为下一个版本创建发布说明并编辑它们以设置版本。这些说明将是骨架，并且内容很少：

```py
$ cp doc/source/release/template.rst doc/source/release/1.21.1-notes.rst
$ gvim doc/source/release/1.21.1-notes.rst
$ git add doc/source/release/1.21.1-notes.rst 
```

将新版本说明添加到文档发布列表中，并更新 `pavement.py` 中的 `RELEASE_NOTES` 变量：

```py
$ gvim doc/source/release.rst pavement.py 
```

提交结果：

```py
$ git commit -a -m"REL: prepare 1.21.x for further development"
$ git push upstream HEAD 
```

#### 6\. 上传到 PyPI

使用 `twine` 将其上传到 PyPI。最近的 PyPI 更改后需要一个最新版本的 `twine`，这里使用的是版本 `3.4.1`：

```py
$ cd ../numpy
$ twine upload release/installers/*.whl
$ twine upload release/installers/numpy-1.21.0.tar.gz  # Upload last. 
```

如果其中一个命令在中途中断，您可能需要有选择地上传剩余的文件，因为 PyPI 不允许同一文件上传两次。应最后上传源文件以避免同步问题，这可能会导致 pip 用户在此过程中访问文件时出现 pip 从源代码构建而不是下载二进制 wheels。PyPI 仅允许单个源分发，这里我们选择了 zip 归档文件。

#### 7\. 将文件上传到 github

前往 [`github.com/numpy/numpy/releases`](https://github.com/numpy/numpy/releases)，应该有一个 `v1.21.0 tag`，点击它并点击该标签的编辑按钮。有两种方法可以添加文件，使用可编辑的文本窗口和作为二进制上传。首先编辑从 rst 版本使用 pandoc 转换的 `release/README.md`。需要修复的内容：如果包括，来自更改日志的 PR 行将被包装，需要解包，链接应改为等宽文本。然后将内容复制到剪贴板并粘贴到文本窗口中。可能需要多次尝试才能让它看起来正确。然后

+   将 `release/installers/numpy-1.21.0.tar.gz` 上传为二进制文件。

+   将 `release/README.rst` 上传为二进制文件。

+   将 `doc/changelog/1.21.0-changelog.rst` 上传为二进制文件。

+   如果这是一个预发布版本，请勾选预发布按钮。

+   在底部点击`{发布，更新}发布`按钮。

#### 8\. 将文档上传到 numpy.org（对于预发布跳过）

提醒

您将需要一个 GitHub 个人访问令牌来推送更新。

此步骤仅适用于最终发布，对于预发布和大多数补丁发布可以跳过。`make merge-doc`会将 `numpy/doc` 仓库克隆到 `doc/build/merge`，并使用新文档进行更新：

```py
$ git clean -xdfq
$ git co v1.21.0
$ pushd doc
$ make docenv && source docenv/bin/activate
$ make merge-doc
$ pushd build/merge 
```

如果发布系列是新的，您将需要在 `doc/build/merge/index.html` 首页的“insert here”注释下添加一个新部分：

```py
$ gvim index.html +/'insert here' 
```

此外，更新 version-switcher json 文件以添加新版本并更新标记为*(稳定)*的版本：

```py
$ gvim _static/versions.json 
```

否则，只需将`zip`链接更新为新的标签名称。由于我们不再生成`pdf`文件，如果有，删除`pdf`文件的行：

```py
$ gvim index.html +/'tag v1.21' 
```

你可以在浏览器中“测试运行”新文档，以确保链接有效：

```py
$ firefox index.html  # or google-chrome, etc. 
```

更新稳定的链接并更新：

```py
$ ln -sfn 1.21 stable
$ ls -l  # check the link 
```

一切看起来令人满意之后，更新、提交并上传更改：

```py
$ python3 update.py
$ git commit -a -m"Add documentation for v1.21.0"
$ git push
$ deactivate
$ popd
$ popd 
```

#### 9\. 在 numpy.org 上发布发布公告（预发布时跳过）

假设你已经 fork 了[`github.com/numpy/numpy.org`](https://github.com/numpy/numpy.org)：

```py
$ cd ../numpy.org
$ git checkout main
$ git pull upstream main
$ git checkout -b announce-numpy-1.21.0
$ gvim content/en/news.md 
```

+   对于所有发布，转到页面底部添加一个一行链接。查看以前的链接示例。

+   对于循环中的`*.0`发布，向顶部添加一个新的部分，简要描述新功能并将新闻链接指向它。

提交并推送：

```py
$ git commit -a -m"announce the NumPy 1.21.0 release"
$ git push origin HEAD 
```

转到你的 Github 分支并发起一个拉取请求。

#### 10\. 在邮件列表上发布公告

发布应该在 numpy-discussion、scipy-devel、scipy-user 和 python-announce-list 邮件列表上宣布。查看以前的公告获得基本模板。贡献者和 PR 列表与上面的发布说明生成的相同。如果你交叉发布，请确保 python-announce-list 是 BCC，这样答复不会发送到该列表。

#### 11\. 发布后任务（预发布时跳过）

检出 main 并推送文档更改：

```py
$ git checkout -b post-1.21.0-release-update
$ git checkout maintenance/1.21.x doc/source/release/1.21.0-notes.rst
$ git checkout maintenance/1.21.x doc/changelog/1.21.0-changelog.rst
$ git checkout maintenance/1.21.x .mailmap  # only if updated for release.
$ gvim doc/source/release.rst  # Add link to new notes
$ git status  # check status before commit
$ git commit -a -m"MAINT: Update main after 1.21.0 release."
$ git push origin HEAD 
```

转到 GitHub 并发起一个 PR。

#### 12\. 更新 oldest-supported-numpy

如果这个版本是支持新 Python 版本的第一个版本，或者是提供新平台或 PyPy 版本的第一个版本，[`github.com/scipy/oldest-supported-numpy`](https://github.com/scipy/oldest-supported-numpy)中的版本固定应该被更新。要么提交带有`setup.cfg`修改的 PR，要么提出一个需要改变信息的问题。

### 设施准备

在开始发布之前，请使用`*_requirements.txt`文件确保你有所需的软件。大多数软件可以用 pip 安装，但有些需要 apt-get，dnf 或你的系统用于软件的任何内容。你还需要一个 GitHub 个人访问令牌（PAT）来推送文档。有几种方式可以简化事情：

+   可以设置 Git 来使用一个钥匙环来存储你的 GitHub 个人访问令牌。搜索网上的详细信息。

+   你可以使用`keyring`应用程序来存储 twine 的 PyPI 密码。请查看 twine 在线文档获取详细信息。

### 发布准备

#### 添加/删除 Python 版本

在添加或删除 Python 版本时，需要编辑三个文件：

+   .github/workflows/wheels.yml # 用于 github cibuildwheel

+   .travis.yml # 用于 cibuildwheel aarch64 构建

+   setup.py # 用于分类器和最低版本检查。

在主分支上制作这些更改，并且如有必要，则回溯。在提交摘要中使用 *BLD:* 前缀（构建标签）将导致运行 wheel 构建，以便测试更改。我们目前在首个 Python rc 之后发布新 Python 版本的 wheels，一旦 manylinux 和 cibuildwheel 支持它。对于 Python 3.11，我们能够在 rc1 发布后的一周内发布。

#### 回溯 Pull Requests

已标记为此版本的更改必须回溯到 maintenance/1.21.x 分支。

#### 更新发布文档

发布前通常需要更新或创建四个文档：

+   changelog

+   发布说明

+   `.mailmap` 文件

+   `doc/source/release.rst` 文件

这些更改应作为针对 maintenance 分支的普通 PR 进行。发布后，除了 `doc/source/release.rst` 文件外，所有文件都需要向主分支合并。

##### 生成 changelog

changelog 是使用 changelog 工具生成的：

```py
$ python tools/changelog.py $GITHUB v1.20.0..maintenance/1.21.x > doc/changelog/1.21.0-changelog.rst 
```

其中 `GITHUB` 包含您的 GitHub 访问令牌。需要检查文本以查找非标准的贡献者名称，并删除 dependabot 条目。此外，最好删除可能存在于 PR 标题中的任何链接，因为它们在转换为 Markdown 时表现不佳，用等宽文本替换它们。非标准的贡献者名称应通过更新 `.mailmap` 文件来修复，这是很多工作。最好在达到这一点之前进行几次试运行，并使用 GitHub 问题通知违规者获取所需的信息。

##### 完成发布说明

如果这是系列中的第一个发布，将生成发布说明，请参阅 `doc/release/upcoming_changes/README.rst` 中的发布说明，以了解如何做到这一点。生成发布说明还将删除 `doc/release/upcoming_changes/` 中的所有新闻片段文件。

生成的发布说明始终需要一些修复，介绍需要撰写，并且重大更改应该被突出显示。对于补丁发布，changelog 文本也可以被附加，但对于初始发布则不用，因为太长了。查看以前的发布说明，以了解如何做到这一点。请注意，顶部的 `:orphan:` 标记（如果存在）将需要更改为 `.. currentmodule:: numpy`，并且 `doc/source/release.rst` 索引文件将需要更新。

##### 检查 `pavement.py` 文件

检查 pavement.py 文件是否指向正确的发布说明。它应该在上次发布后已被更新，但如果没有，请立即修复：

```py
$ gvim pavement.py 
```

#### 添加/删除 Python 版本

当添加或删除 Python 版本时，需要编辑三个文件：

+   .github/workflows/wheels.yml # 用于 github cibuildwheel

+   .travis.yml # 用于 cibuildwheel aarch64 构建

+   setup.py # 用于分类器和最低版本检查。

在普通 PR 中进行这些更改，并在必要时回溯。在提交摘要中使用*BLD:*前缀（构建标签）将导致运行轮子构建，以便进行测试，我们当前在 Python rc 发布后发布新 Python 版本的轮子，一旦 manylinux 和 cibuildwheel 支持它。对于 Python 3.11，我们能够在 rc1 发布公告后一周内发布。

#### 回溯拉取请求

为本版本标记的更改必须回溯到 maintenance/1.21.x 分支。

#### 更新发行文档

在发布之前通常需要更新或创建四个文档：

+   生成 changelog

+   发行说明

+   `.mailmap`文件

+   `doc/source/release.rst`文件

这些更改应作为普通 PR 针对 maintenance 分支进行。发布后，除`doc/source/release.rst`之外的所有文件都需要被前向移植到 main 分支。

##### 生成 changelog

生成 changelog 使用 changelog 工具：

```py
$ python tools/changelog.py $GITHUB v1.20.0..maintenance/1.21.x > doc/changelog/1.21.0-changelog.rst 
```

`GITHUB`中包含您的 GitHub 访问令牌。需要检查文本中是否存在非标准贡献者名称，并删除 dependabot 条目。删除可能存在于 PR 标题中的任何链接也是个好主意，因为它们在 markdown 中翻译效果不佳，用单间隔文本替换它们。非标准贡献者名称应通过更新`.mailmap`文件来修复，这是一项很多工作。最好在达到这一点之前进行几次试运行，并使用 GitHub 问题 ping 到恶意行为者以获取所需信息。

##### 完成发行说明

如果这是系列中的第一个发布版本，则生成发行说明，请参阅`doc/release/upcoming_changes/README.rst`中的发布说明查看如何完成此操作。生成发行说明也将删除`doc/release/upcoming_changes/`中的所有新闻片段文件。

生成的发行说明总是需要一些修复，需要编写简介，并应指出重大更改。对于补丁版本，changelog 文本也可能被附加，但对于初始发布来说太长了。检查以前的发行说明可以看到这是如何完成的。注意，如果存在顶部的`:orphan:`标记，需要改为`.. currentmodule:: numpy`，并且需要更新`doc/source/release.rst`索引文件。

##### 检查`pavement.py`文件

检查`pavement.py`文件是否指向正确的发行说明。它应该在上次发布后已更新，但如果没有，现在修复它：

```py
$ gvim pavement.py 
```

##### 生成 changelog

生成 changelog 使用 changelog 工具：

```py
$ python tools/changelog.py $GITHUB v1.20.0..maintenance/1.21.x > doc/changelog/1.21.0-changelog.rst 
```

其中 `GITHUB` 包含你的 GitHub 访问令牌。需要检查文本中是否有非标准的贡献者姓名，并删除 dependabot 的条目。此外，还应该删除 PR 标题中可能存在的任何链接，因为它们无法很好地转换为 Markdown，用等宽字体文本替换它们。非标准的贡献者姓名应该通过更新 `.mailmap` 文件进行修复，这是一项很大的工作。最好在达到这一点之前进行几次试验运行，并使用 GitHub issue 提醒犯错误的人获取所需信息。

##### 完成发布说明

如果这是一个系列中的第一个发布，则生成发布说明，参见 `doc/release/upcoming_changes/README.rst` 中的发布说明如何生成。生成发布说明还会删除 `doc/release/upcoming_changes/` 中的所有 news fragment 文件。

生成的发布说明始终需要进行一些修正，需要编写简介，并突出显示重要更改。对于补丁发布，还可以追加更改日志文字，但对于初始发布则不需要，因为它太长了。查看以前的发布说明以了解如何处理。请注意，如果存在顶部的 `:orphan:` 标记，则需要更改为 `.. currentmodule:: numpy`，并且需要更新 `doc/source/release.rst` 索引文件。

##### 检查 `pavement.py` 文件

检查 pavement.py 文件是否指向了正确的发布说明。它应该在上次发布后进行了更新，但如果没有，请立即修复：

```py
$ gvim pavement.py 
```

### 发布步骤

注意，在下面的代码片段中，`upstream` 指的是 GitHub 上的根仓库，`origin` 指的是你个人 GitHub 仓库上的 fork。如果你没有 fork 仓库，而是仅仅在本地克隆了仓库，那么你可能需要进行调整。如果 `.git/config` 中没有 `upstream`，你还可以编辑它并添加上。

#### 1\. 准备发布提交

检出发布的分支，确保它是最新的，并清除仓库：

```py
$ git checkout maintenance/1.21.x
$ git pull upstream maintenance/1.21.x
$ git submodule update
$ git clean -xdfq 
```

完整性检查：

```py
$ python3 -m spin test -m full 
```

给发布打标签并推送标签。这需要对 numpy 仓库有写入权限：

```py
$ git tag -a -s v1.21.0 -m"NumPy 1.21.0 release"
$ git push upstream v1.21.0 
```

如果需要删除由于错误而创建的标签：

```py
$ git tag -d v1.21.0
$ git push --delete upstream v1.21.0 
```

#### 2\. 构建 wheels

##### 通过 cibuildwheel 构建 wheels（首选）

在这个过程开始时给构建打上标签，将会触发通过 cibuildwheel 构建 wheel 并将 wheels 和 sdist 上传到 staging 仓库。通过 github actions 进行的 CI 运行（针对所有基于 x86 的和 macOS 的 arm64 wheels）需要大约 1 1/4 小时。针对 aarch64 的 travis 上的 CI 运行所需时间较短。你可以在[staging 仓库](https://anaconda.org/multibuild-wheels-staging/numpy/files)中检查上传的文件，但请注意它与正在运行的作业的运行情况不是非常同步。

如果希望手动触发构建 wheel，可以这样做：

+   在 github actions -> [Wheel builder](https://github.com/numpy/numpy/actions/workflows/wheels.yml) 中有一个“Run workflow”按钮，点击它并选择要构建的标签

+   在[travis](https://app.travis-ci.com/github/numpy/numpy)上有一个“更多选项”按钮，点击它并选择要构建的分支。看起来没有构建标签的选项。

如果因为与其它原因而导致轮子构建失败，您可以单独重新运行它：

+   在 github actions 中选择[Wheel builder](https://github.com/numpy/numpy/actions/workflows/wheels.yml)，点击包含您想重新运行的构建的提交。左侧有一个轮子构建列表，选择您想要重新运行的构建，在生成的页面上点击逆时针箭头按钮。

+   在[travis](https://app.travis-ci.com/github/numpy/numpy)上选择失败的构建，这将带您到该构建的 travis job。点击重新启动作业按钮。

请注意，如果确实需要重新运行作业，您需要删除 anaconda [分段存储库](https://anaconda.org/multibuild-wheels-staging/numpy/files)中已上传的文件。旧文件不会被覆盖。

#### 3\. 下载 wheels

当所有的 wheels 都已经成功构建并进行了分段处理后，使用`tools/download-wheels.py`脚本从 Anaconda 分段目录下载它们：

```py
$ cd ../numpy
$ mkdir -p release/installers
$ python3 tools/download-wheels.py 1.21.0 
```

#### 4\. 生成 README 文件

这需要在下载所有安装程序之后完成，但在更新 pavement 文件以进行持续开发之前：

```py
$ paver write_release 
```

#### 5\. 将维护分支重置为开发状态（prereleases 可略过）

为下一个发布创建发布说明，并进行编辑以设置版本。这些说明将作为骨架，内容较少：

```py
$ cp doc/source/release/template.rst doc/source/release/1.21.1-notes.rst
$ gvim doc/source/release/1.21.1-notes.rst
$ git add doc/source/release/1.21.1-notes.rst 
```

将新的发布说明添加到文档发布列表中，并更新`pavement.py`中的`RELEASE_NOTES`变量:

```py
$ gvim doc/source/release.rst pavement.py 
```

提交结果：

```py
$ git commit -a -m"REL: prepare 1.21.x for further development"
$ git push upstream HEAD 
```

#### 6\. 上传到 PyPI

使用`twine`上传到 PyPI。最近 PyPI 更改后需要一个最新版本的`twine`，这里使用的是版本`3.4.1`：

```py
$ cd ../numpy
$ twine upload release/installers/*.whl
$ twine upload release/installers/numpy-1.21.0.tar.gz  # Upload last. 
```

如果其中一个命令在中途中断，您可能需要选择性地上传剩余的文件，因为 PyPI 不允许上传相同的文件两次。应该最后上传源文件，以避免同步问题，当 pip 用户在此过程中访问文件时可能发生同步问题，导致 pip 构建源文件而非下载二进制 wheel。PyPI 只允许单个源分发, 在这里我们选择了 zip 归档。

#### 7\. 上传文件到 github

前往[`github.com/numpy/numpy/releases`](https://github.com/numpy/numpy/releases)，应该有一个`v1.21.0 tag`，点击它并点击该标签的编辑按钮。有两种方式可以添加文件，一种是使用可编辑的文本窗口，另一种是使用二进制上传。首先编辑从 rst 版本使用 pandoc 翻译而来的`release/README.md`。需要修复的问题：如果包括，来自修改日志的 PR 行被换行包裹，需要取消换行包裹，链接应改为等宽文本。然后将内容复制到剪贴板，粘贴到文本窗口中。可能需要尝试几次才能让它看起来正确。然后

+   上传`release/installers/numpy-1.21.0.tar.gz`作为二进制文件。

+   上传`release/README.rst`作为二进制文件。

+   上传`doc/changelog/1.21.0-changelog.rst`作为二进制文件。

+   如果这是预发布版本，请选中预发布按钮。

+   点击页面底部的`{Publish,Update} release`按钮。

#### 8\. 将文档上传到 numpy.org（跳过预发布）

注意

你需要一个 GitHub 个人访问令牌来推送更新。

这个步骤只适用于最终发布，对于预发布和大多数补丁发布，可以跳过`make merge-doc`克隆`numpy/doc`存储库到`doc/build/merge`并使用新文档更新它：

```py
$ git clean -xdfq
$ git co v1.21.0
$ pushd doc
$ make docenv && source docenv/bin/activate
$ make merge-doc
$ pushd build/merge 
```

如果发布系列是新的，你需要在“insert here”注释后立即在`doc/build/merge/index.html`首页添加一个新的章节：

```py
$ gvim index.html +/'insert here' 
```

此外，更新版本切换器 json 文件以添加新版本并更新标记为*（stable）*的版本：

```py
$ gvim _static/versions.json 
```

否则，只有`zip`链接应该使用新的标签名称更新。由于我们不再生成`pdf`文件，如果存在的话，删除`pdf`文件的行：

```py
$ gvim index.html +/'tag v1.21' 
```

你可以在浏览器中“测试运行”新文档，确保链接有效：

```py
$ firefox index.html  # or google-chrome, etc. 
```

更新稳定链接和更新：

```py
$ ln -sfn 1.21 stable
$ ls -l  # check the link 
```

一切看起来令人满意后，更新、提交和上传更改：

```py
$ python3 update.py
$ git commit -a -m"Add documentation for v1.21.0"
$ git push
$ deactivate
$ popd
$ popd 
```

#### 9\. 在 numpy.org 上宣布发布（跳过预发布）

这假设您已经 fork 了[`github.com/numpy/numpy.org`](https://github.com/numpy/numpy.org)：

```py
$ cd ../numpy.org
$ git checkout main
$ git pull upstream main
$ git checkout -b announce-numpy-1.21.0
$ gvim content/en/news.md 
```

+   对于所有发布版本，转到页面底部并添加一行链接。看看以前的链接作为例子。

+   对于循环中的`*.0`版本，在顶部添加一个新的章节，并简要介绍新功能，并将新闻链接指向它。

提交并推送：

```py
$ git commit -a -m"announce the NumPy 1.21.0 release"
$ git push origin HEAD 
```

转到你的 Github 分支并创建一个 PR。

#### 10\. 在邮件列表中宣布

发布应该在 numpy-discussion, scipy-devel, scipy-user 和 python-announce-list 邮件列表上宣布。查看以前的公告以获取基本模板。贡献者和 PR 列表与上面生成的发布说明相同。如果交叉发布，请确保 python-announce-list 是 BCC，这样回复将不会发送到该列表。

#### 11\. 发布后任务（跳过预发布）

切换到主分支并向前推送文档更改：

```py
$ git checkout -b post-1.21.0-release-update
$ git checkout maintenance/1.21.x doc/source/release/1.21.0-notes.rst
$ git checkout maintenance/1.21.x doc/changelog/1.21.0-changelog.rst
$ git checkout maintenance/1.21.x .mailmap  # only if updated for release.
$ gvim doc/source/release.rst  # Add link to new notes
$ git status  # check status before commit
$ git commit -a -m"MAINT: Update main after 1.21.0 release."
$ git push origin HEAD 
```

转到 GitHub 并创建 PR。

#### 12\. 更新 oldest-supported-numpy

如果此发布是第一个支持新的 Python 版本，或者第一个为新平台或 PyPy 版本提供 wheels 的版本，应该更新[`github.com/scipy/oldest-supported-numpy`](https://github.com/scipy/oldest-supported-numpy)中的版本设置。要么提交带有`setup.cfg`更改的 PR，要么发布一个包含所需更改信息的问题。

#### 1\. 准备发布提交

切换到发布分支，确保它是最新的，并清理存储库：

```py
$ git checkout maintenance/1.21.x
$ git pull upstream maintenance/1.21.x
$ git submodule update
$ git clean -xdfq 
```

检查：

```py
$ python3 -m spin test -m full 
```

给发布打上标签并推送标签。这需要对 numpy 存储库的写入权限：

```py
$ git tag -a -s v1.21.0 -m"NumPy 1.21.0 release"
$ git push upstream v1.21.0 
```

如果需要因错误删除标签：

```py
$ git tag -d v1.21.0
$ git push --delete upstream v1.21.0 
```

#### 2\. 构建 wheels

##### 通过 cibuildwheel 构建 wheels（首选）

在此过程开始时对构建进行标记将通过 cibuildwheel 触发一个轮子构建，并将轮子和 sdist 上传到暂存仓库。 在 github actions 上进行的 CI 运行（对所有基于 x86 和 macOS 的 arm64 轮子）大约需要 1 1/4 小时。 在 travis 上进行的 CI 运行（对 aarch64）需要更少的时间。 您可以在[暂存存储库](https://anaconda.org/multibuild-wheels-staging/numpy/files)上检查已上传的文件，但请注意它与运行中作业显示的内容不完全同步。

如果您希望手动触发轮子构建，可以执行以下操作：

+   在 github actions -> [Wheel builder](https://github.com/numpy/numpy/actions/workflows/wheels.yml) 上有一个“运行工作流”按钮，点击它并选择要构建的标签。

+   在[travis](https://app.travis-ci.com/github/numpy/numpy) 上有一个“更多选项”按钮，点击它并选择要构建的分支。 似乎没有选项可以构建标签。

如果轮子构建由于不相关原因失败，您可以单独重新运行它：

+   在 github actions 上选择 [Wheel builder](https://github.com/numpy/numpy/actions/workflows/wheels.yml) 点击包含您想要重新运行的构建的提交。 左侧有一个轮子构建的列表，选择您想要重新运行的构建，然后在结果页面上点击逆时针箭头按钮。

+   在[travis](https://app.travis-ci.com/github/numpy/numpy) 上选择失败的构建，这将带您进入该构建的 travis 作业。 大家点击重新运行作业按钮。

请注意，如果您确实需要重新运行作业，您需要删除 anaconda [暂存存储库](https://anaconda.org/multibuild-wheels-staging/numpy/files) 中已上传的文件（如果有）。 旧文件将不会被覆盖。

##### 通过 cibuildwheel 构建轮子（首选）

在此过程开始时对构建进行标记将通过 cibuildwheel 触发一个轮子构建，并将轮子和 sdist 上传到暂存仓库。 在 github actions 上进行的 CI 运行（对所有基于 x86 和 macOS 的 arm64 轮子）大约需要 1 1/4 小时。 在 travis 上进行的 CI 运行（对 aarch64）需要更少的时间。 您可以在[暂存存储库](https://anaconda.org/multibuild-wheels-staging/numpy/files)上检查已上传的文件，但请注意它与运行中作业显示的内容不完全同步。

如果您希望手动触发轮子构建，可以执行以下操作：

+   在 github actions -> [Wheel builder](https://github.com/numpy/numpy/actions/workflows/wheels.yml) 上有一个“运行工作流”按钮，点击它并选择要构建的标签。

+   在[travis](https://app.travis-ci.com/github/numpy/numpy) 上有一个“更多选项”按钮，点击它并选择要构建的分支。 似乎没有选项可以构建标签。

如果轮子构建由于不相关原因失败，您可以单独重新运行它：

+   在 github 动作中选择[Wheel builder](https://github.com/numpy/numpy/actions/workflows/wheels.yml)，点击包含您要重新运行的构建的提交。在左侧有一个轮子构建列表，选择您要重新运行的构建，在生成的页面上点击逆时针箭头按钮。

+   在[travis](https://app.travis-ci.com/github/numpy/numpy)上选择失败的构建，这将带您到该构建的 travis 作业。点击重新开始作业按钮。

注意，如果需要重新运行作业，您需要删除在 anaconda 的[存储库](https://anaconda.org/multibuild-wheels-staging/numpy/files)中上传的任何文件。旧文件将不会被覆盖。

#### 3\. 下载轮子

当所有轮子都成功构建并暂存时，使用`tools/download-wheels.py`脚本从 Anaconda 暂存目录下载它们：

```py
$ cd ../numpy
$ mkdir -p release/installers
$ python3 tools/download-wheels.py 1.21.0 
```

#### 4\. 生成 README 文件

这需要在下载所有安装程序之后完成，但在更新 pavement 文件以继续开发之前完成：

```py
$ paver write_release 
```

#### 5\. 将维护分支重置为开发状态（预发布跳过）

为下一个发布创建发布说明，并编辑以设置版本。这些说明将是一个骨架，并且内容很少：

```py
$ cp doc/source/release/template.rst doc/source/release/1.21.1-notes.rst
$ gvim doc/source/release/1.21.1-notes.rst
$ git add doc/source/release/1.21.1-notes.rst 
```

添加新发布说明到文档发布列表中，并更新`pavement.py`中的`RELEASE_NOTES`变量：

```py
$ gvim doc/source/release.rst pavement.py 
```

提交结果：

```py
$ git commit -a -m"REL: prepare 1.21.x for further development"
$ git push upstream HEAD 
```

#### 6\. 上传到 PyPI

使用`twine`上传到 PyPI。由于 PyPI 最近的更改，需要使用最新版本的`twine`，此处使用的版本是`3.4.1`：

```py
$ cd ../numpy
$ twine upload release/installers/*.whl
$ twine upload release/installers/numpy-1.21.0.tar.gz  # Upload last. 
```

如果其中一个命令在中间中断，您可能需要选择性地上传剩余的文件，因为 PyPI 不允许相同的文件上传两次。为了避免同步问题，最后应该上传源文件，即使 pip 用户在此过程中访问文件，也不会引起从源代码构建而不是下载二进制轮子。PyPI 只允许单个源分发，我们选择了 zip 存档。

#### 7\. 将文件上传到 github

转到[`github.com/numpy/numpy/releases`](https://github.com/numpy/numpy/releases)，那里应该有一个`v1.21.0 tag`，点击它并点击该标签的编辑按钮。有两种方法可以添加文件，一种是使用可编辑的文本窗口，另一种是使用二进制上传。首先编辑从 rst 版本使用 pandoc 翻译的`release/README.md`。需要修复的问题：如果包括 PR 行，则需要调整，链接应更改为等宽文本。然后复制内容到剪贴板，并粘贴到文本窗口中。可能需要多次尝试才能让它看起来正确。然后

+   以二进制文件上传`release/installers/numpy-1.21.0.tar.gz`。

+   以二进制文件上传`release/README.rst`。

+   以二进制文件上传`doc/changelog/1.21.0-changelog.rst`。

+   如果这是一个预发布版本，请勾选预发布按钮。

+   在底部点击`{发布，更新}发布`按钮。

#### 8\. 将文档上传到 numpy.org（预发布跳过）

注意

您将需要 GitHub 个人访问令牌来推送更新。

此步骤仅适用于最终发布，并可跳过预发布和大多数补丁发布。 `make merge-doc` 将 `numpy/doc` 存储库克隆到 `doc/build/merge` 并使用新文档更新它：

```py
$ git clean -xdfq
$ git co v1.21.0
$ pushd doc
$ make docenv && source docenv/bin/activate
$ make merge-doc
$ pushd build/merge 
```

如果发布系列是新的，则需要在 `doc/build/merge/index.html` 首页的“在此处插入”注释后添加新的部分：

```py
$ gvim index.html +/'insert here' 
```

此外，更新版本切换器 json 文件以添加新版本并更新标记为 *(稳定)* 的版本：

```py
$ gvim _static/versions.json 
```

否则，仅应使用新的标记名称更新 `zip` 链接。由于我们不再生成 `pdf` 文件，如果存在，删除 `pdf` 文件的行：

```py
$ gvim index.html +/'tag v1.21' 
```

您可以在浏览器中“测试运行”新文档，以确保链接正常：

```py
$ firefox index.html  # or google-chrome, etc. 
```

更新稳定链接并更新：

```py
$ ln -sfn 1.21 stable
$ ls -l  # check the link 
```

一切看起来令人满意后，更新、提交并上传更改：

```py
$ python3 update.py
$ git commit -a -m"Add documentation for v1.21.0"
$ git push
$ deactivate
$ popd
$ popd 
```

#### 9\. 在 numpy.org 上宣布发布（跳过预发布）

这假设您已经派生了 [`github.com/numpy/numpy.org`](https://github.com/numpy/numpy.org)：

```py
$ cd ../numpy.org
$ git checkout main
$ git pull upstream main
$ git checkout -b announce-numpy-1.21.0
$ gvim content/en/news.md 
```

+   对于所有发布版本，请转到页面底部并添加一行链接。参考以前的链接示例。

+   对于循环中的 `*.0` 发布，在顶部添加一个新特性的简短描述并将新闻链接指向它。

提交并推送：

```py
$ git commit -a -m"announce the NumPy 1.21.0 release"
$ git push origin HEAD 
```

前往您的 Github 派生版本并提出拉取请求。

#### 10\. 在邮件列表上宣布

发布应该在 numpy-discussion、scipy-devel、scipy-user 和 python-announce-list 邮件列表上宣布。查看以前的公告以获取基本模板。贡献者和 PR 列表与上述发布说明生成的相同。如果跨帖，请确保 python-announce-list 是密件抄送，以便回复不会发送到该列表。

#### 11\. 发布后任务（对于预发布，请跳过）

检出主分支并将文档更改向前移植：

```py
$ git checkout -b post-1.21.0-release-update
$ git checkout maintenance/1.21.x doc/source/release/1.21.0-notes.rst
$ git checkout maintenance/1.21.x doc/changelog/1.21.0-changelog.rst
$ git checkout maintenance/1.21.x .mailmap  # only if updated for release.
$ gvim doc/source/release.rst  # Add link to new notes
$ git status  # check status before commit
$ git commit -a -m"MAINT: Update main after 1.21.0 release."
$ git push origin HEAD 
```

前往 GitHub 并创建一个 PR。

#### 12\. 更新 oldest-supported-numpy

如果此版本是第一个支持新的 Python 版本，或者第一个为新平台或 PyPy 版本提供 wheels，那么[`github.com/scipy/oldest-supported-numpy`](https://github.com/scipy/oldest-supported-numpy)中的版本固定应该更新。要么提交对那里的 `setup.cfg` 的更改的 PR，要么在需要更改的信息上开启一个问题。

## 分支演示

本指南包含在 Linux 上分支 NumPy 1.21.x 的步骤。可以将命令复制到命令行中，但一定要将 1.21 和 1.22 替换为正确的版本。在制作分支之前，尽可能使 `.mailmap` 最新，这可能需要几周时间。

这应与通用发布指南一起阅读。

### 分支

#### 制作分支

仅在启动新的维护分支时才需要。因为 NumPy 现在依赖于标签来确定版本，所以在主分支中启动新的开发周期需要一个带注释的标签。操作如下：

```py
$ git checkout main
$ git pull upstream main
$ git commit --allow-empty -m'REL: Begin NumPy 1.22.0 development'
$ git push upstream HEAD 
```

如果推送失败，因为新的 PR 已经合并，执行以下操作：

```py
$ git pull --rebase upstream 
```

并重复推送。一旦推送成功，对其进行标记：

```py
$ git tag -a -s v1.22.0.dev0 -m'Begin NumPy 1.22.0 development'
$ git push upstream v1.22.0.dev0 
```

然后创建新分支并推送它：

```py
$ git branch maintenance/1.21.x HEAD^
$ git push upstream maintenance/1.21.x 
```

#### 为主分支做进一步的开发准备

创建一个 PR 分支来为主分支做进一步的开发准备：

```py
$ git checkout -b 'prepare-main-for-1.22.0-development' v1.22.0.dev0 
```

删除发布注释片段：

```py
$ git rm doc/release/upcoming_changes/[0-9]*.*.rst 
```

创建新的发布注释框架并添加到索引中：

```py
$ cp doc/source/release/template.rst doc/source/release/1.22.0-notes.rst
$ gvim doc/source/release/1.22.0-notes.rst  # put the correct version
$ git add doc/source/release/1.22.0-notes.rst
$ gvim doc/source/release.rst  # add new notes to notes index
$ git add doc/source/release.rst 
```

更新`pavement.py`，并将`RELEASE_NOTES`变量更新为指向新的注释：

```py
$ gvim pavement.py
$ git add pavement.py 
```

更新`cversions.txt`以添加当前发布。在这个早期阶段不用担心新的哈希，只需按照以前的惯例添加注释即可：

```py
$ gvim numpy/core/code_generators/cversions.txt
$ git add numpy/core/code_generators/cversions.txt 
```

检查你的工作，提交并推送：

```py
$ git status  # check work
$ git commit -m'REL: Prepare main for NumPy 1.22.0 development'
$ git push origin HEAD 
```

现在创建一个拉取请求。

### 分支

#### 创建分支

仅在启动新的维护分支时需要这样做。因为 NumPy 现在依赖标签来确定版本，所以在主分支中开始新的开发周期需要有一个带注释的标签。操作如下：

```py
$ git checkout main
$ git pull upstream main
$ git commit --allow-empty -m'REL: Begin NumPy 1.22.0 development'
$ git push upstream HEAD 
```

如果推送失败，因为新的 PR 已经合并，执行以下操作：

```py
$ git pull --rebase upstream 
```

并重复推送。一旦推送成功，对其进行标记：

```py
$ git tag -a -s v1.22.0.dev0 -m'Begin NumPy 1.22.0 development'
$ git push upstream v1.22.0.dev0 
```

然后创建新分支并推送：

```py
$ git branch maintenance/1.21.x HEAD^
$ git push upstream maintenance/1.21.x 
```

#### 为主分支做进一步的开发准备

创建一个 PR 分支来为主分支做进一步的开发准备：

```py
$ git checkout -b 'prepare-main-for-1.22.0-development' v1.22.0.dev0 
```

删除发布注释片段：

```py
$ git rm doc/release/upcoming_changes/[0-9]*.*.rst 
```

创建新的发布注释框架并添加到索引中：

```py
$ cp doc/source/release/template.rst doc/source/release/1.22.0-notes.rst
$ gvim doc/source/release/1.22.0-notes.rst  # put the correct version
$ git add doc/source/release/1.22.0-notes.rst
$ gvim doc/source/release.rst  # add new notes to notes index
$ git add doc/source/release.rst 
```

更新`pavement.py`，并将`RELEASE_NOTES`变量更新为指向新的注释：

```py
$ gvim pavement.py
$ git add pavement.py 
```

更新`cversions.txt`以添加当前发布。在这个早期阶段不用担心新的哈希，只需按照以前的惯例添加注释即可：

```py
$ gvim numpy/core/code_generators/cversions.txt
$ git add numpy/core/code_generators/cversions.txt 
```

检查你的工作，提交并推送：

```py
$ git status  # check work
$ git commit -m'REL: Prepare main for NumPy 1.22.0 development'
$ git push origin HEAD 
```

现在创建一个拉取请求。

#### 创建分支

仅在启动新的维护分支时需要这样做。因为 NumPy 现在依赖标签来确定版本，所以在主分支中开始新的开发周期需要有一个带注释的标签。操作如下：

```py
$ git checkout main
$ git pull upstream main
$ git commit --allow-empty -m'REL: Begin NumPy 1.22.0 development'
$ git push upstream HEAD 
```

如果推送失败，因为新的 PR 已经合并，执行以下操作：

```py
$ git pull --rebase upstream 
```

并重复推送。一旦推送成功，对其进行标记：

```py
$ git tag -a -s v1.22.0.dev0 -m'Begin NumPy 1.22.0 development'
$ git push upstream v1.22.0.dev0 
```

然后创建新分支并推送它：

```py
$ git branch maintenance/1.21.x HEAD^
$ git push upstream maintenance/1.21.x 
```

#### 为主分支做进一步的开发准备

创建一个 PR 分支来为主分支做进一步的开发准备：

```py
$ git checkout -b 'prepare-main-for-1.22.0-development' v1.22.0.dev0 
```

删除发布注释片段：

```py
$ git rm doc/release/upcoming_changes/[0-9]*.*.rst 
```

创建新的发布注释框架并添加到索引中：

```py
$ cp doc/source/release/template.rst doc/source/release/1.22.0-notes.rst
$ gvim doc/source/release/1.22.0-notes.rst  # put the correct version
$ git add doc/source/release/1.22.0-notes.rst
$ gvim doc/source/release.rst  # add new notes to notes index
$ git add doc/source/release.rst 
```

更新`pavement.py`，并将`RELEASE_NOTES`变量更新为指向新的注释：

```py
$ gvim pavement.py
$ git add pavement.py 
```

更新`cversions.txt`以添加当前发布。在这个早期阶段不用担心新的哈希，只需按照以前的惯例添加注释即可：

```py
$ gvim numpy/core/code_generators/cversions.txt
$ git add numpy/core/code_generators/cversions.txt 
```

检查你的工作，提交并推送：

```py
$ git status  # check work
$ git commit -m'REL: Prepare main for NumPy 1.22.0 development'
$ git push origin HEAD 
```

现在创建一个拉取请求。
