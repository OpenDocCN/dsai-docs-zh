# 广义通用函数 API

> 原文：[`numpy.org/doc/1.26/reference/c-api/generalized-ufuncs.html`](https://numpy.org/doc/1.26/reference/c-api/generalized-ufuncs.html)

不仅需要在标量函数上循环，还需要在向量（或数组）函数上循环。这个概念在 NumPy 中通过对通用函数（ufuncs）进行泛化来实现。在常规的 ufuncs 中，基本函数被限制为逐元素操作，而广义版本（gufuncs）支持“子数组”按“子数组”操作。Perl 矢量库 PDL 提供类似的功能，在下文中重新使用其术语。

每个广义通用函数都有与之相关的信息，说明输入的“核心”维度是什么，以及相应的输出维度（逐元素 ufunc 的核心维度为零）。所有参数的核心维度列表称为 ufunc 的“签名”。例如，ufunc numpy.add 签名为`(),()->()`，定义了两个标量输入和一个标量输出。

另一个示例是函数`inner1d(a, b)`，签名为`(i),(i)->()`。这将沿着每个输入的最后一个轴应用内积，但保持其余索引不变。例如，当`a`的形状为`(3, 5, N)`，`b`的形状为`(5, N)`时，这将返回形状为`(3,5)`的输出。基础的基本功能被调用`3 * 5`次。在签名中，我们为每个输入指定一个核心维度`(i)`，并为输出指定零个核心维度`()`，因为它需要两个 1-d 数组并返回一个标量。通过使用相同的名称`i`，我们指定两个对应的维度应该是相同大小。

超出核心尺寸的维度被称为“循环”维度。在上面的示例中，这对应于`(3, 5)`。

签名确定每个输入/输出数组的维度如何分割为核心和循环维度：

1.  在签名中，每个维度与相应传入数组的维度匹配，从形状元组的末尾开始。这些是核心维度，它们必须存在于数组中，否则会引发错误。

1.  在签名中分配给相同标签的核心维度（例如`inner1d`中的`(i),(i)->()`中的`i`）必须具有完全匹配的大小，不执行广播。

1.  所有输入中去除核心维度，剩余维度进行广播，定义循环维度。

1.  每个输出的形状取决于循环维度加上输出的核心维度

通常情况下，输出中所有核心维度的大小将由输入数组中具有相同标签的核心维度的大小决定。这不是必须的，也可以定义一个签名，其中一个标签在输出中首次出现，尽管在调用这样的函数时必须采取一些预防措施。一个例子是函数`euclidean_pdist(a)`，其签名为`(n,d)->(p)`，给定一个包含`n`个`d`维向量的数组，计算它们之间所有唯一的成对欧几里德距离。因此，输出维度`p`必须等于`n * (n - 1) / 2`，但调用者有责任传入正确大小的输出数组。如果无法从传入的输入或输出数组确定输出的核心维度的大小，则会引发错误。

注意：在 NumPy 1.10.0 之前，存在较少严格的检查：缺少的核心维度会根据需要在形状前添加 1，具有相同标签的核心维度会一起广播，并且未确定的维度将创建为大小为 1 的维度。

## 定义

基本函数

每个 ufunc 由一个基本函数组成，该函数在数组参数的最小部分上执行最基本的操作（例如，将两个数字相加是将两个数组相加的最基本操作）。ufunc 在数组的不同部分上多次应用基本函数。基本函数的输入/输出可以是向量；例如，inner1d 的基本函数将两个向量作为输入。

签名

签名是描述 ufunc 基本函数的输入/输出维度的字符串。有关更多详细信息，请参阅下面的部分。

核心维度

每个基本函数的输入/输出的维度由其核心维度定义（零核心维度对应于标量输入/输出）。核心维度映射到输入/输出数组的最后维度。

维度名称

维度名称表示签名中的核心维度。不同的维度可以共享一个名称，表示它们具有相同的大小。

维度索引

维度索引是表示维度名称的整数。它根据签名中每个名称的第一次出现的顺序对维度名称进行枚举。

## 签名详细信息

签名定义了输入和输出变量的“核心”维度，从而也定义了维度的收缩。签名由以下格式的字符串表示：

+   每个输入或输出数组的核心维度由括号中的维度名称列表`(i_1,...,i_N)`表示；标量输入/输出用`()`表示。可以使用任何有效的 Python 变量名，而不是`i_1`，`i_2`等。

+   不同参数的维度列表由`","`分隔。输入/输出参数由`"->"`分隔。

+   如果在多个位置使用相同的维度名称，则强制相应维度的相同大小。

签名的正式语法如下：

```py
<Signature>            ::= <Input arguments> "->" <Output arguments>
<Input arguments>      ::= <Argument list>
<Output arguments>     ::= <Argument list>
<Argument list>        ::= nil | <Argument> | <Argument> "," <Argument list>
<Argument>             ::= "(" <Core dimension list> ")"
<Core dimension list>  ::= nil | <Core dimension> |
                           <Core dimension> "," <Core dimension list>
<Core dimension>       ::= <Dimension name> <Dimension modifier>
<Dimension name>       ::= valid Python variable name | valid integer
<Dimension modifier>   ::= nil | "?" 
```

注意：

1.  所有引用都是为了清晰。

1.  未修改的共享相同名称的核心维度必须具有相同的大小。每个维度名称通常对应基本函数实现中的一个循环级别。

1.  空格将被忽略。

1.  数字作为维度名称将冻结该维度为该值。

1.  如果名称后缀带有“?”修饰符，则该维度仅在所有输入和输出共享该维度时才是核心维度；否则将被忽略（并由元素函数的大小为 1 的维度替换）。

下面是一些签名的示例：

| name | signature | 常见用法 |
| --- | --- | --- |
| add | `(),()->()` | 二进制 ufunc |
| sum1d | `(i)->()` | 减少 |
| inner1d | `(i),(i)->()` | 向量-向量乘法 |
| matmat | `(m,n),(n,p)->(m,p)` | 矩阵乘法 |
| vecmat | `(n),(n,p)->(p)` | 向量-矩阵乘法 |
| matvec | `(m,n),(n)->(m)` | 矩阵-向量乘法 |
| matmul | `(m?,n),(n,p?)->(m?,p?)` | 上述四种的组合 |
| outer_inner | `(i,t),(j,t)->(i,j)` | 最后一个维度内积，倒数第二个维度外积，并循环/广播其他维度 |
| cross1d | `(3),(3)->(3)` | 叉积，其中最后一个维度被冻结并且必须为 3 |

最后一个是冻结核心维度的实例，并可用于改善 ufunc 性能

## 用于实现基本函数的 C-API

当前接口保持不变，`PyUFunc_FromFuncAndData`仍可用于实现（专门化的）ufunc，包括标量基本函数。

人们可以使用`PyUFunc_FromFuncAndDataAndSignature`声明更通用的 ufunc。参数列表与`PyUFunc_FromFuncAndData`相同，还有一个额外的参数指定签名为 C 字符串。

此外，回调函数的类型与以前相同，`void (*foo)(char **args, intp *dimensions, intp *steps, void *func)`。调用时，`args`是一个长度为`nargs`的列表，其中包含所有输入/输出参数的数据。对于标量基本函数，`steps`也是长度为`nargs`，表示参数的步进。`dimensions`是一个指向定义要循环的轴的大小的单个整数的指针。

对于非平凡签名，`dimensions`还将包含核心维度的大小，从第二个条目开始。对于每个惟一的维度名称，仅提供一个大小，并且大小根据签名中维度名称的第一次出现给出。

`nargs`的前几个元素与标量 ufunc 相同。接下来的元素包含按顺序所有参数的所有核心维度的步进。

例如，考虑一个签名为`(i,j),(i)->()`的 ufunc。在这种情况下，`args`将包含对输入/输出数组`a`、`b`、`c`的数据的三个指针。此外，`dimensions`将为`[N, I, J]`，以定义循环的大小`N`和核心维度`i`和`j`的大小`I`和`J`。最后，`steps`将为`[a_N, b_N, c_N, a_i, a_j, b_i]`，包含所有必要的步幅。

## 定义

基本函数

每个 ufunc 由一个执行最基本操作的基本函数组成，该操作在最小的数组部分上执行（例如，将两个数字相加是在两个数组上添加的最基本操作）。ufunc 将基本函数多次应用于数组的不同部分。基本函数的输入/输出可以是向量；例如，inner1d 的基本函数以两个向量作为输入。

签名

签名是描述 ufunc 的基本函数的输入/输出维度的字符串。有关详细信息，请参见下面的部分。

核心维度

基本函数的每个输入/输出的维度由其核心维度定义（零个核心维度对应于标量输入/输出）。核心维度映射到输入/输出数组的最后维度。

维度名称

维度名称表示签名中的核心维度。不同的维度可以共享一个名称，表示它们具有相同的大小。

维度索引

维度索引是表示维度名称的整数。它根据签名中每个名称的第一次出现的顺序列举维度名称。

## 签名的详细信息

签名定义了输入和输出变量的“核心”维度，并因此定义维度的合并。签名由以下格式的字符串表示：

+   每个输入或输出数组的核心维度由括号内的维度名称列表`(i_1,...,i_N)`表示；标量输入/输出用`()`表示。可以使用任何有效的 Python 变量名称代替`i_1`、`i_2`等。

+   不同参数的维度列表由逗号`","`分隔。输入/输出参数由箭头`"->"`分隔。

+   如果在多个位置使用相同的维度名称，这将强制相应维度的相同大小。

签名的形式语法如下：

```py
<Signature>            ::= <Input arguments> "->" <Output arguments>
<Input arguments>      ::= <Argument list>
<Output arguments>     ::= <Argument list>
<Argument list>        ::= nil | <Argument> | <Argument> "," <Argument list>
<Argument>             ::= "(" <Core dimension list> ")"
<Core dimension list>  ::= nil | <Core dimension> |
                           <Core dimension> "," <Core dimension list>
<Core dimension>       ::= <Dimension name> <Dimension modifier>
<Dimension name>       ::= valid Python variable name | valid integer
<Dimension modifier>   ::= nil | "?" 
```

注：

1.  所有引用只是为了清晰起见。

1.  具有相同名称的未修改的核心维度必须具有相同的大小。每个维度名称通常对应于基本函数实现中的一个循环级别。

1.  空格将被忽略。

1.  作为维度名称的整数会将该维度冻结为特定的值。

1.  如果名称后缀有“？”修饰符，则该维度仅在存在于共享它的所有输入和输出上时才是核心维度；否则，它会被忽略（并用一个具有大小为 1 的维度替换基本函数）。

下面是一些签名的示例：

| name | signature | common usage |
| --- | --- | --- |
| add | `(),()->()` | 二元 ufunc。 |
| sum1d | `(i)->()` | 归约。 |
| inner1d | `(i),(i)->()` | 向量-向量乘法。 |
| matmat | `(m,n),(n,p)->(m,p)` | 矩阵乘法。 |
| vecmat | `(n),(n,p)->(p)` | 向量-矩阵乘法。 |
| matvec | `(m,n),(n)->(m)` | 矩阵-向量乘法。 |
| matmul | `(m?,n),(n,p?)->(m?,p?)` | 以上四种的组合。 |
| outer_inner | `(i,t),(j,t)->(i,j)` | 最后一个维度内积，倒数第二个维度外积，并在其余维度上进行循环/广播。 |
| cross1d | `(3),(3)->(3)` | 交叉积，其中最后一个维度是固定的，必须为 3。 |

最后一个示例是一个核心维度的冻结实例，可用于提高 ufunc 的性能。

## 用于实现基本函数的 C-API。

当前接口保持不变，仍然可以使用`PyUFunc_FromFuncAndData`来实现（专用的）ufunc，由标量基本函数组成。

可以使用`PyUFunc_FromFuncAndDataAndSignature`来声明更通用的 ufunc。参数列表与`PyUFunc_FromFuncAndData`相同，额外增加了一个参数来指定 C 字符串形式的签名。

此外，回调函数的类型与之前相同，即`void (*foo)(char **args, intp *dimensions, intp *steps, void *func)`。调用时，`args`是一个长度为`nargs`的列表，包含所有输入/输出参数的数据。对于标量基本函数，`steps`的长度也是`nargs`，表示用于参数的步幅。`dimensions`是一个指向定义要循环的轴大小的单个整数的指针。

对于非平凡的签名，`dimensions`还将包含核心维度的大小，从第二个条目开始。对于每个唯一的维度名称，只提供一个大小，并且根据签名中维度名称的首次出现给出大小。

`steps`的前 `nargs` 元素与标量 ufunc 相同。接下来的元素按顺序包含所有参数的所有核心维度的步幅。

例如，考虑一个带有签名`(i,j),(i)->()`的 ufunc。在这种情况下，`args`将包含指向输入/输出数组 `a`、`b`、`c` 数据的三个指针。此外，`dimensions`将是`[N, I, J]`，定义了循环的大小 `N` 和核心维度 `i` 和 `j` 的大小 `I` 和 `J`。最后，`steps`将是`[a_N, b_N, c_N, a_i, a_j, b_i]`，包含所有必要的步幅。
